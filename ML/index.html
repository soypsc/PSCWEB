<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Panama Shipping Co. - Buscar Mal Identificados</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap">
  <style>
    /* Estilos del layout principal (originales) */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #fff;
      color: #000;
      line-height: 1.6;
    }
    a { text-decoration: none; color: inherit; }
    header {
      background: linear-gradient(135deg, #2325d4, #1a1cb3);
      color: white;
      position: relative;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
      height: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 25px;
    }
    .header-inner {
      max-width: 1200px;
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logo {
      height: 180px;
      display: flex;
      align-items: center;
    }
    .logo img {
      max-height: 225px;
      width: auto;
      object-fit: contain;
      user-select: none;
      pointer-events: none;
    }
    nav {
      display: flex;
      gap: 20px;
      align-items: center;
      flex-wrap: wrap;
    }
    nav a {
      color: white;
      font-weight: 500;
      font-size: 14px;
      position: relative;
      transition: color 0.3s ease;
    }
    nav a:hover { color: #ffec00; }
    nav a::after {
      content: "";
      position: absolute;
      left: 0;
      bottom: -3px;
      width: 0%;
      height: 2px;
      background: #ffec00;
      transition: 0.3s;
    }
    nav a:hover::after { width: 100%; }
    .header-buttons {
      display: flex;
      gap: 10px;
    }
    .btn-header {
      background: #ffec00;
      color: #2325d4;
      padding: 6px 14px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 13px;
      transition: background 0.3s;
    }
    .btn-header:hover { background: #e6d800; }
    .onda {
      position: absolute;
      bottom: -20px;
      left: 0;
      width: 100%;
      height: 40px;
      background: url('data:image/svg+xml;utf8,<svg width="100%" height="40" viewBox="0 0 1440 40" xmlns="http://www.w3.org/2000/svg"><path fill="%23fff" d="M0 20 Q360 40 720 20 T1440 20 V40 H0 Z"/></svg>') no-repeat bottom;
      background-size: cover;
    }
    .menu-toggle {
      display: none;
      font-size: 26px;
      cursor: pointer;
      color: white;
    }
    @media (max-width: 900px) {
      nav {
        display: none;
        flex-direction: column;
        width: 100%;
        background: #2325d4;
        padding: 10px 0;
      }
      nav.show { display: flex; }
      .header-buttons { display: none; }
      .menu-toggle { display: block; }
    }
    /* Sección central (se adapta al contenido del formulario, sin border o min-height fijo del layout original) */
    .content {
      max-width: 1200px;
      margin: 50px auto;
      padding: 20px;
      /* Eliminados: border, min-height, text-align para que el .wrap del formulario tome el control */
    }

    /* Footer */
    footer {
      background: #fff;
      color: #000;
      padding: 30px 20px;
      margin-top: 40px;
    }
    .footer-container {
      max-width: 1200px;
      margin: auto;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
    }
    .footer-col h3 {
      font-size: 18px;
      margin-bottom: 8px;
      color: #2325d4;
    }
    .footer-col p, .footer-col a {
      font-size: 13px;
      color: #333;
    }
    .footer-col a:hover { color: #2325d4; }
    .social-icons { display: flex; flex-direction: column; gap: 6px; }
    .footer-bottom {
      text-align: center;
      margin-top: 20px;
      font-size: 11px;
      color: #555;
      border-top: 1px solid rgba(0,0,0,0.1);
      padding-top: 10px;
    }
    .footer-links {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 5px;
    }
    .footer-links a {
      color: #2325d4;
      font-size: 11px;
    }
    /* WhatsApp flotante */
    .whatsapp-float {
      position: fixed;
      bottom: 15px;
      right: 15px;
      z-index: 999;
    }
    .whatsapp-float img {
      width: 45px;
      height: 45px;
      border-radius: 50%;
    }

    /* Dropdown */
    .dropdown {
      position: relative;
      display: inline-block;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      background-color: #2325d4;
      min-width: 200px;
      box-shadow: 0px 8px 16px rgba(0,0,0,0.2);
      z-index: 1;
    }

    .dropdown-content a {
      color: white;
      padding: 10px 16px;
      display: block;
      font-size: 14px;
    }

    .dropdown-content a:hover {
      background-color: #1a1cb3;
      color: #ffec00;
    }

    .dropdown:hover .dropdown-content {
      display: block;
    }

    /* Estilos del módulo "Buscar Mal Identificados" (fusionados y ajustados) */
    /* Se han mantenido las variables CSS originales para los colores y tamaños específicos del módulo */
    :root {
      --fg: #111;
      --bg: #fafafa; /* Nota: body.background-color prevalece si no se anula explícitamente en .wrap */
      --muted: #6b7280;
      --accent: #2325d4; /* Usando el color principal de tu sitio para botones primarios */
      --ok: #16a34a;
      --err: #ff0000;
      --warn: #ff0000;
      --card: #fff;
      --border: #e5e7eb;
    }
    .wrap {
      width: 100%;
      max-width: 720px; /* Se ajusta dentro del .content de 1200px */
      margin: 0 auto; /* Centra el wrap dentro del content */
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.06);
      padding: 20px;
    }
    h1 {
      margin: 0 0 6px;
      text-align: center;
      font-size: 28px;
      font-weight: 800;
      letter-spacing: 0.2px;
    }
    .subtitle {
      margin: 0 0 18px;
      text-align: center;
      color: var(--muted);
    }
    label {
      display: block;
      font-size: 14px;
      color: var(--muted);
      margin: 8px 0 6px;
    }
    input[type="text"] {
      width: 100%;
      padding: 12px 14px;
      border: 1px solid var(--border);
      border-radius: 12px;
      background: #fff;
      font-size: 16px;
    }
    .row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    button {
      border: 0;
      border-radius: 12px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
    }
    .btn-primary {
      background: var(--accent); /* Usando el --accent de tu sitio */
      color: #fff;
    }
    .btn-ghost {
      background: #f3f4f6;
      color: #111;
      border: 1px solid var(--border);
    }
    .btn-primary:disabled,
    .btn-ghost:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .status {
      margin-top: 10px;
      font-size: 14px;
      color: var(--muted);
    }
    .status.ok {
      color: var(--ok);
    }
    .status.err {
      color: var(--err);
    }
    .status.warn {
      color: var(--warn);
    }
    pre {
      background: #2325d4; /* Usando el azul de tu header para el fondo del output */
      color: #e5e7eb;
      border-radius: 12px;
      padding: 14px;
      white-space: pre-wrap;
      word-break: break-word;
      margin-top: 12px;
      min-height: 44px;
    }
    .divider {
      height: 1px;
      background: var(--border);
      margin: 16px 0;
    }
    .question {
      margin-top: 14px;
    }
    .choices {
      display: flex;
      gap: 10px;
      margin-top: 6px;
    }
    .choice {
      display: inline-flex;
      gap: 8px;
      align-items: center;
      border: 1px solid var(--border);
      padding: 8px 10px;
      border-radius: 10px;
      cursor: pointer;
      background: #fff;
    }
    .choice input {
      accent-color: #2325d4; /* Usando el azul de tu sitio para los radio buttons */
    }
    .hint {
      margin-top: 8px;
      color: var(--warn);
      font-size: 14px;
      display: none;
    }
    .form {
      margin-top: 14px;
      display: none;
    }
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 160px;
      gap: 8px;
    }
    .form .note {
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }
    .toast {
      margin-top: 10px;
      font-size: 14px;
    }
    .toast.ok {
      color: var(--ok);
    }
    .toast.err {
      color: var(--err);
    }
    .toast.warn {
      color: var(--warn);
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header>
    <div class="header-inner">
      <div class="logo">
        <img src="https://static.wixstatic.com/media/f7f5e1_8e6b42f370a3408ea4c305089fadc49c~mv2.png" alt="Logo" >
      </div>
      <div class="menu-toggle" onclick="document.querySelector('nav').classList.toggle('show')">☰</div>
      <nav>
        <a href="file:///C:/Users/soyps/Desktop/web%20psc%20inicio.html">Inicio</a>
        <a href="file:///C:/Users/soyps/Desktop/pag%20rastredor.html">Rastreador de Paquetes</a>
        <a href="file:///C:/Users/soyps/Desktop/cotizar%20compra.html">Cotiza tus Compras</a>
        <a href="file:///C:/Users/soyps/Desktop/solicitar%20ML.html">Solicitar ML</a>
        
        <!-- Menú desplegable -->
        <div class="dropdown">
          <a href="#">Más ▾</a>
          <div class="dropdown-content">
            <a href="file:///C:/Users/soyps/Desktop/Mercancia%20Peligrosa.html">Mercancía Peligrosa</a>
            <a href="file:///C:/Users/soyps/Desktop/Terminos&condiciones.html">Términos y Condiciones</a>
          </div>
        </div>
      </nav>
      <div class="header-buttons">
        <a href="https://psc.e-rmez.com/zonacliente/" class="btn-header">Zona de Clientes</a>
        <a href="https://psc.e-rmez.com/casillero_register.php" class="btn-header">Regístrate</a>
      </div>
    </div>
    <div class="onda"></div>
  </header>

  <!-- SECCIÓN CENTRAL (Aquí se integra el código de "Buscar Mal Identificados") -->
  <main class="content">
    <div class="wrap">
      <h1>Buscar Mal Identificados</h1>
      <p class="subtitle">Ingrese Tracking</p>

      <!-- Paso 1: búsqueda -->
      <label for="trk">Tracking</label>
      <input
        id="trk"
        type="text"
        placeholder="Ej: UUS57S2565569158307"
        autocomplete="off"
      />
      <div class="row">
        <button id="go" class="btn-primary">Buscar</button>
        <button id="clear" class="btn-ghost">Limpiar</button>
      </div>
      <div id="status" class="status"></div>
      <pre id="out"></pre>

      <div class="divider"></div>

      <!-- Paso 2: confirmación y solicitud -->
      <div class="question">
        <label>¿Mostró Fecha de ingreso CB, saco o Parrafo con fecha? Marque, *SI*</label>
        <label>-Lo mas probable que su paquete este Mal Identificado</label>
        <div class="choices">
          <label class="choice"
            ><input type="radio" name="seen" value="si" />
            <span>Sí</span></label
          >
          <label class="choice"
            ><input type="radio" name="seen" value="no" />
            <span>No</span></label
          >
        </div>
        <div id="noMsg" class="hint">
          Si no sale información intente Buscar nuevamente o Contactarse con PSC.
        </div>
      </div>

      <div class="form" id="mlForm">
        <label for="cas">N.º de casillero (obligatorio)</label>
        <div class="form-grid">
          <input id="cas" type="text" placeholder="Ej: 12345" />
          <button id="ask" class="btn-primary">Solicitar ML</button>
        </div>
        <div class="note">
          <!-- Aquí puedes añadir una nota o instrucción adicional para el usuario -->
        </div>
        <div id="msg" class="toast"></div>
      </div>
    </div>
  </main>

  <!-- FOOTER -->
  <footer>
    <div class="footer-container">
      <div class="footer-col">
        <h3>Contacto</h3>
        <p>Asistencia personalizada</p>
        <div class="social-icons">
          <a href="#">📸 Instagram</a>
          <a href="tel:+50767906781">📞 +507 67906781</a>
          <a href="mailto:info@soypsc.com">✉️ info@soypsc.com</a>
          <a href="#">💬 WhatsApp</a>
        </div>
      </div>
      <div class="footer-col">
        <h3>Enlaces Rápidos</h3>
        <a href="#">Términos y Condiciones</a><br>
        <a href="#">Mercancía Restringida</a>
      </div>
      <div class="footer-col">
        <h3>Sobre Nosotros</h3>
        <p>Panama Shipping Co. facilita tus compras en línea y envíos a Panamá con rapidez y seguridad.</p>
      </div>
    </div>
    <div class="footer-bottom">
      &copy; 2023 Panama Shipping Co. Todos los derechos reservados.
      <div class="footer-links">
        <a href="#">Términos</a>
        <a href="#">Privacidad</a>
      </div>
    </div>
  </footer>

  <!-- WHATSAPP -->
<a href="https://api.whatsapp.com/send?phone=50767906781&text=Hola%20quiero%20mas%20informacion" 
   class="whatsapp-float" target="_blank" rel="noopener">
  <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/WhatsApp_icon.png" alt="WhatsApp" />
</a>

  <script>
    // Script para menú responsivo toggle
    document.querySelector('.menu-toggle').addEventListener('click', () => {
      document.querySelector('nav').classList.toggle('show');
    });

    // JavaScript del módulo "Buscar Mal Identificados" (original, fusionado aquí)
    (function () {
      // --- Endpoints ---
      const SCRAPER_DEFAULT =
        "https://gel-scraper-proxy.onrender.com/api/gel";
      const SCRAPER = location.hostname.includes(
          "gel-scraper-proxy.onrender.com"
        )
          ? "/api/gel"
          : SCRAPER_DEFAULT;

      const CHECK_URL =
        "https://ztdkaxbgpogudtrdgzic.functions.supabase.co/check-ml";
      const PUT_URL =
        "https://ztdkaxbgpogudtrdgzic.functions.supabase.co/put-tracking";

      // --- DOM ---
      const $ = (s) => document.querySelector(s);
      const trk = $("#trk");
      const go = $("#go");
      const clr = $("#clear");
      const status = $("#status");
      const out = $("#out");

      const seenRadios = document.getElementsByName("seen");
      const noMsg = $("#noMsg");
      const form = $("#mlForm");
      const cas = $("#cas");
      const ask = $("#ask");
      const toast = $("#msg");

      // --- Filtro de texto fijo (si llegamos a usar snippet de error) ---
      const FILTER_STRINGS = [
        // pega aquí bloques de texto CONSTANTE de la web original para ocultar del snippet
        `Login BUSCAR PAQUETES SIN IDENTIFICAR Número de Rastreo "Tracking" CLEAR SACO FECHA DE INGRESO SACO FECHA DE INGRESO Displaying 1 - 1 of 1 CÓMO RECLAMAR UN PAQUETE SIN IDENTIFICAR Sin Resultado En Búsqueda Reclamar Paquete Encontrado. RECLAMO DE PAQUETE Una vez compruebe que su paquete está mal identificado llene los campos con la información requerida No. de Casillero* No. Tracking a reclamar* Es Saco o CB* CB Saco Ninguno No. de Saco o CB* Sólo Número de SACO o CB con fecha más reciente Su Email de contacto* Agregar Nota: (opcional)`,
      ];
      function cleanText(str) {
        if (!str) return "";
        let t = String(str);
        for (const block of FILTER_STRINGS) {
          if (block && block.trim()) {
            t = t.split(block).join("");
            const norm = (s) => s.replace(/\s+/g, " ").trim();
            const tb = norm(block);
            const re = new RegExp(
              tb.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"),
              "g"
            );
            t = norm(t).replace(re, "");
          }
        }
        return t
          .replace(/[ \t]+\n/g, "\n")
          .replace(/\n{3,}/g, "\n\n")
          .trim();
      }
      function extractSnippetFromError(errMsg) {
        if (!errMsg) return "";
        const i = errMsg.indexOf("Snippet:");
        return i >= 0 ? errMsg.slice(i + "Snippet:".length).trim() : "";
      }

      // --- Estados UI ---
      let tickerTimer = null;
      let searchAbort = null;
      const submittedSet = new Set(); // evita doble envío en esta sesión

      function setStatus(msg, kind = "") {
        status.textContent = msg || "";
        status.className = "status" + (kind ? " " + kind : "");
      }
      function setToast(msg, kind = "") {
        toast.textContent = msg || "";
        toast.className = "toast" + (kind ? " " + kind : "");
      }

      function startTicker() {
        let elapsed = 0,
          showAlt = false;
        stopTicker();
        tickerTimer = setInterval(() => {
          elapsed += 5;
          showAlt = !showAlt;
          setStatus(
            showAlt ? "Estamos buscando tu Paquete…" : "Buscando…",
            "warn"
          );
          if (elapsed >= 45) stopTicker();
        }, 5000);
      }
      function stopTicker() {
        if (tickerTimer) {
          clearInterval(tickerTimer);
          tickerTimer = null;
        }
      }

      function resetAll() {
        trk.value = "";
        out.textContent = "";
        setStatus("");
        setToast("");
        noMsg.style.display = "none";
        form.style.display = "none";
        cas.value = "";
        for (const r of seenRadios) {
          r.checked = false;
        }
        go.disabled = false;
        ask.disabled = false;
        stopTicker();
        if (searchAbort) {
          searchAbort.abort();
          searchAbort = null;
        }
      }

      // --- Paso 1: Buscar ---
      async function buscar() {
        const t = trk.value.trim();
        setToast("");
        if (!t) {
          setStatus("", "");
          out.textContent = "";
          return;
        }

        go.disabled = true;
        setStatus("Buscando…", "warn");
        startTicker();

        // timeout 45s
        searchAbort = new AbortController();
        const tt = setTimeout(() => searchAbort.abort(), 45000);

        try {
          const r = await fetch(
            `${SCRAPER}?tracking=${encodeURIComponent(t)}`,
            { cache: "no-store", signal: searchAbort.signal }
          );
          clearTimeout(tt);
          stopTicker();

          let data = null,
            raw = "";
          try {
            data = await r.json();
          } catch {
            raw = await r.text();
          }

          if (r.ok && data && data.ok) {
            const has = data.saco || data.fecha_de_ingreso;
            if (has) {
              // mostramos limpio; por confiabilidad dejamos "FECHA DE INGRESO" si viene
              const resp = [data.saco || "", data.fecha_de_ingreso || ""]
                .filter(Boolean)
                .join("\n")
                .trim();
              out.textContent = resp || "No encontrado";
            } else {
              out.textContent = "No encontrado";
            }
            setStatus(has ? "Listo" : "No encontrado", has ? "ok" : "err");
          } else {
            const errMsg = data && data.error ? String(data.error) : raw;
            const snippet = cleanText(extractSnippetFromError(errMsg));
            if (snippet) {
              out.textContent = snippet;
              setStatus("Listo", "ok");
            } else {
              out.textContent = "No encontrado";
              setStatus("No encontrado", "err");
            }
          }
        } catch (e) {
          clearTimeout(tt);
          stopTicker();
          out.textContent = "No encontrado";
          setStatus("No encontrado", "err");
        } finally {
          go.disabled = false;
          searchAbort = null;
        }
      }

      // --- Lógica pregunta Sí/No ---
      function onSeenChange() {
        const v = Array.from(seenRadios).find((r) => r.checked)?.value || "";
        if (v === "no") {
          noMsg.style.display = "block";
          form.style.display = "none";
          setToast("");
        } else if (v === "si") {
          noMsg.style.display = "none";
          form.style.display = "block";
          cas.focus();
        } else {
          noMsg.style.display = "none";
          form.style.display = "none";
        }
      }

      // --- check-ml antes de insertar ---
      async function checkDuplicate(code) {
        const t = (code || "").trim();
        if (!t) return { exists: false, ml: false };

        // si ya lo solicitamos en esta sesión, bloquea
        if (submittedSet.has(t.toLowerCase())) {
          return { exists: true, ml: true };
        }

        const ctrl = new AbortController();
        const timeout = setTimeout(() => ctrl.abort(), 8000);
        try {
          const res = await fetch(CHECK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ trackings: [t] }),
            signal: ctrl.signal,
          });
          clearTimeout(timeout);
          if (!res.ok) return { exists: false, ml: false };
          const payload = await res.json().catch(() => ({}));
          const it = Array.isArray(payload?.items)
            ? payload.items.find(
                (x) =>
                  String(x.tracking || "").toLowerCase() === t.toLowerCase()
              )
            : null;
          const ml =
            it && (it.ml === true || it.ML === "true" || it.status === "ML");
          const exists = Boolean(it && (it.exists === true || ml));
          return { exists, ml: Boolean(ml) };
        } catch {
          clearTimeout(timeout);
          return { exists: false, ml: false };
        }
      }

      // --- Enviar solicitud ML ---
      async function solicitarML() {
        const code = trk.value.trim();
        const casillero = cas.value.trim();
        setToast("");

        // Validaciones
        const seen =
          Array.from(seenRadios).find((r) => r.checked)?.value || "";
        if (seen !== "si") {
          setToast(
            "Confirma que se mostró la información (elige 'Sí').",
            "warn"
          );
          return;
        }
        if (!code || !casillero) {
          setToast("Ingresa tracking y número de casillero.", "err");
          return;
        }

        ask.disabled = true;

        // 1) Verificar duplicado
        setToast("Verificando…", "warn");
        const dup = await checkDuplicate(code);
        if (dup.ml) {
          // solo bloquea si ya fue solicitado ML
          setToast("Tracking ya fue Solicitado.", "warn");
          ask.disabled = false;
          return;
        }

        // 2) Insertar solicitud
        try {
          setToast("Enviando solicitud…", "warn");
          const res = await fetch(PUT_URL, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              tracking_original: code,
              tracking_corrected: code, // mismo valor si no corriges
              num_casillero: casillero,
              status: "ML",
              ML: "true",
            }),
          });
          const txt = await res.text().catch(() => "");
          let payload = {};
          try {
            payload = JSON.parse(txt || "{}");
          } catch {}

          if (!res.ok || payload?.ok !== true) {
            const msg =
              payload?.error ||
              payload?.detail ||
              res.statusText ||
              `HTTP ${res.status}`;
            setToast(`Error: ${msg}`, "err");
            ask.disabled = false;
            return;
          }

          // OK
          setToast("Solicitud recibida", "ok");
          submittedSet.add(code.toLowerCase());
          // Opcional: deshabilitar definitivo o limpiar casillero
          // ask.disabled = true;
          // cas.value = "";
        } catch (e) {
          setToast(`Error de red: ${e?.message || e}`, "err");
          ask.disabled = false;
        }
      }

      // --- Wire up ---
      go.addEventListener("click", buscar);
      trk.addEventListener("keydown", (e) => {
        if (e.key === "Enter") buscar();
      });
      clr.addEventListener("click", resetAll);

      for (const r of seenRadios) {
        r.addEventListener("change", onSeenChange);
      }
      ask.addEventListener("click", solicitarML);
    })();
  </script>
</body>
</html>
