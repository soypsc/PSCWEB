<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Paquetes - PSC App</title>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="config.js"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        .spinner { border-color: #4b5563; border-top-color: #60a5fa; animation: spin 1s linear infinite; border-radius: 50%;}
        @keyframes spin{ to{transform:rotate(360deg)} }
        .package-checkbox-selected { background-color: #4f46e5; border-color: #818cf8; }
        .package-checkbox-selected i { opacity: 1; }
    </style>
</head>
<body>
    <div class="max-w-md mx-auto min-h-screen">
        <header class="p-6 flex items-center space-x-4">
            <a href="index.html" class="text-slate-400"><i data-lucide="arrow-left" class="h-6 w-6"></i></a>
            <h1 class="text-xl font-bold text-white">Mis Paquetes</h1>
        </header>
        <main class="px-6 pb-24 space-y-6">
            <section class="space-y-4">
                <div class="bg-green-500/10 border border-green-500/50 p-4 rounded-xl text-center">
                    <p class="text-sm font-semibold text-green-300">EN SUCURSAL</p>
                    <div class="flex items-baseline justify-center space-x-3 mt-1">
                        <span id="summary-sucursal" class="text-3xl font-bold text-white">0</span><span>Paquetes</span>
                    </div>
                    <p id="summary-saldo" class="text-lg font-semibold text-green-300 font-mono mt-1">$0.00</p>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div class="bg-slate-800 border border-slate-700 p-4 rounded-xl text-center">
                        <p class="text-xs font-medium text-yellow-300">EN TRÁNSITO</p>
                        <p id="summary-transito" class="text-2xl font-bold text-white mt-1">0</p>
                    </div>
                    <div class="bg-slate-800 border border-slate-700 p-4 rounded-xl text-center">
                        <p class="text-xs font-medium text-slate-400">ENTREGADOS</p>
                        <p id="summary-entregado" class="text-2xl font-bold text-white mt-1">0</p>
                    </div>
                </div>
            </section>
            <section class="space-y-4">
                <div class="bg-slate-800 border border-slate-700 p-4 rounded-xl text-center">
                    <p class="text-sm font-semibold text-green-400">SALDO DISPONIBLE EN BILLETERA</p>
                    <p id="saldo-billetera-paquetes" class="text-3xl font-bold text-white font-mono mt-1">$0.00</p>
                </div>
                <div id="payment-summary-paquetes" class="hidden mt-6 space-y-4">
                    <div class="bg-slate-800/50 p-4 rounded-xl">
                        <h3 class="text-base font-semibold text-white mb-3">Resumen de Pago</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between"><span class="text-slate-400">Costo de paquetes:</span><span id="summary-packages-cost-paquetes" class="font-mono text-white">$0.00</span></div>
                            <div class="flex justify-between"><span class="text-slate-400">Servicio Pick & Go:</span><span class="font-mono text-white">$1.00</span></div>
                            <hr class="border-slate-700 my-2">
                            <div class="flex justify-between font-bold text-base"><span class="text-white">Total a Pagar:</span><span id="summary-total-cost-paquetes" class="font-mono text-indigo-400">$0.00</span></div>
                        </div>
                    </div>
                    <button id="pay-button-paquetes" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-indigo-700 disabled:bg-slate-500">
                        Pagar con Saldo y Generar QR
                    </button>
                </div>
            </section>
            <section>
                <h2 class="text-lg font-semibold text-white mb-3">Historial de Paquetes</h2>
                <div id="paquetes-list-container" class="space-y-4">
                    <div class="text-center p-8"><div class="spinner w-8 h-8 mx-auto"></div></div>
                </div>
            </section>
        </main>
    </div>

    <div id="qr-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white w-full max-w-sm rounded-2xl shadow-xl text-center p-6">
            <h2 class="text-xl font-bold text-slate-800 mb-2">¡Pago Exitoso!</h2>
            <p class="text-slate-600 mb-4">Muestra este código QR para retirar tus paquetes.</p>
            <div id="qrcode-modal" class="flex justify-center items-center"></div>
            <p id="retiro-id-modal" class="font-mono text-xs text-slate-500 mt-4"></p>
            <button id="close-qr-modal-btn" class="mt-6 w-full bg-slate-200 text-slate-700 font-semibold py-2 px-4 rounded-md hover:bg-slate-300">Cerrar</button>
        </div>
    </div>

    <script type="module">
        const { createClient } = supabase;
        const supabaseClient = createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);

        let currentUserProfile = null;
        let allUserPackages = [];
        let selectedPackageIds = [];
        const PICKGO_COST = 1.00;

        // --- Package & Payment Logic ---
        const loadPaquetes = async () => {
            const container = document.getElementById('paquetes-list-container');
            container.innerHTML = `<div class="text-center p-8"><div class="spinner w-8 h-8 mx-auto"></div></div>`;
            document.getElementById('saldo-billetera-paquetes').textContent = `$${(currentUserProfile.saldo_a_favor || 0).toFixed(2)}`;

            const { data: paquetes, error } = await supabaseClient.from('paquetes').select('*').eq('cliente_box', currentUserProfile.box).order('created_at', { ascending: false });
            
            if (error) {
                 container.innerHTML = `<p class="text-red-500 text-center">Error al cargar paquetes.</p>`;
                 return;
            }
            allUserPackages = paquetes;
            selectedPackageIds = [];
            
            const tarifaCliente = currentUserProfile?.tarifa_1 || 4.00;
            let statusCount = { 'En transito': 0, 'En Sucursal': 0, 'Entregado': 0, 'Pagado (sin entregar)': 0 };
            let saldoEnSucursal = 0;
            if (paquetes) {
                paquetes.forEach(p => {
                    if (p.status in statusCount) statusCount[p.status]++;
                    if (p.status === 'En Sucursal') saldoEnSucursal += (p.peso || 0) * tarifaCliente;
                });
            }
            document.getElementById('summary-transito').textContent = statusCount['En transito'];
            document.getElementById('summary-sucursal').textContent = statusCount['En Sucursal'];
            document.getElementById('summary-entregado').textContent = statusCount['Entregado'] + statusCount['Pagado (sin entregar)'];
            document.getElementById('summary-saldo').textContent = `$${saldoEnSucursal.toFixed(2)}`;

            renderPaquetes(tarifaCliente);
            updatePaymentSummary();
        };

        function renderPaquetes(tarifaCliente) {
            const container = document.getElementById('paquetes-list-container');
            if (!allUserPackages || allUserPackages.length === 0) {
                container.innerHTML = `<div class="text-center p-8"><i data-lucide="package-search" class="h-16 w-16 text-slate-600 mx-auto"></i><p class="mt-4 text-slate-400">No tienes paquetes.</p></div>`;
                lucide.createIcons();
                return;
            }

            const statusBadge = (s) => ({ 'En transito': 'bg-yellow-500/20 text-yellow-300', 'En Sucursal': 'bg-green-500/20 text-green-300', 'Pagado (sin entregar)': 'bg-blue-500/20 text-blue-300', 'Entregado': 'bg-slate-500/20 text-slate-400' }[s] || 'bg-slate-700');
            
            container.innerHTML = allUserPackages.map(p => {
                const isSelectable = p.status === 'En Sucursal';
                const costoCalculado = (p.peso || 0) * tarifaCliente;

                return `
                <div class="package-item bg-slate-800 border border-slate-700 p-4 rounded-xl flex justify-between items-center ${isSelectable ? 'cursor-pointer' : 'opacity-60'}" data-id="${p.id}" data-cost="${costoCalculado}">
                    <div class="flex items-center gap-4 min-w-0">
                        ${isSelectable ? `
                            <div class="package-checkbox pointer-events-none h-6 w-6 rounded-full border-2 border-slate-500 bg-slate-900 flex items-center justify-center flex-shrink-0">
                                <i data-lucide="check" class="h-4 w-4 text-white opacity-0 transition"></i>
                            </div>` : `<div class="h-6 w-6 flex-shrink-0"></div>`}
                        <div class="min-w-0">
                            <p class="font-mono font-semibold text-white text-sm truncate">${p.tracking}</p>
                            <p class="text-xs text-slate-400">${p.peso ? p.peso.toFixed(2) + ' lbs' : 'Sin peso'}</p>
                        </div>
                    </div>
                    <div class="text-right flex items-center gap-4 flex-shrink-0">
                        <p class="text-white font-semibold font-mono text-lg">$${costoCalculado.toFixed(2)}</p>
                        <span class="text-xs font-bold px-2 py-1 rounded-full ${statusBadge(p.status)}">${p.status || 'N/A'}</span>
                    </div>
                </div>`;
            }).join('');
            lucide.createIcons();
        }
        
        function handlePackageSelection(e) {
            const packageItem = e.target.closest('.package-item');
            if (!packageItem || packageItem.classList.contains('opacity-60')) return;

            const packageId = packageItem.dataset.id;
            const checkbox = packageItem.querySelector('.package-checkbox');
            const index = selectedPackageIds.indexOf(packageId);

            if (index > -1) {
                selectedPackageIds.splice(index, 1);
                checkbox.classList.remove('package-checkbox-selected');
            } else {
                selectedPackageIds.push(packageId);
                checkbox.classList.add('package-checkbox-selected');
            }
            updatePaymentSummary();
        }

        function updatePaymentSummary() {
            const paymentSummaryEl = document.getElementById('payment-summary-paquetes');
            if (selectedPackageIds.length === 0) {
                paymentSummaryEl.classList.add('hidden');
                return;
            }

            const selectedPackages = allUserPackages.filter(p => selectedPackageIds.includes(String(p.id)));
            const packagesCost = selectedPackages.reduce((sum, p) => sum + ((p.peso || 0) * (currentUserProfile?.tarifa_1 || 4.00)), 0);
            const totalCost = packagesCost + PICKGO_COST;

            document.getElementById('summary-packages-cost-paquetes').textContent = `$${packagesCost.toFixed(2)}`;
            document.getElementById('summary-total-cost-paquetes').textContent = `$${totalCost.toFixed(2)}`;
            
            const payButton = document.getElementById('pay-button-paquetes');
            payButton.disabled = currentUserProfile.saldo_a_favor < totalCost;
            paymentSummaryEl.classList.remove('hidden');
        }

        async function handlePayment() {
            const payButton = document.getElementById('pay-button-paquetes');
            payButton.disabled = true;
            payButton.textContent = 'Procesando...';

            try {
                const { data: resultado, error } = await supabaseClient.rpc('pagar_paquetes_con_saldo', {
                    p_paquetes_a_pagar: selectedPackageIds,
                    p_es_pick_and_go: true 
                });

                if (error) throw error;
                
                showQrModal(resultado);
                const { data: updatedProfile } = await supabaseClient.from('clientes').select('saldo_a_favor').eq('id', currentUserProfile.id).single();
                if(updatedProfile) currentUserProfile.saldo_a_favor = updatedProfile.saldo_a_favor;

                await loadPaquetes();
                
            } catch (error) {
                alert(`Error en el pago: ${error.message}`);
            } finally {
                payButton.disabled = false;
                payButton.textContent = 'Pagar con Saldo y Generar QR';
            }
        }
        
        function showQrModal(retiroId) {
            const qrModal = document.getElementById('qr-modal');
            const qrCodeEl = document.getElementById('qrcode-modal');
            qrCodeEl.innerHTML = '';
            const typeNumber = 4;
            const errorCorrectionLevel = 'L';
            const qr = qrcode(typeNumber, errorCorrectionLevel);
            qr.addData(retiroId);
            qr.make();
            qrCodeEl.innerHTML = qr.createImgTag(6, 8);
            document.getElementById('retiro-id-modal').textContent = `ID de Retiro: ${retiroId}`;
            qrModal.classList.remove('hidden');
        }
        
        async function initializePage() {
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                if (session?.user) {
                    const { data, error } = await supabaseClient
                        .from('clientes')
                        .select('id, nombre, box, saldo_a_favor, tarifa_1')
                        .eq('user_id', session.user.id)
                        .single();

                    if (data) {
                        currentUserProfile = data;
                        loadPaquetes();
                    } else {
                        document.getElementById('paquetes-list-container').innerHTML = `<p class="text-red-500 text-center">No se pudo cargar el perfil del usuario.</p>`;
                    }
                } else {
                    // Si no hay sesión, redirigir al login
                    window.location.href = 'index.html';
                }
            });
        }

        // --- Event Listeners Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            initializePage();
            lucide.createIcons();
            document.getElementById('paquetes-list-container').addEventListener('click', handlePackageSelection);
            document.getElementById('pay-button-paquetes').addEventListener('click', handlePayment);
            document.getElementById('close-qr-modal-btn').addEventListener('click', () => document.getElementById('qr-modal').classList.add('hidden'));
        });
    </script>
</body>
</html>

