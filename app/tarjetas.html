<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recargas - PSC App</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="config.js"></script>

    <style>
        body { 
            font-family: 'Inter', sans-serif;
            background-color: #0f172a;
            color: #e2e8f0;
        }
        .plan-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .plan-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.2), 0 4px 6px -4px rgba(99, 102, 241, 0.2);
        }
    </style>
</head>
<body>

    <div class="max-w-md mx-auto min-h-screen">
        <header class="p-6 flex items-center space-x-4">
            <a href="index.html" class="text-slate-400 hover:text-white transition">
                <i data-lucide="arrow-left" class="h-6 w-6"></i>
            </a>
            <h1 class="text-xl font-bold text-white">Planes de Recarga</h1>
        </header>

        <main class="px-6 pb-24 space-y-12">
            <!-- Sección de Planes de Libras -->
            <section>
                <h2 class="text-2xl font-bold text-white mb-4">Compra de Libras</h2>
                <div class="grid grid-cols-2 gap-4">
                    <!-- Plan 20 lbs -->
                    <div class="plan-card bg-slate-800 border border-slate-700 rounded-2xl overflow-hidden text-center">
                        <div class="bg-indigo-600 text-white p-2 font-bold flex justify-between items-center text-sm">
                            <i data-lucide="zap" class="h-4 w-4"></i>
                            <span>$55</span>
                        </div>
                        <div class="p-4">
                            <p class="text-3xl font-extrabold text-white">20 <span class="text-lg font-bold text-slate-400">lbs</span></p>
                            <p class="text-xs bg-green-500/10 text-green-400 font-semibold rounded-full px-2 py-0.5 mt-2 inline-block">Ahorra $4.00</p>
                            <button class="recarga-btn w-full mt-4 bg-indigo-500 text-white font-semibold py-2 rounded-lg hover:bg-indigo-600"
                                data-type="libras" data-libras="20" data-costo="55">
                                Recargar
                            </button>
                        </div>
                    </div>
                     <!-- Plan 30 lbs -->
                    <div class="plan-card bg-slate-800 border border-slate-700 rounded-2xl overflow-hidden text-center">
                        <div class="bg-indigo-600 text-white p-2 font-bold flex justify-between items-center text-sm">
                            <i data-lucide="zap" class="h-4 w-4"></i>
                            <span>$75</span>
                        </div>
                        <div class="p-4">
                            <p class="text-3xl font-extrabold text-white">30 <span class="text-lg font-bold text-slate-400">lbs</span></p>
                            <p class="text-xs bg-green-500/10 text-green-400 font-semibold rounded-full px-2 py-0.5 mt-2 inline-block">Ahorra $13.50</p>
                            <button class="recarga-btn w-full mt-4 bg-indigo-500 text-white font-semibold py-2 rounded-lg hover:bg-indigo-600"
                                data-type="libras" data-libras="30" data-costo="75">
                                Recargar
                            </button>
                        </div>
                    </div>
                    <!-- Agrega más planes si es necesario -->
                </div>
            </section>

            <!-- Sección de Recarga de Billetera -->
            <section>
                 <h2 class="text-2xl font-bold text-white mb-4">Recarga tu Billetera</h2>
                 <div class="bg-slate-800 border border-slate-700 p-6 rounded-2xl">
                    <p class="text-sm text-slate-400 mb-4">Recarga saldo y obtén un bono. El saldo se añadirá a tu cuenta como "saldo a favor".</p>
                    <div>
                        <label for="monto-recarga" class="text-sm font-medium text-slate-400">Monto a Recargar (USD)</label>
                        <input type="number" id="monto-recarga" placeholder="Ej: 20" class="w-full mt-1 p-3 bg-slate-900 border border-slate-600 rounded-lg text-white">
                    </div>
                    <div class="mt-4 text-center bg-slate-900/50 p-4 rounded-lg">
                        <p class="text-sm text-slate-400">Recibirás un total de:</p>
                        <p class="text-3xl font-extrabold text-green-400" id="total-recibido">$0.00</p>
                        <p class="text-xs font-semibold text-green-500" id="bono-info">¡+ $0.00 de bono!</p>
                    </div>
                    <button id="recarga-wallet-btn" class="recarga-btn w-full mt-6 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700"
                        data-type="wallet" disabled>
                        Recargar Billetera
                    </button>
                 </div>
            </section>
        </main>
    </div>

    <!-- Modal de Pago -->
    <div id="payment-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-slate-800 border border-slate-700 w-full max-w-sm rounded-2xl shadow-xl p-6 text-center">
            <h2 class="text-xl font-bold text-white">Confirmar Recarga</h2>
            <p class="text-slate-400 mt-2">Vas a recargar <strong id="modal-recarga-info" class="text-white"></strong>.</p>
            <p class="text-4xl font-extrabold text-indigo-400 my-4" id="modal-costo-info">$0.00</p>
            
            <div class="space-y-3">
                <button id="pay-with-rayitos-btn" class="w-full bg-amber-500 text-white font-semibold py-3 rounded-lg hover:bg-amber-600 disabled:bg-slate-600 disabled:opacity-50">
                    Pagar con <span id="rayitos-costo"></span> Rayitos
                </button>
                <button id="pay-with-cash-btn" class="w-full bg-slate-600 text-white font-semibold py-3 rounded-lg hover:bg-slate-700">
                    Pagar en Efectivo (vía WhatsApp)
                </button>
            </div>
            <button id="close-modal-btn" class="mt-6 text-slate-400 text-sm hover:text-white">Cancelar</button>
        </div>
    </div>
    
    <!-- Modal de Éxito -->
    <div id="success-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 hidden z-50">
         <div class="bg-slate-800 border border-slate-700 w-full max-w-sm rounded-2xl shadow-xl p-6 text-center">
            <div class="mx-auto bg-green-500/10 h-16 w-16 flex items-center justify-center rounded-full">
                <i data-lucide="check" class="h-10 w-10 text-green-500"></i>
            </div>
            <h2 class="text-xl font-bold text-white mt-4">¡Solicitud Enviada!</h2>
            <p class="text-slate-400 mt-2">Por favor, contacta a nuestro WhatsApp con el siguiente código para completar tu pago:</p>
            <p class="my-4 p-3 bg-slate-900 border border-dashed border-slate-600 rounded-lg text-2xl font-bold text-white tracking-widest" id="request-code"></p>
            <a href="https://wa.me/TUNUMERODEWHATSAPP" target="_blank" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 inline-block">Contactar por WhatsApp</a>
            <button id="close-success-modal-btn" class="mt-4 text-slate-400 text-sm hover:text-white">Cerrar</button>
        </div>
    </div>


    <script type="module">
        const { createClient } = supabase;
        const supabaseClient = createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);

        const montoRecargaInput = document.getElementById('monto-recarga');
        const totalRecibidoEl = document.getElementById('total-recibido');
        const bonoInfoEl = document.getElementById('bono-info');
        const recargaWalletBtn = document.getElementById('recarga-wallet-btn');

        const paymentModal = document.getElementById('payment-modal');
        const successModal = document.getElementById('success-modal');
        const requestCodeEl = document.getElementById('request-code');

        const modalRecargaInfo = document.getElementById('modal-recarga-info');
        const modalCostoInfo = document.getElementById('modal-costo-info');
        const payWithRayitosBtn = document.getElementById('pay-with-rayitos-btn');
        const rayitosCostoEl = document.getElementById('rayitos-costo');
        
        let recargaSeleccionada = null;
        let saldoRayitosCliente = 0;

        // --- Lógica de la Calculadora ---
        function calcularBonus(monto) {
            if (monto >= 100) return monto * 0.20; // 20%
            if (monto >= 50) return monto * 0.15; // 15%
            if (monto >= 20) return monto * 0.125; // 12.5%
            return 0;
        }

        montoRecargaInput.addEventListener('input', () => {
            const monto = parseFloat(montoRecargaInput.value) || 0;
            const bono = calcularBonus(monto);
            const total = monto + bono;

            totalRecibidoEl.textContent = `$${total.toFixed(2)}`;
            bonoInfoEl.textContent = `¡+ $${bono.toFixed(2)} de bono!`;
            
            if (monto > 0) {
                recargaWalletBtn.disabled = false;
                recargaWalletBtn.dataset.costo = monto;
                recargaWalletBtn.dataset.bono = bono;
            } else {
                recargaWalletBtn.disabled = true;
            }
        });

        // --- Lógica de Modales y Pago ---
        async function handleRecarga(e) {
            const button = e.target.closest('.recarga-btn');
            if (!button) return;

            const type = button.dataset.type;
            const costo = parseFloat(button.dataset.costo);

            if (type === 'libras') {
                recargaSeleccionada = {
                    type: 'libras',
                    libras: parseInt(button.dataset.libras),
                    costo: costo
                };
                modalRecargaInfo.textContent = `${recargaSeleccionada.libras} lbs`;
            } else if (type === 'wallet') {
                 recargaSeleccionada = {
                    type: 'wallet',
                    monto: costo,
                    bono: parseFloat(button.dataset.bono),
                    costo: costo
                };
                modalRecargaInfo.textContent = `Billetera con $${recargaSeleccionada.monto}`;
            }
            
            modalCostoInfo.textContent = `$${costo.toFixed(2)}`;
            const costoEnRayitos = costo * 100;
            rayitosCostoEl.textContent = costoEnRayitos.toFixed(0);
            
            payWithRayitosBtn.disabled = saldoRayitosCliente < costoEnRayitos;
            
            paymentModal.classList.remove('hidden');
        }
        
        async function procesarSolicitud(metodoPago) {
            paymentModal.classList.add('hidden');
            
            try {
                const { data: codigo, error } = await supabaseClient.rpc('solicitar_recarga', {
                    p_tipo_recarga: recargaSeleccionada.type,
                    p_recarga_data: recargaSeleccionada,
                    p_metodo_pago: metodoPago
                });

                if (error) throw error;
                
                if (metodoPago === 'efectivo') {
                    requestCodeEl.textContent = codigo;
                    successModal.classList.remove('hidden');
                } else if (metodoPago === 'rayitos') {
                    alert('¡Canje exitoso! Tu recarga será procesada por un administrador en breve.');
                    window.location.reload();
                }

            } catch (error) {
                console.error('Error al procesar la solicitud:', error);
                alert(`Error: ${error.message}`);
            }
        }

        document.querySelectorAll('.recarga-btn').forEach(btn => btn.addEventListener('click', handleRecarga));
        document.getElementById('close-modal-btn').addEventListener('click', () => paymentModal.classList.add('hidden'));
        document.getElementById('pay-with-cash-btn').addEventListener('click', () => procesarSolicitud('efectivo'));
        document.getElementById('pay-with-rayitos-btn').addEventListener('click', () => procesarSolicitud('rayitos'));
        document.getElementById('close-success-modal-btn').addEventListener('click', () => successModal.classList.add('hidden'));


        // Cargar datos iniciales del cliente
        document.addEventListener('DOMContentLoaded', async () => {
            lucide.createIcons();
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) {
                // Si no hay usuario, deshabilitar botones
                document.querySelectorAll('.recarga-btn').forEach(btn => btn.disabled = true);
                return;
            };

            const { data: cliente } = await supabaseClient.from('clientes').select('saldo_rayitos').eq('user_id', user.id).single();
            if (cliente) {
                saldoRayitosCliente = cliente.saldo_rayitos || 0;
            }
        });
    </script>
</body>
</html>
