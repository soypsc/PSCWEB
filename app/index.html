<!DOCTYPE html>
<html lang="es" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PSC App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="manifest" href="manifest.json">
    <style>
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .page { min-height: calc(100vh - 80px); }
        .nav-link.active { color: #34D399; }
        textarea { -webkit-appearance: none; }
    </style>
</head>
<body class="bg-black text-gray-200 font-sans h-full flex flex-col">

    <main id="main-content" class="flex-grow pb-20">
        <div id="page-registro" class="page hidden p-6">
            <h1 class="text-3xl font-bold mb-6 text-center">Crear Cuenta</h1>
            <form id="registro-form" class="space-y-4">
                <input id="registro-nombre" type="text" placeholder="Nombre Completo" required class="w-full bg-gray-800 border-2 border-gray-700 rounded-lg p-3 focus:outline-none focus:border-emerald-400">
                <input id="registro-email" type="email" placeholder="Email" required class="w-full bg-gray-800 border-2 border-gray-700 rounded-lg p-3 focus:outline-none focus:border-emerald-400">
                <input id="registro-password" type="password" placeholder="Contrase√±a (m√≠n. 6 caracteres)" required class="w-full bg-gray-800 border-2 border-gray-700 rounded-lg p-3 focus:outline-none focus:border-emerald-400">
                <select id="registro-sucursal" required class="w-full bg-gray-800 border-2 border-gray-700 rounded-lg p-3 focus:outline-none focus:border-emerald-400">
                    <option value="">Selecciona tu sucursal</option>
                </select>
                <input id="registro-promo" type="text" placeholder="C√≥digo Promocional (Opcional)" class="w-full bg-gray-800 border-2 border-gray-700 rounded-lg p-3 focus:outline-none focus:border-emerald-400">
                <button type="submit" class="w-full bg-emerald-500 text-white font-bold py-3 rounded-lg hover:bg-emerald-600">Registrarme</button>
            </form>
            <p class="text-center mt-4">¬øYa tienes cuenta? <a href="#" id="link-a-login" class="text-emerald-400">Inicia Sesi√≥n</a></p>
        </div>

        <div id="page-login" class="page p-6">
            <h1 class="text-3xl font-bold mb-6 text-center">Iniciar Sesi√≥n</h1>
            <form id="login-form" class="space-y-4">
                <input id="login-email" type="email" placeholder="Email" required class="w-full bg-gray-800 border-2 border-gray-700 rounded-lg p-3 focus:outline-none focus:border-emerald-400">
                <input id="login-password" type="password" placeholder="Contrase√±a" required class="w-full bg-gray-800 border-2 border-gray-700 rounded-lg p-3 focus:outline-none focus:border-emerald-400">
                <button type="submit" class="w-full bg-emerald-500 text-white font-bold py-3 rounded-lg hover:bg-emerald-600">Ingresar</button>
            </form>
            <p class="text-center mt-4">¬øNo tienes cuenta? <a href="#" id="link-a-registro" class="text-emerald-400">Reg√≠strate</a></p>
        </div>

        <div id="page-home" class="page hidden p-6">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <p class="text-lg text-gray-400">Hola,</p>
                    <h1 id="home-nombre" class="text-3xl font-bold"></h1>
                </div>
                <div class="text-right">
                    <p class="text-sm text-gray-400">Casillero</p>
                    <p id="home-box" class="text-xl font-bold"></p>
                </div>
            </div>
            <div class="grid grid-cols-3 gap-4 text-center mb-8">
                <a href="#" class="nav-link" data-page="page-rastreo"><div class="bg-gray-800 p-4 rounded-lg"><p>Rastrear</p></div></a>
                <a href="#" class="nav-link" data-page="page-casillero"><div class="bg-gray-800 p-4 rounded-lg"><p>Direcciones</p></div></a>
                <a href="#" class="nav-link" data-page="page-paquetes"><div class="bg-gray-800 p-4 rounded-lg"><p>Paquetes</p></div></a>
            </div>
            <button id="btn-activar-notificaciones" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg mb-8">Activar Notificaciones</button>
        </div>
        
        <div id="page-paquetes" class="page hidden p-6">
             <h1 class="text-2xl font-bold mb-4">Mis Paquetes</h1>
             <div class="bg-emerald-800 text-white p-4 rounded-lg mb-6">
                 <p class="text-sm">SALDO A PAGAR (EN SUCURSAL)</p>
                 <p id="paquetes-saldo" class="text-3xl font-bold">$0.00</p>
             </div>
             <div id="paquetes-lista"></div>
        </div>

        <div id="page-mi-perfil" class="page hidden p-6">
            <h1 class="text-2xl font-bold mb-6">Mi Perfil</h1>
            <div class="space-y-4">
                <div><p class="text-sm text-gray-400">Nombre</p><p id="perfil-nombre"></p></div>
                <div><p class="text-sm text-gray-400">Casillero</p><p id="perfil-box"></p></div>
                <div><p class="text-sm text-gray-400">Email</p><p id="perfil-email"></p></div>
                <div>
                    <label class="text-sm text-gray-400">Tel√©fono</label>
                    <input id="perfil-telefono" type="tel" class="w-full bg-gray-800 border-2 border-gray-700 rounded-lg p-2 mt-1">
                </div>
                <div>
                    <label class="text-sm text-gray-400">Sucursal Preferida</label>
                    <select id="perfil-sucursal" class="w-full bg-gray-800 border-2 border-gray-700 rounded-lg p-2 mt-1"></select>
                </div>
                <button id="perfil-guardar" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg mt-6">Guardar Cambios</button>
                <button id="logout-button" class="w-full bg-red-500 text-white font-bold py-3 rounded-lg mt-4">Cerrar Sesi√≥n</button>
            </div>
        </div>
        
        <div id="page-rastreo" class="page hidden p-6">
            <h1 class="text-2xl font-bold mb-6">Rastrear Paquete</h1>
            <div class="flex gap-2">
                <input id="tracking-id-input" type="text" placeholder="Ingresa el tracking" class="flex-grow bg-gray-800 border-2 border-gray-700 rounded-lg p-3">
                <button id="buscar-tracking-btn" class="bg-emerald-500 text-white font-bold px-5 rounded-lg">Buscar</button>
            </div>
            <div id="tracking-result" class="mt-6"></div>
        </div>

        <div id="page-cotizador" class="page hidden p-6">
            <h1 class="text-2xl font-bold mb-6">Cotizador de Env√≠os</h1>
            <form id="cotizador-form" class="space-y-4">
                <input type="number" step="0.01" id="cotizador-peso" placeholder="Peso (lbs)" required class="w-full bg-gray-800 border-2 border-gray-700 rounded-lg p-3">
                <div class="grid grid-cols-3 gap-2">
                    <input type="number" step="0.01" id="cotizador-largo" placeholder="Largo" class="w-full bg-gray-800 border-2 border-gray-700 rounded-lg p-3">
                    <input type="number" step="0.01" id="cotizador-ancho" placeholder="Ancho" class="w-full bg-gray-800 border-2 border-gray-700 rounded-lg p-3">
                    <input type="number" step="0.01" id="cotizador-alto" placeholder="Alto" class="w-full bg-gray-800 border-2 border-gray-700 rounded-lg p-3">
                </div>
                <input type="number" step="0.01" id="cotizador-valor" placeholder="Valor del paquete ($)" class="w-full bg-gray-800 border-2 border-gray-700 rounded-lg p-3">
                <button type="submit" class="w-full bg-blue-500 text-white font-bold py-3 rounded-lg">Calcular</button>
            </form>
            <div id="cotizador-result" class="mt-6 text-center"></div>
        </div>

        <div id="page-casillero" class="page hidden p-6">
            <h1 class="text-2xl font-bold mb-6">Direcciones de Casillero</h1>
            <div id="direcciones-container" class="space-y-6"></div>
        </div>

    </main>

    <nav class="fixed bottom-0 left-0 right-0 bg-gray-900 border-t border-gray-800 flex justify-around p-3">
        <a href="#" class="nav-link" data-page="page-home"><div><p class="text-2xl text-center">üè†</p><span class="text-xs">Home</span></div></a>
        <a href="#" class="nav-link" data-page="page-paquetes"><div><p class="text-2xl text-center">üì¶</p><span class="text-xs">Paquetes</span></div></a>
        <a href="#" class="nav-link" data-page="page-casillero"><div><p class="text-2xl text-center">üì´</p><span class="text-xs">Direcciones</span></div></a>
        <a href="#" class="nav-link" data-page="page-cotizador"><div><p class="text-2xl text-center">üßÆ</p><span class="text-xs">Cotizador</span></div></a>
        <a href="#" class="nav-link" data-page="page-mi-perfil"><div><p class="text-2xl text-center">üë§</p><span class="text-xs">Mi Perfil</span></div></a>
    </nav>
    
    <script src="config.js"></script>
    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
        const supabase = createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);

        // --- CONSTANTES Y VARIABLES GLOBALES ---
        const mainContent = document.getElementById('main-content');
        const VAPID_PUBLIC_KEY = 'BJ5s55fLfwWdpod0pWhtP9aTD3a2myT98z3KjJ9s25N_oN-2r7yJSLkFql582AFbOJW1s_bJ62Jvb-g-Z0LgcM0';

        let currentUserProfile = null;

        // --- ELEMENTOS DEL DOM ---
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        const logoutButton = document.getElementById('logout-button');
        const btnActivarNotificaciones = document.getElementById('btn-activar-notificaciones');

        // Formulario de Registro
        const registroForm = document.getElementById('registro-form');
        const registroSucursalSelect = document.getElementById('registro-sucursal');
        
        // Formulario de Login
        const loginForm = document.getElementById('login-form');
        
        // Links de navegaci√≥n entre Login/Registro
        document.getElementById('link-a-login').addEventListener('click', () => showPage('page-login'));
        document.getElementById('link-a-registro').addEventListener('click', () => showPage('page-registro'));

        // --- L√ìGICA DE NAVEGACI√ìN ---
        function showPage(pageId) {
            pages.forEach(page => page.classList.add('hidden'));
            document.getElementById(pageId).classList.remove('hidden');
            navLinks.forEach(link => {
                link.classList.toggle('active', link.dataset.page === pageId);
            });
            window.scrollTo(0, 0);
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                showPage(link.dataset.page);
            });
        });

        // --- L√ìGICA DE AUTENTICACI√ìN Y DATOS ---
        async function loadInitialData() {
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                await fetchUserProfile(session.user.id);
                if (currentUserProfile) {
                    displayUserData();
                    await displayPaquetes();
                    renderizarDirecciones();
                    showPage('page-home');
                } else {
                    showPage('page-login');
                }
            } else {
                await loadSucursales(registroSucursalSelect);
                showPage('page-login');
            }
        }
        
        async function fetchUserProfile(userId) {
            const { data, error } = await supabase.from('clientes').select('*').eq('user_id', userId).single();
            if (error) {
                console.error("Error fetching profile:", error);
                await supabase.auth.signOut();
                return;
            }
            currentUserProfile = data;
        }
        
        function displayUserData() {
            if (!currentUserProfile) return;
            // Home
            document.getElementById('home-nombre').textContent = currentUserProfile.nombre;
            document.getElementById('home-box').textContent = currentUserProfile.box;
            // Perfil
            document.getElementById('perfil-nombre').textContent = currentUserProfile.nombre;
            document.getElementById('perfil-box').textContent = currentUserProfile.box;
            document.getElementById('perfil-email').textContent = currentUserProfile.email;
            document.getElementById('perfil-telefono').value = currentUserProfile.telefono || '';
            loadSucursales(document.getElementById('perfil-sucursal'), currentUserProfile.sucursal);
        }
        
        async function displayPaquetes() {
            if (!currentUserProfile) return;
            const { data, error } = await supabase.rpc('get_paquetes_cliente', { p_cliente_box: currentUserProfile.box });
            const listaDiv = document.getElementById('paquetes-lista');
            if (error) {
                listaDiv.innerHTML = '<p>Error al cargar paquetes.</p>';
                return;
            }

            const enSucursal = data.filter(p => p.status === 'En Sucursal');
            const enTransito = data.filter(p => p.status === 'En transito' || p.status === 'Recibido en Bodega');
            const entregados = data.filter(p => p.status === 'Entregado');
            
            let saldoTotal = enSucursal.reduce((sum, p) => sum + (p.costo_total || 0), 0);
            document.getElementById('paquetes-saldo').textContent = `$${saldoTotal.toFixed(2)}`;

            const renderSection = (title, paquetes) => {
                if (paquetes.length === 0) return '';
                return `<div class="mb-6">
                    <h2 class="font-bold text-gray-400 mb-2">${title}</h2>
                    <div class="space-y-2">
                        ${paquetes.map(p => `<div class="bg-gray-800 p-3 rounded-lg flex justify-between items-center"><div><p>${p.tracking}</p><p class="text-xs text-gray-500">${new Date(p.fecha_recibido).toLocaleDateString()}</p></div><p class="font-bold">$${(p.costo_total || 0).toFixed(2)}</p></div>`).join('')}
                    </div>
                </div>`;
            };
            listaDiv.innerHTML = renderSection('EN SUCURSAL (LISTOS PARA RETIRAR)', enSucursal) + 
                                 renderSection('EN TR√ÅNSITO', enTransito) + 
                                 renderSection('ENTREGADOS (HISTORIAL)', entregados);
        }

        async function loadSucursales(selectElement, selectedValue = '') {
            const { data, error } = await supabase.from('sucursales').select('sucursal');
            if (error) return;
            selectElement.innerHTML = '<option value="">Selecciona tu sucursal</option>';
            data.forEach(s => {
                const option = document.createElement('option');
                option.value = s.sucursal;
                option.textContent = s.sucursal;
                selectElement.appendChild(option);
            });
            if (selectedValue) selectElement.value = selectedValue;
        }
        
        // --- EVENT LISTENERS ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) {
                alert(error.message);
            } else {
                await loadInitialData();
            }
        });

        registroForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const nombre = document.getElementById('registro-nombre').value;
            const email = document.getElementById('registro-email').value;
            const password = document.getElementById('registro-password').value;
            const sucursal = document.getElementById('registro-sucursal').value;
            const promo = document.getElementById('registro-promo').value.trim().toUpperCase();

            const { data: { user }, error } = await supabase.auth.signUp({ 
                email, 
                password,
                options: {
                    data: {
                        full_name: nombre,
                        sucursal: sucursal,
                        promo_code: promo
                    }
                }
            });
            if (error) {
                alert(error.message);
            } else {
                alert('¬°Registro exitoso! Revisa tu email para confirmar tu cuenta.');
                showPage('page-login');
            }
        });
        
        logoutButton.addEventListener('click', async () => {
            await supabase.auth.signOut();
            currentUserProfile = null;
            document.getElementById('login-form').reset();
            document.getElementById('registro-form').reset();
            showPage('page-login');
        });

        document.getElementById('perfil-guardar').addEventListener('click', async () => {
            const telefono = document.getElementById('perfil-telefono').value;
            const sucursal = document.getElementById('perfil-sucursal').value;
            const { error } = await supabase.from('clientes')
                .update({ telefono, sucursal })
                .eq('user_id', currentUserProfile.user_id);
            if (error) {
                alert('Error al guardar: ' + error.message);
            } else {
                alert('Perfil actualizado con √©xito.');
                currentUserProfile.telefono = telefono;
                currentUserProfile.sucursal = sucursal;
            }
        });

        document.getElementById('buscar-tracking-btn').addEventListener('click', async () => {
            const trackingId = document.getElementById('tracking-id-input').value.trim();
            if (!trackingId) return;
            const resultDiv = document.getElementById('tracking-result');
            resultDiv.innerHTML = '<p>Buscando...</p>';
            const { data, error } = await supabase.rpc('get_paquete_status', { p_tracking: trackingId });
            if (error || !data) {
                resultDiv.innerHTML = '<p class="text-red-400">Tracking no encontrado o error en la b√∫squeda.</p>';
            } else {
                resultDiv.innerHTML = `<div class="bg-gray-800 p-4 rounded-lg">
                    <p><strong>Tracking:</strong> ${data.tracking}</p>
                    <p><strong>Estado:</strong> ${data.status}</p>
                    <p><strong>√öltima Actualizaci√≥n:</strong> ${new Date(data.fecha_recibido).toLocaleString()}</p>
                </div>`;
            }
        });

        // --- FUNCIONALIDADES AGREGADAS ---
        function renderizarDirecciones() {
            if (!currentUserProfile) return;
            const container = document.getElementById('direcciones-container');
            const direccionAereo = `
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h2 class="text-lg font-bold text-emerald-400 mb-2">A√©reo</h2>
                    <p><strong>Address Line 1:</strong> 8231 NW 66TH ST</p>
                    <p><strong>Address Line 2:</strong> PSC ${currentUserProfile.box} / ${currentUserProfile.nombre}</p>
                    <p><strong>City:</strong> MIAMI</p>
                    <p><strong>State:</strong> FLORIDA</p>
                    <p><strong>Zip Code:</strong> 33166</p>
                    <p><strong>Phone:</strong> (786) 360-2810</p>
                </div>`;
            const direccionMaritimo = `
                <div class="bg-gray-800 p-4 rounded-lg">
                    <h2 class="text-lg font-bold text-sky-400 mb-2">Mar√≠timo</h2>
                    <p><strong>Address Line 1:</strong> 8231 NW 66TH ST</p>
                    <p><strong>Address Line 2:</strong> PSC ${currentUserProfile.box} / ${currentUserProfile.nombre} - MARITIMO</p>
                    <p><strong>City:</strong> MIAMI</p>
                    <p><strong>State:</strong> FLORIDA</p>
                    <p><strong>Zip Code:</strong> 33166</p>
                    <p><strong>Phone:</strong> (786) 360-2810</p>
                </div>`;
            container.innerHTML = direccionAereo + direccionMaritimo;
        }

        document.getElementById('cotizador-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const peso = parseFloat(document.getElementById('cotizador-peso').value) || 0;
            const largo = parseFloat(document.getElementById('cotizador-largo').value) || 0;
            const ancho = parseFloat(document.getElementById('cotizador-ancho').value) || 0;
            const alto = parseFloat(document.getElementById('cotizador-alto').value) || 0;
            const valor = parseFloat(document.getElementById('cotizador-valor').value) || 0;
            
            const TARIFA_LIBRA = 2.50;
            const TARIFA_SEGURO = 0.03;

            const pesoVolumetrico = (largo * ancho * alto) / 166;
            const pesoFinal = Math.max(peso, pesoVolumetrico);
            const costoFlete = pesoFinal * TARIFA_LIBRA;
            const costoSeguro = valor * TARIFA_SEGURO;
            const total = costoFlete + costoSeguro;

            document.getElementById('cotizador-result').innerHTML = `
                <p class="text-lg">Costo Estimado: <span class="font-bold text-2xl text-emerald-400">$${total.toFixed(2)}</span></p>
                <p class="text-xs text-gray-500">Costo de Flete: $${costoFlete.toFixed(2)}, Seguro: $${costoSeguro.toFixed(2)}</p>
            `;
        });
        
        // --- L√ìGICA DE NOTIFICACIONES PUSH ---
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding).replace(/-/g, '+').replace(/_/g, '/');
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        async function initPushNotifications() {
            if ('serviceWorker' in navigator && 'PushManager' in window) {
                try {
                    const registration = await navigator.serviceWorker.register('service-worker.js');
                    console.log('Service Worker registrado con √©xito.');
                    
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        console.log('Permiso de notificaci√≥n concedido.');
                        await subscribeUserToPush(registration);
                    }
                } catch (error) {
                    console.error('Error en Service Worker o Notificaciones Push:', error);
                }
            }
        }

        async function subscribeUserToPush(registration) {
            try {
                const subscription = await registration.pushManager.subscribe({
                    userVisibleOnly: true,
                    applicationServerKey: urlBase64ToUint8Array(VAPID_PUBLIC_KEY)
                });
                console.log('Usuario suscrito:', subscription);
                await sendSubscriptionToBackEnd(subscription);
            } catch (error) {
                console.error('Error al suscribir al usuario:', error);
            }
        }

        async function sendSubscriptionToBackEnd(subscription) {
            if (!currentUserProfile) return;
            const { error } = await supabase.from('clientes')
                .update({ push_subscription: subscription })
                .eq('user_id', currentUserProfile.user_id);
            if (error) {
                console.error('Error al guardar la suscripci√≥n:', error);
            } else {
                console.log('Suscripci√≥n guardada en la base de datos.');
                alert('¬°Notificaciones activadas con √©xito!');
            }
        }
        
        btnActivarNotificaciones.addEventListener('click', initPushNotifications);

        // --- INICIALIZACI√ìN DE LA APP ---
        document.addEventListener('DOMContentLoaded', loadInitialData);

    </script>
</body>
</html>










