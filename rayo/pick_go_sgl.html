<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGL1 - Verificador Pick & Go</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="config.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <!-- Librería para escanear QR -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .code { font-size: 13px; font-weight: 600; color: #94a3b8; margin-right: 12px; background-color: #f1f5f9; padding: 2px 8px; border-radius: 6px; }
        #qr-reader-container { max-width: 500px; margin: auto; }
        #qr-reader { border: 2px solid #e2e8f0; border-radius: 8px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

<script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const supabase = createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);
    (async () => {
        const { data: { session } } = await supabase.auth.getSession();
        if (!session) { window.location.href = 'login.html'; return; }
        const { data: perfil, error } = await supabase.from('perfiles').select('rol').eq('id', session.user.id).single();
        if (error || !perfil || (perfil.rol !== 'admin' && perfil.rol !== 'supervisor' && perfil.rol !== 'employee')) {
            await supabase.auth.signOut();
            window.location.href = 'login.html?error=unauthorized';
        }
    })();
</script>

<div class="relative min-h-screen md:flex">
    <div id="menu-container"></div>

    <main class="flex-1 p-8">
        <h1 class="text-3xl font-bold text-slate-900 flex items-center mb-6"><span class="code">[OP-06]</span>Verificador Pick & Go</h1>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Columna del Escáner -->
            <div class="bg-white p-6 rounded-lg border shadow-sm">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Escanear Código QR</h2>
                <div id="qr-reader-container">
                    <div id="qr-reader"></div>
                </div>
                 <p id="scan-status" class="text-center mt-4 text-slate-500">Apunte la cámara al código QR del cliente.</p>
            </div>

            <!-- Columna de Detalles de la Orden -->
            <div id="order-details-container" class="bg-white p-6 rounded-lg border shadow-sm hidden">
                <h2 class="text-xl font-bold text-slate-800 mb-4">Detalles de la Orden de Retiro</h2>
                <div id="order-info" class="space-y-3">
                    <p><strong>Cliente:</strong> <span id="cliente-nombre"></span></p>
                    <p><strong>Monto Pagado:</strong> <span id="monto-pagado"></span></p>
                    <p><strong>Estado:</strong> <span id="orden-status" class="font-bold px-2 py-1 rounded-full text-xs"></span></p>
                    <h3 class="font-semibold text-slate-700 pt-3 border-t">Paquetes a Entregar:</h3>
                    <ul id="packages-list" class="list-disc list-inside space-y-1 font-mono"></ul>
                </div>
                <button id="btn-entregar" class="w-full mt-6 bg-emerald-500 text-white font-semibold py-3 rounded-lg hover:bg-emerald-600 disabled:bg-slate-400">
                    Marcar como Entregado
                </button>
            </div>
             <div id="placeholder-container" class="bg-white p-6 rounded-lg border shadow-sm flex flex-col items-center justify-center text-center">
                <i data-lucide="qr-code" class="h-16 w-16 text-slate-300 mb-4"></i>
                <h2 class="text-xl font-bold text-slate-800">Esperando escaneo...</h2>
                <p class="text-slate-500">Los detalles de la orden aparecerán aquí.</p>
            </div>
        </div>
    </main>
</div>

<script type="module" src="app.js"></script>
<script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    const sb = createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);
    
    const qrReaderEl = document.getElementById('qr-reader');
    const scanStatusEl = document.getElementById('scan-status');
    const orderDetailsContainer = document.getElementById('order-details-container');
    const placeholderContainer = document.getElementById('placeholder-container');

    const clienteNombreEl = document.getElementById('cliente-nombre');
    const montoPagadoEl = document.getElementById('monto-pagado');
    const ordenStatusEl = document.getElementById('orden-status');
    const packagesListEl = document.getElementById('packages-list');
    const btnEntregar = document.getElementById('btn-entregar');
    let currentRetiroId = null;

    function onScanSuccess(decodedText, decodedResult) {
        console.log(`Scan result: ${decodedText}`);
        html5QrcodeScanner.pause();
        scanStatusEl.textContent = `Código detectado: ${decodedText.substring(0, 15)}...`;
        scanStatusEl.classList.add('font-bold', 'text-green-600');
        loadOrderDetails(decodedText);
    }
    
    function onScanFailure(error) {
        // console.warn(`QR error = ${error}`);
    }

    async function loadOrderDetails(retiroId) {
        currentRetiroId = retiroId;
        orderDetailsContainer.classList.add('hidden');
        placeholderContainer.classList.add('hidden');

        try {
            const { data, error } = await sb.from('retiros')
                .select('*, clientes(nombre, box), paquetes(tracking)')
                .eq('id', retiroId)
                .single();

            if (error || !data) throw new Error("Orden de retiro no encontrada.");

            clienteNombreEl.textContent = `${data.clientes.nombre} (Box ${data.clientes.box})`;
            montoPagadoEl.textContent = `$${(data.monto_total || 0).toFixed(2)}`;
            ordenStatusEl.textContent = data.status;

            const statusClasses = {
                'pagado': 'bg-yellow-100 text-yellow-800',
                'listo_para_retiro': 'bg-blue-100 text-blue-800',
                'entregado': 'bg-green-100 text-green-800'
            };
            ordenStatusEl.className = `font-bold px-2 py-1 rounded-full text-xs ${statusClasses[data.status] || ''}`;

            packagesListEl.innerHTML = data.paquetes.map(p => `<li>${p.tracking}</li>`).join('');
            
            btnEntregar.disabled = data.status === 'entregado';
            orderDetailsContainer.classList.remove('hidden');

        } catch (error) {
            alert(`Error: ${error.message}`);
            resetScanner();
        }
    }

    async function handleEntrega() {
        if (!currentRetiroId) return;

        if (!confirm("¿Confirma la entrega de todos los paquetes de esta orden?")) {
            return;
        }

        btnEntregar.disabled = true;
        btnEntregar.textContent = 'Procesando...';

        try {
            const { data, error } = await sb.rpc('marcar_retiro_entregado', { p_retiro_id: currentRetiroId });
            if (error) throw error;
            
            alert(`Entrega para ${data[0].cliente_nombre} completada con éxito.`);
            resetScanner();

        } catch (error) {
            alert(`Error al marcar como entregado: ${error.message}`);
            btnEntregar.disabled = false;
        } finally {
            btnEntregar.textContent = 'Marcar como Entregado';
        }
    }
    
    function resetScanner() {
        orderDetailsContainer.classList.add('hidden');
        placeholderContainer.classList.remove('hidden');
        scanStatusEl.textContent = 'Apunte la cámara al código QR del cliente.';
        scanStatusEl.className = 'text-center mt-4 text-slate-500';
        currentRetiroId = null;
        try {
            html5QrcodeScanner.resume();
        } catch(e) {
            console.error("Error resuming scanner", e);
        }
    }

    let html5QrcodeScanner;
    document.addEventListener('DOMContentLoaded', () => {
        html5QrcodeScanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 250 });
        html5QrcodeScanner.render(onScanSuccess, onScanFailure);
        btnEntregar.addEventListener('click', handleEntrega);
        lucide.createIcons();
    });

</script>
</body>
</html>
