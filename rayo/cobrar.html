<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGL1 - Terminal de Entrega</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="config.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .code { font-size: 13px; font-weight: 600; color: #94a3b8; margin-right: 12px; background-color: #f1f5f9; padding: 2px 8px; border-radius: 6px; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .scan-success { background-color: #dcfce7 !important; transition: background-color: 0.3s; }
        .scan-error { background-color: #fee2e2 !important; transition: background-color: 0.3s; }
        .verified-item { text-decoration: line-through; color: #9ca3af; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div class="relative min-h-screen md:flex">
        <div id="menu-container"></div>

        <main class="flex-1 p-8">
            <h1 class="text-3xl font-bold text-slate-900 flex items-center mb-6"><span class="code">[OP-05]</span>Terminal de Entrega</h1>
            
            <div class="bg-white p-6 rounded-lg border shadow-sm">
                <div class="flex flex-wrap gap-4 items-center mb-6">
                    <div class="relative flex-grow max-w-xl">
                        <label class="block text-sm font-medium text-slate-600 mb-1">Buscar Cliente por Casillero o Nombre</label>
                        <input type="text" id="search-cliente" class="w-full text-lg p-2 border-2 border-slate-300 rounded-lg" placeholder="Inicia aqu√≠...">
                    </div>
                    <div class="pt-6">
                        <button id="btn-cargar-suspendida" class="w-full bg-slate-200 text-slate-700 font-semibold py-2.5 px-4 rounded-md hover:bg-slate-300">Cargar Venta</button>
                    </div>
                </div>

                <div id="terminal-content" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div>
                            <div id="verification-panel" class="hidden mb-6 p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800">
                                <h3 class="font-bold">Verificaci√≥n Requerida</h3>
                                <p class="text-sm">Escanee todos los paquetes de la lista para desbloquear la venta:</p>
                                <ul id="verification-list" class="list-disc list-inside mt-2 text-sm font-mono"></ul>
                            </div>
                            <h2 class="text-xl font-bold text-slate-800 mb-2">Paquetes Pendientes de <span id="cliente-nombre-titulo"></span></h2>
                            <p class="mb-4 text-sm text-slate-500">Escanee cada paquete para agregarlo al carrito.</p>
                            <div id="pendientes-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                        </div>

                        <div class="bg-slate-50 rounded-lg p-6">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">üõí Carrito de Entrega</h2>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-slate-600 mb-1">Escanear Paquete</label>
                                <input type="text" id="scan-input" class="w-full text-base p-2 border-2 border-slate-400 rounded-lg" placeholder="Esperando escaneo...">
                            </div>
                            <div id="carrito-items" class="space-y-3 mb-4"></div>
                            <div class="space-y-2 border-t pt-4 mb-4">
                                <label class="block text-sm font-medium text-slate-600">C√≥digo de Descuento</label>
                                <div class="flex gap-2">
                                    <input type="text" id="cupon-code-input" class="w-full p-2 border border-slate-300 rounded-md uppercase" placeholder="Ej: VERANO25">
                                    <button id="btn-aplicar-cupon" class="bg-slate-700 text-white font-semibold px-4 rounded-md hover:bg-slate-800">Aplicar</button>
                                </div>
                                <p id="cupon-message" class="text-sm h-4"></p>
                            </div>
                            <div class="space-y-3 border-t pt-4">
                                <div class="flex justify-between items-center text-sm"><span class="text-slate-600">Subtotal:</span><span id="subtotal-carrito" class="font-medium">$0.00</span></div>
                                <div class="flex justify-between items-center text-sm"><span class="text-slate-600">Descuentos:</span><span id="descuentos-carrito" class="font-medium text-red-500">-$0.00</span></div>
                                <div class="flex justify-between font-bold text-3xl text-emerald-600 mt-2"><span>TOTAL:</span><span id="total-carrito">$0.00</span></div>
                                <button id="btn-descuento-general" class="w-full text-sm py-2 bg-amber-100 text-amber-800 font-semibold rounded-md hover:bg-amber-200">Aplicar Descuento General (%)</button>
                            </div>
                            
                            <div id="pago-modulo" class="mt-6 border-t pt-6">
                                <h3 class="text-lg font-semibold text-slate-700 mb-2">Registrar Pago</h3>
                                <div id="credit-panel" class="hidden mb-4 p-3 bg-blue-100 text-blue-800 rounded-lg">
                                    <div class="flex justify-between items-center">
                                        <p>Saldo a favor: <span id="credit-balance" class="font-bold"></span></p>
                                        <button id="btn-apply-credit" class="font-semibold hover:underline text-sm bg-blue-200 px-3 py-1 rounded-md">Aplicar Saldo</button>
                                    </div>
                                </div>
                                <div class="flex justify-between font-medium text-xl text-red-600 mb-4"><span>Restante:</span><span id="pago-restante">$0.00</span></div>
                                <div id="payment-methods-container" class="grid grid-cols-2 gap-2 mb-4"></div>
                                <div id="pagos-realizados-list" class="text-sm space-y-1 mb-4"></div>
                            </div>
                            
                            <div class="mt-6 border-t pt-6 flex gap-2">
                                <button id="btn-suspender-venta" class="w-full bg-orange-500 text-white font-semibold py-3 rounded-lg hover:bg-orange-600 disabled:bg-slate-400" disabled>Suspender Venta</button>
                                <button id="btn-completar-venta" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-emerald-700 disabled:bg-slate-400" disabled>Completar Venta</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="edit-peso-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white w-full max-w-lg rounded-lg shadow-xl p-6">
            <div class="flex justify-between items-center mb-6"><h2 class="text-xl font-bold text-slate-800">Ajustar Peso del Paquete</h2><button id="close-edit-modal" class="text-slate-400 hover:text-slate-600 text-3xl font-bold">&times;</button></div>
            <form id="form-edit-peso" class="space-y-4">
                <div><label class="block text-sm font-medium">Tracking</label><p id="edit-peso-tracking" class="mt-1 p-2 bg-slate-100 rounded-md font-mono text-slate-700"></p></div>
                <div><label for="edit-peso-nuevo" class="block text-sm font-medium">Nuevo Peso (lbs)</label><input id="edit-peso-nuevo" type="number" step="0.01" required class="w-full mt-1 p-2 border border-slate-300 rounded-md"></div>
                <div><label for="edit-peso-nota" class="block text-sm font-medium">Justificaci√≥n (Obligatorio)</label><textarea id="edit-peso-nota" required rows="3" class="w-full mt-1 p-2 border border-slate-300 rounded-md"></textarea></div>
                <div><label for="edit-peso-foto" class="block text-sm font-medium">Foto en la Pesa (JPG Obligatorio)</label><input id="edit-peso-foto" type="file" accept="image/jpeg" required class="w-full mt-1 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100"></div>
                <p id="edit-peso-message" class="text-sm text-center h-5"></p>
                <div class="flex justify-end gap-4 pt-4 border-t"><button type="button" id="cancel-edit-modal" class="bg-slate-100 text-slate-700 font-semibold py-2 px-4 rounded-md hover:bg-slate-200">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-blue-700">Guardar Ajuste</button></div>
            </form>
        </div>
    </div>
    <div id="load-suspended-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white w-full max-w-2xl rounded-lg shadow-xl p-6">
            <h2 class="text-xl font-bold text-slate-800 mb-4">Cargar Venta Suspendida</h2>
            <div id="suspended-sales-list" class="max-h-96 overflow-y-auto"></div>
            <button id="close-load-suspended-modal" class="mt-4 w-full bg-slate-200 text-slate-700 font-semibold py-2 rounded-md">Cerrar</button>
        </div>
    </div>
    
    <script src="app.js"></script>
    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
        const sb = createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);

        let clienteActual=null, paquetesPendientes=[], carrito=[], pagos=[], paqueteParaEditar=null;
        let descuentoGeneralPorcentaje=0, cuponAplicado=null;
        let ventaSuspendidaActual=null, modoVerificacion=false;

        // --- Selectores del DOM ---
        const searchClienteInput = document.getElementById('search-cliente');
        const terminalContent = document.getElementById('terminal-content');
        const clienteNombreTitulo = document.getElementById('cliente-nombre-titulo');
        const pendientesListDiv = document.getElementById('pendientes-list');
        const scanInput = document.getElementById('scan-input');
        const carritoItemsDiv = document.getElementById('carrito-items');
        const totalCarritoSpan = document.getElementById('total-carrito');
        const pagoRestanteSpan = document.getElementById('pago-restante');
        const pagosRealizadosList = document.getElementById('pagos-realizados-list');
        const btnCompletarVenta = document.getElementById('btn-completar-venta');
        const verificationPanel = document.getElementById('verification-panel');
        const verificationList = document.getElementById('verification-list');
        const btnSuspenderVenta = document.getElementById('btn-suspender-venta');
        const paymentMethodsContainer = document.getElementById('payment-methods-container');
        const subtotalCarritoSpan = document.getElementById('subtotal-carrito');
        const descuentosCarritoSpan = document.getElementById('descuentos-carrito');
        const btnDescuentoGeneral = document.getElementById('btn-descuento-general');
        const cuponCodeInput = document.getElementById('cupon-code-input');
        const btnAplicarCupon = document.getElementById('btn-aplicar-cupon');
        const cuponMessage = document.getElementById('cupon-message');
        const loadSuspendedModal = document.getElementById('load-suspended-modal');
        const suspendedSalesList = document.getElementById('suspended-sales-list');
        const editPesoModal = document.getElementById('edit-peso-modal');
        const formEditPeso = document.getElementById('form-edit-peso');
        const editPesoTracking = document.getElementById('edit-peso-tracking');
        const editPesoNuevo = document.getElementById('edit-peso-nuevo');
        const editPesoNota = document.getElementById('edit-peso-nota');
        const editPesoFoto = document.getElementById('edit-peso-foto');
        const editPesoMessage = document.getElementById('edit-peso-message');
        const creditPanel = document.getElementById('credit-panel');
        const creditBalanceSpan = document.getElementById('credit-balance');
        const btnApplyCredit = document.getElementById('btn-apply-credit');

        // --- L√≥gica de Renderizado ---
        function renderPendientes() {
            if (paquetesPendientes.length === 0) {
                pendientesListDiv.innerHTML = '<p class="text-center text-slate-500 p-4">¬°No hay m√°s paquetes pendientes para este cliente!</p>';
                return;
            }
            const agrupados = paquetesPendientes.reduce((acc, p) => {
                const anaquel = p.anaquel || 'Sin Anaquel';
                if (!acc[anaquel]) acc[anaquel] = [];
                acc[anaquel].push(p);
                return acc;
            }, {});
            pendientesListDiv.innerHTML = Object.entries(agrupados).map(([anaquel, paquetes]) => `<div class="p-3 bg-slate-100 rounded-md"><h4 class="font-bold text-slate-600 mb-2">üìç Anaquel: ${anaquel}</h4><div class="space-y-2">${paquetes.map(p => `<div id="pendiente-${p.tracking}" class="p-2 border bg-white rounded flex justify-between items-center"><span>${p.tracking}</span><span class="text-sm text-slate-500">${(p.peso || 0).toFixed(2)} lbs</span></div>`).join('')}</div></div>`).join('');
        }
        
        function renderCarrito() {
            if (carrito.length === 0) {
                carritoItemsDiv.innerHTML = '<p class="text-slate-500">El carrito est√° vac√≠o.</p>';
            } else {
                carritoItemsDiv.innerHTML = carrito.map(p => {
                    const costoOriginal = (p.costo_flete || 0) + (p.costo_impuestos || 0);
                    const montoDescuento = costoOriginal * ((p.descuento_porcentaje || 0) / 100);
                    const costoFinal = costoOriginal - montoDescuento;
                    return `<div class="p-2.5 bg-white rounded-lg border flex justify-between items-center fade-in"><div><p class="font-semibold">${p.tracking}</p><p class="text-xs text-slate-500">${(p.peso || 0).toFixed(2)} lbs</p>${montoDescuento > 0 ? `<p class="text-xs text-red-500 font-semibold">Descuento: ${p.descuento_porcentaje}% (-$${montoDescuento.toFixed(2)})</p>` : ''}</div><div class="flex items-center gap-3"><span class="font-bold text-emerald-700">$${costoFinal.toFixed(2)}</span><button class="btn-discount-item text-slate-400 hover:text-amber-600" data-tracking="${p.tracking}" title="Aplicar Descuento"><i data-lucide="tag" class="h-4 w-4"></i></button><button class="btn-edit-item text-slate-400 hover:text-blue-600" data-tracking="${p.tracking}" title="Editar Peso"><i data-lucide="edit" class="h-4 w-4"></i></button><button class="btn-delete-item text-slate-400 hover:text-red-600" data-tracking="${p.tracking}" title="Eliminar del Carrito"><i data-lucide="trash-2" class="h-4 w-4"></i></button></div></div>`;
                }).join('');
            }
            btnSuspenderVenta.disabled = carrito.length === 0;
            calcularTotal();
            lucide.createIcons();
        }

        function renderPagos() {
            pagosRealizadosList.innerHTML = pagos.map(p => `<div class="flex justify-between bg-emerald-100 p-1 rounded-md"><span>${p.metodo}:</span><span class="font-medium">$${p.monto.toFixed(2)}</span></div>`).join('');
        }

        function renderVerificationList() {
            verificationPanel.classList.remove('hidden');
            const allTrackings = ventaSuspendidaActual.carrito_data.map(p => p.tracking);
            verificationList.innerHTML = allTrackings.map(t => {
                const isVerified = !ventaSuspendidaActual.trackings_pendientes.includes(t);
                return `<li class="${isVerified ? 'verified-item' : ''}">${t}</li>`;
            }).join('');
        }

        async function loadPaymentMethods() {
            const { data, error } = await sb.from('metodos_pago').select('nombre').eq('is_activo', true).order('nombre');
            if (error || !data) {
                paymentMethodsContainer.innerHTML = '<p class="text-red-500 text-sm">Error al cargar m√©todos de pago.</p>';
                return;
            }
            const colors = ['bg-sky-500', 'bg-indigo-500', 'bg-purple-500', 'bg-gray-500', 'bg-teal-500', 'bg-rose-500'];
            paymentMethodsContainer.innerHTML = data.map((metodo, index) => {
                const color = colors[index % colors.length];
                return `<button data-metodo="${metodo.nombre}" class="payment-method-btn ${color} text-white p-2 rounded-md hover:opacity-80">${metodo.nombre}</button>`;
            }).join('');
        }
        
        async function buscarCliente(searchTerm) {
            resetTerminal();
            if (!searchTerm) return;
            const isNumeric = !isNaN(searchTerm);
            let query = sb.from('clientes').select('*');
            if (isNumeric) query = query.eq('box', parseInt(searchTerm));
            else query = query.ilike('nombre', `%${searchTerm}%`);
            const { data, error } = await query.limit(1).single();
            if (error || !data) { alert("Cliente no encontrado."); return; }
            clienteActual = data;
            
            const { data: paquetes, error: paquetesError } = await sb.rpc('get_paquetes_para_entrega', { p_cliente_box: clienteActual.box });
            if (paquetesError) { alert("Error al cargar paquetes del cliente."); console.error(paquetesError); return; }
            
            paquetesPendientes = paquetes.map(p => ({ ...p, costo_flete: p.costo_total, costo_impuestos: 0, descuento_porcentaje: 0 }));

            clienteNombreTitulo.textContent = clienteActual.nombre;
            terminalContent.classList.remove('hidden');
            if (clienteActual.saldo_a_favor > 0) {
                creditBalanceSpan.textContent = `$${clienteActual.saldo_a_favor.toFixed(2)}`;
                creditPanel.classList.remove('hidden');
            }
            
            renderPendientes();
            await loadPaymentMethods();
            scanInput.focus();
        }
        
        function handleScan() {
            const tracking = scanInput.value.trim().toLowerCase();
            if (!tracking) return;
            scanInput.value = '';
            scanInput.focus();
            if (modoVerificacion) {
                const itemIndex = ventaSuspendidaActual.trackings_pendientes.findIndex(t => t.trim().toLowerCase() === tracking);
                if (itemIndex > -1) {
                    ventaSuspendidaActual.trackings_pendientes.splice(itemIndex, 1);
                    flashInputColor('scan-success');
                    renderVerificationList();
                    if (ventaSuspendidaActual.trackings_pendientes.length === 0) {
                        modoVerificacion = false;
                        verificationPanel.classList.add('hidden');
                        alert("¬°Verificaci√≥n completada! El carrito est√° desbloqueado.");
                        scanInput.placeholder = "Escanear paquete para A√ëADIR";
                        calcularTotal();
                    }
                } else {
                    flashInputColor('scan-error');
                    alert("Este tracking no pertenece a la venta suspendida o ya fue verificado.");
                }
            } else {
                const paqueteIndex = paquetesPendientes.findIndex(p => p.tracking.toLowerCase() === tracking);
                if (paqueteIndex > -1) {
                    const [paquete] = paquetesPendientes.splice(paqueteIndex, 1);
                    carrito.push(paquete);
                    renderPendientes();
                    renderCarrito();
                    flashInputColor('scan-success');
                } else {
                    alert(`Error: Paquete ${tracking} no est√° en la lista de pendientes o ya fue escaneado.`);
                    flashInputColor('scan-error');
                }
            }
        }
        
        function handleRemoveFromCart(tracking) {
            const paqueteIndex = carrito.findIndex(p => p.tracking === tracking);
            if (paqueteIndex > -1) {
                const [paquete] = carrito.splice(paqueteIndex, 1);
                paquetesPendientes.push(paquete);
                renderCarrito();
                renderPendientes();
            }
        }
        
        function handleOpenEditModal(tracking) {
            const paquete = carrito.find(p => p.tracking === tracking);
            if (paquete) {
                paqueteParaEditar = paquete;
                formEditPeso.reset();
                editPesoMessage.textContent = '';
                editPesoTracking.textContent = paquete.tracking;
                editPesoNuevo.value = paquete.peso || 0;
                editPesoModal.classList.remove('hidden');
            }
        }

        async function handleEditPesoSubmit(e) {
            e.preventDefault();
            const submitButton = formEditPeso.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            editPesoMessage.textContent = 'Procesando...';
            const nuevoPeso = parseFloat(editPesoNuevo.value);
            const nota = editPesoNota.value.trim();
            const foto = editPesoFoto.files[0];
            if (!nota || !foto || isNaN(nuevoPeso)) {
                editPesoMessage.textContent = 'Todos los campos son obligatorios.';
                submitButton.disabled = false;
                return;
            }
            try {
                const filePath = `public/${paqueteParaEditar.tracking}-${Date.now()}.jpg`;
                const { error: uploadError } = await sb.storage.from('ajustes-peso').upload(filePath, foto, { contentType: 'image/jpeg' });
                if (uploadError) throw new Error(`Error al subir foto: ${uploadError.message}`);
                const { data: urlData } = sb.storage.from('ajustes-peso').getPublicUrl(filePath);
                if (!urlData) throw new Error("No se pudo obtener la URL de la foto.");
                const { error: rpcError } = await sb.rpc('update_paquete_peso', {
                    p_id: paqueteParaEditar.id, p_peso: nuevoPeso, p_nota: nota, p_foto_url: urlData.publicUrl
                });
                if (rpcError) throw new Error(`Error al guardar en DB: ${rpcError.message}`);
                const { data: paqueteActualizado, error: fetchError } = await sb.rpc('get_paquetes_para_entrega', { p_cliente_box: clienteActual.box }).eq('id', paqueteParaEditar.id).single();
                if (fetchError) throw new Error(`Error al refrescar datos: ${fetchError.message}`);
                const indexEnCarrito = carrito.findIndex(p => p.id === paqueteParaEditar.id);
                if (indexEnCarrito > -1) {
                    carrito[indexEnCarrito] = { ...paqueteActualizado, costo_flete: paqueteActualizado.costo_total, costo_impuestos: 0, descuento_porcentaje: carrito[indexEnCarrito].descuento_porcentaje };
                }
                editPesoMessage.textContent = '¬°Ajuste guardado con √©xito!';
                setTimeout(() => { editPesoModal.classList.add('hidden'); renderCarrito(); }, 1500);
            } catch (error) {
                console.error("Error en ajuste de peso:", error);
                editPesoMessage.textContent = error.message;
            } finally {
                submitButton.disabled = false;
            }
        }

        function handleItemDiscount(tracking) {
            const item = carrito.find(p => p.tracking === tracking);
            const porcentajeStr = prompt("Ingrese el porcentaje de descuento para este paquete:", item.descuento_porcentaje || "0");
            const porcentaje = parseFloat(porcentajeStr);
            if (!isNaN(porcentaje) && porcentaje >= 0 && porcentaje <= 100) {
                item.descuento_porcentaje = porcentaje;
                renderCarrito();
            } else if (porcentajeStr !== null) {
                alert("Porcentaje inv√°lido.");
            }
        }

        function handleGeneralDiscount() {
            const porcentajeStr = prompt("Ingrese el porcentaje de descuento GENERAL:", descuentoGeneralPorcentaje || "0");
            const porcentaje = parseFloat(porcentajeStr);
            if (!isNaN(porcentaje) && porcentaje >= 0 && porcentaje <= 100) {
                descuentoGeneralPorcentaje = porcentaje;
                calcularTotal();
            } else if (porcentajeStr !== null) {
                alert("Porcentaje inv√°lido.");
            }
        }

        async function handleAplicarCupon() {
            const codigo = cuponCodeInput.value.trim().toUpperCase();
            if (!codigo) { cuponMessage.textContent = "Ingrese un c√≥digo."; return; }
            cuponMessage.textContent = "Validando...";
            try {
                const { data, error } = await sb.rpc('validar_y_obtener_cupon', { p_codigo: codigo });
                if (error) throw error;
                cuponAplicado = data;
                cuponMessage.textContent = `‚úÖ Cup√≥n "${cuponAplicado.codigo}" aplicado.`;
                cuponCodeInput.disabled = true;
                btnAplicarCupon.disabled = true;
                calcularTotal();
            } catch (error) {
                cuponAplicado = null;
                const friendlyError = error.message.includes('RAISE EXCEPTION:') ? error.message.split('RAISE EXCEPTION:')[1].trim() : "Error de validaci√≥n.";
                cuponMessage.textContent = `‚ùå ${friendlyError}`;
            }
        }
        
        async function handleApplyCredit() {
            if (!clienteActual || clienteActual.saldo_a_favor <= 0) return;
            const restante = parseFloat(pagoRestanteSpan.textContent.replace('$', ''));
            const montoAAplicar = Math.min(clienteActual.saldo_a_favor, restante);
            if (montoAAplicar <= 0) {
                alert("No hay monto restante que cubrir.");
                return;
            }
            btnApplyCredit.disabled = true;
            btnApplyCredit.textContent = "Aplicando...";
            try {
                const { data: nuevoSaldo, error } = await sb.rpc('aplicar_saldo_a_favor', {
                    p_cliente_box: clienteActual.box,
                    p_monto_a_aplicar: montoAAplicar
                });
                if (error) throw error;
                clienteActual.saldo_a_favor = nuevoSaldo;
                pagos.push({ metodo: 'Saldo a Favor', monto: montoAAplicar });
                renderPagos();
                calcularTotal();
                creditBalanceSpan.textContent = `$${nuevoSaldo.toFixed(2)}`;
                if (nuevoSaldo <= 0) {
                    creditPanel.classList.add('hidden');
                }
            } catch (error) {
                alert(`Error al aplicar saldo: ${error.message}`);
            } finally {
                btnApplyCredit.disabled = false;
                btnApplyCredit.textContent = "Aplicar Saldo";
            }
        }

        function calcularTotal() {
            let subtotal=0, descuentoTotalItems=0;
            carrito.forEach(p => {
                const costoOriginal = (p.costo_flete || 0) + (p.costo_impuestos || 0);
                subtotal += costoOriginal;
                descuentoTotalItems += costoOriginal * ((p.descuento_porcentaje || 0) / 100);
            });
            const subtotalConDescuentosItems = subtotal - descuentoTotalItems;
            let descuentoCuponMonto = 0;
            if (cuponAplicado) {
                if (cuponAplicado.tipo_descuento === 'porcentaje') descuentoCuponMonto = subtotalConDescuentosItems * (cuponAplicado.valor_descuento / 100);
                else if (cuponAplicado.tipo_descuento === 'monto_fijo') descuentoCuponMonto = cuponAplicado.valor_descuento;
            }
            const subtotalConCupon = subtotalConDescuentosItems - descuentoCuponMonto;
            const descuentoGeneralMonto = subtotalConCupon * (descuentoGeneralPorcentaje / 100);
            const totalFinal = subtotalConCupon - descuentoGeneralMonto;
            const descuentoTotalFinal = descuentoTotalItems + descuentoCuponMonto + descuentoGeneralMonto;
            const totalPagado = pagos.reduce((acc, p) => acc + p.monto, 0);
            const restante = totalFinal - totalPagado;
            subtotalCarritoSpan.textContent = `$${subtotal.toFixed(2)}`;
            descuentosCarritoSpan.textContent = `-$${descuentoTotalFinal.toFixed(2)}`;
            totalCarritoSpan.textContent = `$${totalFinal.toFixed(2)}`;
            pagoRestanteSpan.textContent = `$${restante.toFixed(2)}`;
            btnCompletarVenta.disabled = modoVerificacion || carrito.length === 0 || restante > 0.001;
        }

        async function completarVenta() {
            if (btnCompletarVenta.disabled) return;
            btnCompletarVenta.textContent = "Procesando...";
            btnCompletarVenta.disabled = true;
            
            const montoTotalFinal = parseFloat(totalCarritoSpan.textContent.replace('$', ''));

            try {
                const { data: facturaId, error: ventaError } = await sb.rpc('finalizar_venta', {
                    p_cliente_box: clienteActual.box,
                    p_cliente_nombre: clienteActual.nombre,
                    p_monto_total: montoTotalFinal,
                    p_descuento_general_porcentaje: descuentoGeneralPorcentaje,
                    p_cupon_codigo: cuponAplicado ? cuponAplicado.codigo : null,
                    p_venta_suspendida_id: ventaSuspendidaActual ? ventaSuspendidaActual.id : null,
                    p_carrito: carrito.map(p=>({id:p.id, tracking:p.tracking, costo_flete:(p.costo_flete||0)+(p.costo_impuestos||0), descuento_porcentaje:p.descuento_porcentaje||0})),
                    p_pagos: pagos
                });

                if (ventaError) throw ventaError;

                const htmlRecibo = await generarReciboHTML(facturaId);
                
                const { data: { session } } = await sb.auth.getSession();
                if (!session) throw new Error("Sesi√≥n de usuario no encontrada. No se puede generar PDF.");

                const { data: pdfData, error: pdfError } = await sb.functions.invoke('generar-factura-pdf', {
                    headers: {
                        'Authorization': `Bearer ${session.access_token}`
                    },
                    body: { 
                        htmlContent: htmlRecibo, 
                        facturaId: facturaId 
                    }
                });

                if (pdfError) {
                    alert(`¬°Venta completada! Factura #${facturaId.substring(0, 8)} creada.\n\nADVERTENCIA: No se pudo generar el PDF del recibo. Error: ${pdfError.message}`);
                } else {
                    await sb.from('facturas').update({ url_pdf: pdfData.url }).eq('id', facturaId);
                    alert(`¬°Venta completada! Factura #${facturaId.substring(0, 8)} creada.`);
                    if (confirm("¬øDesea abrir el recibo en PDF para imprimir?")) {
                        window.open(pdfData.url, '_blank');
                    }
                }
                
                resetTerminal(true);

            } catch (error) {
                console.error("Error al completar la venta:", error);
                alert(`Error al finalizar la venta: ${error.message}`);
                btnCompletarVenta.textContent = "Completar Venta";
                btnCompletarVenta.disabled = false;
            }
        }
        
        async function generarReciboHTML(facturaId) {
            const { data: plantilla, error } = await sb.from('plantillas').select('cuerpo_html').eq('identificador_unico', 'RECIBO_IMPRESION').single();
            if (error || !plantilla) {
                console.error("No se encontr√≥ la plantilla de recibo.");
                return "<h1>Error: Plantilla de recibo no encontrada.</h1>";
            }

            let html = plantilla.cuerpo_html;

            const itemsHTML = carrito.map(p => `<tr><td style="padding: 5px;">${p.tracking}</td><td style="padding: 5px;">${(p.peso || 0).toFixed(2)} lbs</td><td style="text-align: right; padding: 5px;">$${((p.costo_flete||0)+(p.costo_impuestos||0)).toFixed(2)}</td></tr>`).join('');
            const desgloseItems = `<table width="100%" style="font-size: 12px; border-collapse: collapse;"><thead><tr style="background-color: #eee;"><th style="padding: 5px; text-align: left;">Tracking</th><th style="padding: 5px; text-align: left;">Peso</th><th style="padding: 5px; text-align: right;">Costo</th></tr></thead><tbody>${itemsHTML}</tbody></table>`;
            
            const pagosHTML = pagos.map(p => `<div>${p.metodo}: $${p.monto.toFixed(2)}</div>`).join('');

            html = html.replace(/{{fecha_factura}}/g, new Date().toLocaleDateString('es-PA'));
            html = html.replace(/{{numero_factura}}/g, facturaId.substring(0, 8).toUpperCase());
            html = html.replace(/{{nombre_cliente}}/g, clienteActual.nombre);
            html = html.replace(/{{box}}/g, clienteActual.box);
            html = html.replace(/{{desglose_items_html}}/g, desgloseItems);
            html = html.replace(/{{subtotal}}/g, subtotalCarritoSpan.textContent.replace('$', ''));
            html = html.replace(/{{descuentos}}/g, descuentosCarritoSpan.textContent.replace('-$', ''));
            html = html.replace(/{{total_pagado}}/g, totalCarritoSpan.textContent.replace('$', ''));
            html = html.replace(/{{metodos_pago_html}}/g, pagosHTML);
            
            return html;
        }

        function handlePago(metodo) {
            const total = parseFloat(totalCarritoSpan.textContent.replace('$', ''));
            const totalPagado = pagos.reduce((acc, p) => acc + p.monto, 0);
            const restante = total - totalPagado;
            if (restante <= 0.001) { alert("La cuenta ya est√° saldada."); return; }
            const montoStr = prompt(`Ingrese el monto a pagar con ${metodo}:`, restante.toFixed(2));
            const monto = parseFloat(montoStr);
            if (!isNaN(monto) && monto > 0 && monto <= restante + 0.001) {
                pagos.push({ metodo, monto });
                renderPagos();
                calcularTotal();
            } else { alert("Monto inv√°lido."); }
        }
        
        async function handleSuspendSaleSubmit() {
            const montoAbonado = pagos.reduce((acc, p) => acc + p.monto, 0);
            const total = parseFloat(totalCarritoSpan.textContent.replace('$', ''));
            let status = 'Suspendida';
            if (montoAbonado >= total - 0.001) status = 'Pagado';
            else if (montoAbonado > 0) status = 'Abonado';
            const payload = {
                cliente_box: clienteActual.box, cliente_nombre: clienteActual.nombre, status,
                carrito_data: carrito, descuento_general_porcentaje: descuentoGeneralPorcentaje,
                cupon_codigo: cuponAplicado ? cuponAplicado.codigo : null, monto_abonado: montoAbonado,
                pagos_data: pagos
            };
            if (ventaSuspendidaActual) {
                const { error } = await sb.from('ventas_suspendidas').update(payload).eq('id', ventaSuspendidaActual.id);
                if (error) { alert(`Error al actualizar la venta: ${error.message}`); } 
                else { alert(`Venta suspendida actualizada como: ${status}`); resetTerminal(true); }
            } else {
                const paqueteIds = carrito.map(p => p.id);
                const { error } = await sb.from('ventas_suspendidas').insert(payload);
                if (error) { alert(`Error al suspender la venta: ${error.message}`); } 
                else { 
                    await sb.rpc('cambiar_estado_paquetes', { p_paquete_ids: paqueteIds, p_nuevo_estado: 'suspendido' });
                    alert(`Venta suspendida como: ${status}`); resetTerminal(true); 
                }
            }
        }

        async function handleOpenLoadSuspendedModal() {
            suspendedSalesList.innerHTML = '<p>Cargando...</p>';
            loadSuspendedModal.classList.remove('hidden');
            try {
                const { data, error } = await sb.from('ventas_suspendidas').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                if (!data || data.length === 0) {
                    suspendedSalesList.innerHTML = '<p>No hay ventas suspendidas.</p>'; return;
                }
                suspendedSalesList.innerHTML = data.map(v => `<div class="border rounded-md p-3 mb-2 flex justify-between items-center"><div><p class="font-semibold">${v.cliente_nombre} (Box: ${v.cliente_box})</p><p class="text-sm text-slate-500">${new Date(v.created_at).toLocaleString('es-PA')}</p><p class="text-sm font-bold ${v.status === 'Pagado' ? 'text-green-600' : v.status === 'Abonado' ? 'text-blue-600' : ''}">${v.status}</p></div><div class="flex gap-2"><button data-id="${v.id}" class="btn-cancel-sale bg-red-500 text-white font-semibold py-1 px-3 rounded-md">Cancelar</button><button data-id="${v.id}" class="btn-load-sale bg-emerald-500 text-white font-semibold py-1 px-3 rounded-md">Cargar</button></div></div>`).join('');
            } catch (error) {
                console.error("Error al cargar ventas suspendidas:", error);
                suspendedSalesList.innerHTML = `<p class="text-red-500">Error: ${error.message}</p>`;
            }
        }
        
        async function handleLoadSuspendedSale(id) {
            const { data: suspendedSale, error } = await sb.from('ventas_suspendidas').select('*').eq('id', id).single();
            if (error || !suspendedSale) {
                alert("No se pudo cargar la venta suspendida.");
                return;
            }
            
            // MODIFICACI√ìN IMPORTANTE: No llamar a buscarCliente() que resetea todo.
            // Llamar a una versi√≥n que no reinicie los paquetes pendientes.
            await buscarClienteSinReseteo(String(suspendedSale.cliente_box));

            ventaSuspendidaActual = { ...suspendedSale, trackings_pendientes: suspendedSale.carrito_data.map(p => p.tracking) };
            
            const cartTrackings = new Set(suspendedSale.carrito_data.map(p => p.tracking));
            // Esta l√≠nea ahora funciona correctamente porque paquetesPendientes ya est√° cargado.
            paquetesPendientes = paquetesPendientes.filter(p => !cartTrackings.has(p.tracking)); 
            
            carrito = suspendedSale.carrito_data;
            pagos = suspendedSale.pagos_data || [];
            descuentoGeneralPorcentaje = suspendedSale.descuento_general_porcentaje || 0;
            modoVerificacion = true;
            
            renderPendientes();
            renderCarrito();
            renderPagos();
            renderVerificationList();
            
            btnCompletarVenta.disabled = true;
            btnSuspenderVenta.disabled = false;
            scanInput.placeholder = "ESCANEAR TODOS LOS PAQUETES PARA VERIFICAR...";
            loadSuspendedModal.classList.add('hidden');
        }

        // --- ¬°NUEVA FUNCI√ìN ASISTENTE! ---
        async function buscarClienteSinReseteo(searchTerm) {
            // No llama a resetTerminal()
            if (!searchTerm) return;
            const isNumeric = !isNaN(searchTerm);
            let query = sb.from('clientes').select('*');
            if (isNumeric) query = query.eq('box', parseInt(searchTerm));
            else query = query.ilike('nombre', `%${searchTerm}%`);
            const { data, error } = await query.limit(1).single();
            if (error || !data) { alert("Cliente no encontrado."); return; }
            clienteActual = data;
            
            const { data: paquetes, error: paquetesError } = await sb.rpc('get_paquetes_para_entrega', { p_cliente_box: clienteActual.box });
            if (paquetesError) { alert("Error al cargar paquetes del cliente."); console.error(paquetesError); return; }
            
            // Carga los paquetes pendientes en la variable global para que handleLoadSuspendedSale los pueda usar.
            paquetesPendientes = paquetes.map(p => ({ ...p, costo_flete: p.costo_total, costo_impuestos: 0, descuento_porcentaje: 0 }));

            clienteNombreTitulo.textContent = clienteActual.nombre;
            terminalContent.classList.remove('hidden');
            if (clienteActual.saldo_a_favor > 0) {
                creditBalanceSpan.textContent = `$${clienteActual.saldo_a_favor.toFixed(2)}`;
                creditPanel.classList.remove('hidden');
            }
            // No renderiza pendientes aqu√≠, lo har√° handleLoadSuspendedSale
            await loadPaymentMethods();
            scanInput.focus();
        }


        async function handleCancelSuspendedSale(ventaId) {
            if (!confirm("¬øCancelar venta? Los paquetes ser√°n liberados y los abonos ir√°n a cr√©dito.")) return;
            try {
                const { error } = await sb.rpc('cancelar_y_liberar_venta', { p_venta_id: ventaId });
                if (error) throw error;
                alert("Venta suspendida cancelada exitosamente.");
                await handleOpenLoadSuspendedModal();
            } catch (error) {
                console.error("Error al cancelar la venta:", error);
                alert(`No se pudo cancelar la venta: ${error.message}`);
            }
        }
        
        function resetTerminal(limpiarBuscador = false) {
            clienteActual=null; paquetesPendientes=[]; carrito=[]; pagos=[]; paqueteParaEditar=null;
            descuentoGeneralPorcentaje=0; cuponAplicado=null; ventaSuspendidaActual=null; modoVerificacion=false;
            terminalContent.classList.add('hidden');
            verificationPanel.classList.add('hidden');
            if (limpiarBuscador) searchClienteInput.value = '';
            cuponCodeInput.value = ''; cuponCodeInput.disabled = false;
            btnAplicarCupon.disabled = false;
            cuponMessage.textContent = '';
            creditPanel.classList.add('hidden');
            renderCarrito();
            renderPagos();
            btnCompletarVenta.textContent = "Completar Venta";
            scanInput.placeholder = "Esperando escaneo...";
        }

        function flashInputColor(className) {
            scanInput.classList.add(className);
            setTimeout(() => scanInput.classList.remove(className), 500);
        }

        document.addEventListener('DOMContentLoaded', () => {
            searchClienteInput.addEventListener('change', (e) => buscarCliente(e.target.value.trim()));
            scanInput.addEventListener('change', handleScan);
            btnCompletarVenta.addEventListener('click', completarVenta);
            carritoItemsDiv.addEventListener('click', e => {
                const deleteBtn = e.target.closest('.btn-delete-item');
                const editBtn = e.target.closest('.btn-edit-item');
                const discountBtn = e.target.closest('.btn-discount-item');
                if (deleteBtn) handleRemoveFromCart(deleteBtn.dataset.tracking);
                if (editBtn) handleOpenEditModal(editBtn.dataset.tracking);
                if (discountBtn) handleItemDiscount(discountBtn.dataset.tracking);
            });
            btnDescuentoGeneral.addEventListener('click', handleGeneralDiscount);
            btnAplicarCupon.addEventListener('click', handleAplicarCupon);
            btnSuspenderVenta.addEventListener('click', handleSuspendSaleSubmit);
            const btnCargarSuspendida = document.getElementById('btn-cargar-suspendida');
            if(btnCargarSuspendida) btnCargarSuspendida.addEventListener('click', handleOpenLoadSuspendedModal);
            document.getElementById('close-load-suspended-modal').addEventListener('click', () => loadSuspendedModal.classList.add('hidden'));
            suspendedSalesList.addEventListener('click', e => {
                const loadBtn = e.target.closest('.btn-load-sale');
                const cancelBtn = e.target.closest('.btn-cancel-sale');
                if (loadBtn) handleLoadSuspendedSale(loadBtn.dataset.id);
                if (cancelBtn) handleCancelSuspendedSale(cancelBtn.dataset.id);
            });
            paymentMethodsContainer.addEventListener('click', e => {
                const btn = e.target.closest('.payment-method-btn');
                if (btn) handlePago(btn.dataset.metodo);
            });
            if(formEditPeso) formEditPeso.addEventListener('submit', handleEditPesoSubmit);
            document.getElementById('close-edit-modal').addEventListener('click', () => editPesoModal.classList.add('hidden'));
            document.getElementById('cancel-edit-modal').addEventListener('click', () => editPesoModal.classList.add('hidden'));
            btnApplyCredit.addEventListener('click', handleApplyCredit);
            lucide.createIcons();
        });
    </script>
</body>
</html>
