<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGL1 - Terminal de Entrega</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="config.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-link.active { background-color: #ecfdf5; color: #059669; font-weight: 600; }
        .code { font-size: 13px; font-weight: 600; color: #94a3b8; margin-right: 12px; background-color: #f1f5f9; padding: 2px 8px; border-radius: 6px; }
        #sidebar { transition: transform 0.3s ease-in-out; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .scan-success { background-color: #dcfce7 !important; transition: background-color 0.3s; }
        .scan-error { background-color: #fee2e2 !important; transition: background-color 0.3s; }
        .modal-content { transition: all 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div class="relative min-h-screen md:flex">
        <div class="bg-white text-slate-800 flex justify-between md:hidden sticky top-0 z-20 shadow-md">
            <a href="./index.html" class="block p-4 font-bold">SGL1</a>
            <button id="mobile-menu-button" class="p-4 focus:outline-none focus:bg-slate-200">
                <svg class="h-6 w-6" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" /></svg>
            </button>
        </div>

        <div id="menu-container"></div>

        <main class="flex-1 p-8">
            <h1 class="text-3xl font-bold text-slate-900 flex items-center mb-6"><span class="code">[OP-05]</span>Terminal de Entrega</h1>
            
            <div class="bg-white p-6 rounded-lg border shadow-sm">
                <div class="max-w-xl mb-6">
                    <label class="block text-sm font-medium text-slate-600 mb-1">Buscar Cliente por Casillero o Nombre</label>
                    <input type="text" id="search-cliente" class="w-full text-lg p-2 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" placeholder="Inicia aqu√≠...">
                </div>

                <div id="terminal-content" class="hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        
                        <div>
                            <h2 class="text-xl font-bold text-slate-800 mb-2">Paquetes Pendientes de <span id="cliente-nombre-titulo"></span></h2>
                            <p class="mb-4 text-sm text-slate-500">Ubicados en los siguientes anaqueles. Escanee cada paquete para agregarlo al carrito.</p>
                            <div id="pendientes-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                                </div>
                        </div>

                        <div class="bg-slate-50 rounded-lg p-6">
                            <h2 class="text-xl font-bold text-slate-800 mb-4">üõí Carrito de Entrega</h2>
                            
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-slate-600 mb-1">Escanear Paquete</label>
                                <input type="text" id="scan-input" class="w-full text-base p-2 border-2 border-slate-400 rounded-lg" placeholder="Esperando escaneo...">
                            </div>
                            
                            <div id="carrito-items" class="space-y-3 mb-4 border-b pb-4">
                                <p class="text-slate-500">El carrito est√° vac√≠o.</p>
                            </div>
                            
                            <div class="space-y-2 text-lg mb-6">
                                <div class="flex justify-between font-bold text-3xl text-emerald-600">
                                    <span>TOTAL:</span>
                                    <span id="total-carrito">$0.00</span>
                                </div>
                            </div>
                            
                            <div id="pago-modulo">
                                <h3 class="text-lg font-semibold text-slate-700 mb-2">Registrar Pago</h3>
                                <div class="flex justify-between font-medium text-xl text-red-600 mb-4">
                                    <span>Restante:</span>
                                    <span id="pago-restante">$0.00</span>
                                </div>

                                <div class="grid grid-cols-2 gap-2 mb-4">
                                    <button data-metodo="Efectivo" class="payment-method-btn bg-sky-500 text-white p-2 rounded-md hover:bg-sky-600">Efectivo</button>
                                    <button data-metodo="Tarjeta" class="payment-method-btn bg-indigo-500 text-white p-2 rounded-md hover:bg-indigo-600">Tarjeta</button>
                                    <button data-metodo="Yappy" class="payment-method-btn bg-purple-500 text-white p-2 rounded-md hover:bg-purple-600">Yappy</button>
                                    <button data-metodo="Transferencia" class="payment-method-btn bg-gray-500 text-white p-2 rounded-md hover:bg-gray-600">Otro</button>
                                </div>
                                <div id="pagos-realizados-list" class="text-sm space-y-1 mb-4"></div>
                                <button id="btn-completar-venta" class="w-full bg-emerald-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-emerald-700 disabled:bg-slate-400 disabled:cursor-not-allowed" disabled>
                                    Completar Venta
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="edit-peso-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white w-full max-w-lg rounded-lg shadow-xl p-6 modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-slate-800">Ajustar Peso del Paquete</h2>
                <button id="close-edit-modal" class="text-slate-400 hover:text-slate-600 text-3xl font-bold">&times;</button>
            </div>
            <form id="form-edit-peso" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium">Tracking</label>
                    <p id="edit-peso-tracking" class="mt-1 p-2 bg-slate-100 rounded-md font-mono text-slate-700"></p>
                </div>
                <div>
                    <label for="edit-peso-nuevo" class="block text-sm font-medium">Nuevo Peso (lbs)</label>
                    <input id="edit-peso-nuevo" type="number" step="0.01" required class="w-full mt-1 p-2 border border-slate-300 rounded-md">
                </div>
                <div>
                    <label for="edit-peso-nota" class="block text-sm font-medium">Justificaci√≥n (Obligatorio)</label>
                    <textarea id="edit-peso-nota" required rows="3" class="w-full mt-1 p-2 border border-slate-300 rounded-md"></textarea>
                </div>
                <div>
                    <label for="edit-peso-foto" class="block text-sm font-medium">Foto en la Pesa (JPG Obligatorio)</label>
                    <input id="edit-peso-foto" type="file" accept="image/jpeg" required class="w-full mt-1 text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-emerald-50 file:text-emerald-700 hover:file:bg-emerald-100">
                </div>
                <p id="edit-peso-message" class="text-sm text-center h-5"></p>
                <div class="flex justify-end gap-4 pt-4 border-t">
                    <button type="button" id="cancel-edit-modal" class="bg-slate-100 text-slate-700 font-semibold py-2 px-4 rounded-md hover:bg-slate-200">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-blue-700">Guardar Ajuste</button>
                </div>
            </form>
        </div>
    </div>
    <script src="app.js"></script>
    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        const sb = createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);

        // --- Estado de la Aplicaci√≥n ---
        let clienteActual = null;
        let paquetesPendientes = [];
        let carrito = [];
        let pagos = [];
        let paqueteParaEditar = null; 

        // --- Elementos del DOM ---
        const searchClienteInput = document.getElementById('search-cliente');
        const terminalContent = document.getElementById('terminal-content');
        const clienteNombreTitulo = document.getElementById('cliente-nombre-titulo');
        const pendientesListDiv = document.getElementById('pendientes-list');
        const scanInput = document.getElementById('scan-input');
        const carritoItemsDiv = document.getElementById('carrito-items');
        const totalCarritoSpan = document.getElementById('total-carrito');
        const pagoRestanteSpan = document.getElementById('pago-restante');
        const pagosRealizadosList = document.getElementById('pagos-realizados-list');
        const btnCompletarVenta = document.getElementById('btn-completar-venta');
        const editPesoModal = document.getElementById('edit-peso-modal');
        const formEditPeso = document.getElementById('form-edit-peso');
        const editPesoTracking = document.getElementById('edit-peso-tracking');
        const editPesoNuevo = document.getElementById('edit-peso-nuevo');
        const editPesoNota = document.getElementById('edit-peso-nota');
        const editPesoFoto = document.getElementById('edit-peso-foto');
        const editPesoMessage = document.getElementById('edit-peso-message');
        
        // --- L√≥gica de Renderizado ---

        function renderPendientes() {
            if (paquetesPendientes.length === 0) {
                pendientesListDiv.innerHTML = '<p class="text-center text-slate-500 p-4">¬°No hay m√°s paquetes pendientes para este cliente!</p>';
                return;
            }
            const agrupados = paquetesPendientes.reduce((acc, p) => {
                const anaquel = p.anaquel || 'Sin Anaquel';
                if (!acc[anaquel]) acc[anaquel] = [];
                acc[anaquel].push(p);
                return acc;
            }, {});

            pendientesListDiv.innerHTML = Object.entries(agrupados).map(([anaquel, paquetes]) => `
                <div class="p-3 bg-slate-100 rounded-md">
                    <h4 class="font-bold text-slate-600 mb-2">üìç Anaquel: ${anaquel}</h4>
                    <div class="space-y-2">
                        ${paquetes.map(p => `
                            <div id="pendiente-${p.tracking}" class="p-2 border bg-white rounded flex justify-between items-center">
                                <span>${p.tracking}</span>
                                <span class="text-sm text-slate-500">${p.peso || 0} lbs</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }
        
        function renderCarrito() {
            if (carrito.length === 0) {
                carritoItemsDiv.innerHTML = '<p class="text-slate-500">El carrito est√° vac√≠o.</p>';
            } else {
                carritoItemsDiv.innerHTML = carrito.map(p => `
                    <div class="p-2.5 bg-white rounded-lg border flex justify-between items-center fade-in">
                        <div>
                            <p class="font-semibold">${p.tracking}</p>
                            <p class="text-xs text-slate-500">${(p.peso || 0).toFixed(2)} lbs</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="font-bold text-emerald-700">$${((p.costo_flete || 0) + (p.costo_impuestos || 0)).toFixed(2)}</span>
                            <button class="btn-edit-item text-slate-400 hover:text-blue-600" data-tracking="${p.tracking}" title="Editar Peso">
                                <i data-lucide="edit" class="h-4 w-4"></i>
                            </button>
                            <button class="btn-delete-item text-slate-400 hover:text-red-600" data-tracking="${p.tracking}" title="Eliminar del Carrito">
                                <i data-lucide="trash-2" class="h-4 w-4"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            calcularTotal();
            lucide.createIcons();
        }

        function renderPagos() {
            pagosRealizadosList.innerHTML = pagos.map(p => `
                <div class="flex justify-between bg-emerald-100 p-1 rounded-md">
                    <span>${p.metodo}:</span>
                    <span class="font-medium">$${p.monto.toFixed(2)}</span>
                </div>
            `).join('');
        }

        // --- L√≥gica de Negocio ---
        
        async function buscarCliente(searchTerm) {
            resetTerminal();
            if (!searchTerm) return;
            
            const isNumeric = !isNaN(searchTerm);
            let query = sb.from('clientes').select('*');
            if (isNumeric) query = query.eq('box', parseInt(searchTerm));
            else query = query.ilike('nombre', `%${searchTerm}%`);
            
            const { data, error } = await query.limit(1).single();

            if (error || !data) {
                alert("Cliente no encontrado.");
                return;
            }
            
            clienteActual = data;
            
            const { data: paquetes, error: paquetesError } = await sb.rpc('get_paquetes_para_entrega', { p_cliente_box: clienteActual.box });

            if (paquetesError) {
                alert("Error al cargar paquetes del cliente.");
                console.error(paquetesError);
                return;
            }
            
            paquetesPendientes = paquetes.map(p => ({ ...p, costo_flete: p.costo_total, costo_impuestos: 0 }));
            
            clienteNombreTitulo.textContent = clienteActual.nombre;
            terminalContent.classList.remove('hidden');
            terminalContent.classList.add('fade-in');
            renderPendientes();
            scanInput.focus();
        }
        
        function handleScan() {
            const tracking = scanInput.value.trim();
            if (!tracking) return;

            const paqueteIndex = paquetesPendientes.findIndex(p => p.tracking.toLowerCase() === tracking.toLowerCase());
            
            if (paqueteIndex > -1) {
                const [paquete] = paquetesPendientes.splice(paqueteIndex, 1);
                carrito.push(paquete);
                renderPendientes();
                renderCarrito();
                document.getElementById(`pendiente-${paquete.tracking}`)?.classList.add('line-through', 'text-slate-400');
                flashInputColor('scan-success');
            } else {
                alert(`Error: Paquete ${tracking} no est√° en la lista de pendientes o ya fue escaneado.`);
                flashInputColor('scan-error');
            }
            
            scanInput.value = '';
            scanInput.focus();
        }
        
        function handleRemoveFromCart(tracking) {
            const paqueteIndex = carrito.findIndex(p => p.tracking === tracking);
            if (paqueteIndex > -1) {
                const [paquete] = carrito.splice(paqueteIndex, 1);
                paquetesPendientes.push(paquete);
                renderCarrito();
                renderPendientes();
            }
        }
        
        function handleOpenEditModal(tracking) {
            const paquete = carrito.find(p => p.tracking === tracking);
            if (paquete) {
                paqueteParaEditar = paquete;
                formEditPeso.reset();
                editPesoMessage.textContent = '';
                editPesoTracking.textContent = paquete.tracking;
                editPesoNuevo.value = paquete.peso || 0;
                editPesoModal.classList.remove('hidden');
            }
        }

        async function handleEditPesoSubmit(e) {
            e.preventDefault();
            const submitButton = formEditPeso.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            editPesoMessage.textContent = 'Procesando...';
            editPesoMessage.className = 'text-sm text-center h-5 text-yellow-500';

            const nuevoPeso = parseFloat(editPesoNuevo.value);
            const nota = editPesoNota.value.trim();
            const foto = editPesoFoto.files[0];

            if (!nota || !foto || isNaN(nuevoPeso)) {
                editPesoMessage.textContent = 'Todos los campos son obligatorios.';
                editPesoMessage.className = 'text-sm text-center h-5 text-red-500';
                submitButton.disabled = false;
                return;
            }

            try {
                const filePath = `public/${paqueteParaEditar.tracking}-${Date.now()}.jpg`;
                const { error: uploadError } = await sb.storage.from('ajustes-peso').upload(filePath, foto, { contentType: 'image/jpeg' });
                if (uploadError) throw new Error(`Error al subir foto: ${uploadError.message}`);

                const { data: urlData } = sb.storage.from('ajustes-peso').getPublicUrl(filePath);
                if (!urlData) throw new Error("No se pudo obtener la URL de la foto.");
                
                const { error: rpcError } = await sb.rpc('update_paquete_peso', {
                    p_id: paqueteParaEditar.id,
                    p_peso: nuevoPeso,
                    p_nota: nota,
                    p_foto_url: urlData.publicUrl
                });
                if (rpcError) throw new Error(`Error al guardar en DB: ${rpcError.message}`);

                const { data: paqueteActualizado, error: fetchError } = await sb.rpc('get_paquetes_para_entrega', { p_cliente_box: clienteActual.box })
                    .eq('id', paqueteParaEditar.id)
                    .single();
                if (fetchError) throw new Error(`Error al refrescar datos: ${fetchError.message}`);

                const indexEnCarrito = carrito.findIndex(p => p.id === paqueteParaEditar.id);
                if (indexEnCarrito > -1) {
                    carrito[indexEnCarrito] = { ...paqueteActualizado, costo_flete: paqueteActualizado.costo_total, costo_impuestos: 0 };
                }

                editPesoMessage.textContent = '¬°Ajuste guardado con √©xito!';
                editPesoMessage.className = 'text-sm text-center h-5 text-green-500';
                setTimeout(() => {
                    editPesoModal.classList.add('hidden');
                    renderCarrito();
                }, 1500);

            } catch (error) {
                console.error("Error en ajuste de peso:", error);
                editPesoMessage.textContent = error.message;
                editPesoMessage.className = 'text-sm text-center h-5 text-red-500';
            } finally {
                submitButton.disabled = false;
            }
        }

        function calcularTotal() {
            const total = carrito.reduce((acc, p) => acc + (p.costo_flete || 0) + (p.costo_impuestos || 0), 0);
            const totalPagado = pagos.reduce((acc, p) => acc + p.monto, 0);
            const restante = total - totalPagado;

            totalCarritoSpan.textContent = `$${total.toFixed(2)}`;
            pagoRestanteSpan.textContent = `$${restante.toFixed(2)}`;
            btnCompletarVenta.disabled = carrito.length === 0 || restante > 0.001;
        }

        async function completarVenta() {
            if (btnCompletarVenta.disabled) return;
            btnCompletarVenta.textContent = "Procesando...";
            btnCompletarVenta.disabled = true;

            const montoTotal = carrito.reduce((acc, p) => acc + (p.costo_flete || 0) + (p.costo_impuestos || 0), 0);

            try {
                // L√≥gica para crear factura, items y pagos (sin cambios)
                const { data: factura, error: errFactura } = await sb.from('facturas').insert({ /* ... */ }).select().single();
                // ... resto de la l√≥gica ...

            } catch (error) {
                console.error("Error al completar la venta:", error);
                alert(`Error: ${error.message}`);
                btnCompletarVenta.textContent = "Completar Venta";
                btnCompletarVenta.disabled = false;
            }
        }
        
        function handlePago(metodo) {
             if (carrito.length === 0) {
                alert("Agregue paquetes al carrito antes de registrar un pago.");
                return;
            }
            const total = carrito.reduce((acc, p) => acc + (p.costo_flete || 0) + (p.costo_impuestos || 0), 0);
            const totalPagado = pagos.reduce((acc, p) => acc + p.monto, 0);
            const restante = total - totalPagado;

            if (restante <= 0) {
                alert("La cuenta ya est√° saldada.");
                return;
            }

            const montoStr = prompt(`Ingrese el monto a pagar con ${metodo}:`, restante.toFixed(2));
            const monto = parseFloat(montoStr);

            if (!isNaN(monto) && monto > 0 && monto <= restante + 0.001) {
                pagos.push({ metodo, monto });
                renderPagos();
                calcularTotal();
            } else {
                alert("Monto inv√°lido. No puede ser mayor al restante ni ser cero.");
            }
        }
        // --- Utilidades y Reseteo ---

        function resetTerminal(limpiarBuscador = false) {
            clienteActual = null;
            paquetesPendientes = [];
            carrito = [];
            pagos = [];
            
            terminalContent.classList.add('hidden');
            clienteNombreTitulo.textContent = '';
            pendientesListDiv.innerHTML = '';
            
            if (limpiarBuscador) searchClienteInput.value = '';
            
            renderCarrito();
            renderPagos();
            btnCompletarVenta.textContent = "Completar Venta";
        }

        function flashInputColor(className) {
            scanInput.classList.add(className);
            setTimeout(() => scanInput.classList.remove(className), 500);
        }

        // --- Inicializaci√≥n y Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            searchClienteInput.addEventListener('change', (e) => buscarCliente(e.target.value));
            scanInput.addEventListener('change', handleScan);
            
            document.querySelectorAll('.payment-method-btn').forEach(btn => {
                btn.addEventListener('click', () => handlePago(btn.dataset.metodo));
            });
            btnCompletarVenta.addEventListener('click', completarVenta);
            
            carritoItemsDiv.addEventListener('click', (e) => {
                const deleteBtn = e.target.closest('.btn-delete-item');
                const editBtn = e.target.closest('.btn-edit-item');
                if (deleteBtn) {
                    handleRemoveFromCart(deleteBtn.dataset.tracking);
                }
                if (editBtn) {
                    handleOpenEditModal(editBtn.dataset.tracking);
                }
            });
            
            formEditPeso.addEventListener('submit', handleEditPesoSubmit);
            document.getElementById('close-edit-modal').addEventListener('click', () => editPesoModal.classList.add('hidden'));
            document.getElementById('cancel-edit-modal').addEventListener('click', () => editPesoModal.classList.add('hidden'));

            lucide.createIcons();
        });

    </script>
</body>
</html>
