<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal de Entrega Interactivo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="config.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Animaciones para el escaneo y el movimiento de paquetes */
        .paquete-item { transition: all 0.3s ease-in-out; }
        .paquete-picked { opacity: 0; transition: all 0.5s ease-out; height: 0; padding: 0 !important; margin: 0 !important; border: none !important; }
        /* Feedback visual en el campo de esc√°ner */
        .input-focus-flash { border-color: #3b82f6 !important; box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5); }
        .input-error-flash { border-color: #ef4444 !important; }
        .input-error-flash::placeholder { color: #dc2626; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="min-h-screen p-4 md:p-8">
        <header class="mb-6">
            <h1 class="text-3xl font-bold text-slate-900 mb-2">Terminal de Entrega Interactivo</h1>
            <input type="text" id="input-busqueda-cliente" placeholder="üìç Iniciar: Buscar por Casillero o Nombre..." class="w-full text-lg p-3 border-2 border-slate-300 rounded-lg focus:border-indigo-500 focus:ring-1 focus:ring-indigo-500 transition-colors">
            <div id="cliente-info" class="mt-3 text-base bg-white p-3 rounded-lg border shadow-sm hidden"></div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:h-[calc(100vh-160px)]">

            <section id="panel-izquierdo" class="lg:col-span-2 bg-white p-6 rounded-lg border shadow-lg flex flex-col h-full">
                <h2 class="text-xl font-semibold text-slate-700 mb-4 flex-shrink-0">üì¶ Almac√©n del Cliente: Paquetes Pendientes</h2>
                
                <div class="mb-4 flex-shrink-0">
                    <input type="text" id="input-escaner" placeholder="üöÄ Escanea el Paquete (Tracking o ID) ¬°BEEP!" class="w-full text-xl p-3 border-2 border-slate-400 rounded-lg bg-slate-100 font-mono focus:outline-none focus:ring-4 focus:ring-blue-100 transition-all" disabled>
                </div>

                <div id="lista-anaqueles" class="overflow-y-auto flex-grow pr-2">
                    <p class="text-slate-500 text-center p-8">Busca un cliente para cargar sus paquetes pendientes.</p>
                </div>
            </section>

            <section id="panel-derecho" class="lg:col-span-1 bg-white p-6 rounded-lg border shadow-lg flex flex-col h-full sticky top-4">
                <h2 class="text-xl font-semibold text-slate-700 mb-4 flex-shrink-0">üõí Carrito de Entrega</h2>

                <div id="carrito-items" class="overflow-y-auto flex-grow space-y-3 mb-6 border-b pb-4">
                    <p class="text-slate-500 text-center p-4">Los paquetes escaneados aparecer√°n aqu√≠.</p>
                </div>

                <div id="resumen-pago" class="flex-shrink-0">
                    <div class="space-y-2 text-lg">
                        <div class="flex justify-between"><span>Flete:</span> <span id="subtotal-flete" class="font-medium">$0.00</span></div>
                        <div class="flex justify-between"><span>Impuestos:</span> <span id="subtotal-impuestos" class="font-medium">$0.00</span></div>
                        <hr class="my-2 border-slate-300">
                        <div class="flex justify-between text-2xl font-bold text-slate-800"><span>TOTAL:</span> <span id="total-pagar">$0.00</span></div>
                    </div>
                    
                    <hr class="my-4 border-slate-200">

                    <div id="area-pagos-realizados" class="mb-4 space-y-1 text-sm">
                        </div>

                    <div class="flex justify-between items-center mb-3">
                        <h4 class="text-xl font-bold text-indigo-600">Monto Restante:</h4> 
                        <span id="monto-restante" class="text-2xl font-extrabold text-indigo-600">$0.00</span>
                    </div>

                    <div id="metodos-pago" class="grid grid-cols-3 gap-2 mb-4">
                        <button class="btn-pago bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 disabled:opacity-50" data-metodo="Efectivo" disabled>üí∞ Efectivo</button>
                        <button class="btn-pago bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 disabled:opacity-50" data-metodo="Tarjeta" disabled>üí≥ Tarjeta</button>
                        <button class="btn-pago bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 disabled:opacity-50" data-metodo="Yappy" disabled>üì± Yappy</button>
                        <button class="btn-pago bg-blue-500 text-white py-2 rounded-lg hover:bg-blue-600 disabled:opacity-50" data-metodo="Transferencia" disabled>üè¶ Transferencia</button>
                        </div>

                    <div id="modulo-ingreso-pago" class="p-3 bg-indigo-50 rounded-lg mb-4 hidden">
                        <label class="block text-sm font-semibold mb-1" id="pago-label"></label>
                        <div class="flex gap-2">
                            <input type="number" id="monto-ingresado" placeholder="0.00" step="0.01" class="flex-grow p-2 border rounded-lg text-lg">
                            <button id="btn-registrar-pago" class="bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700">Registrar</button>
                        </div>
                        <button type="button" id="btn-cancelar-pago" class="text-xs text-slate-500 mt-1 hover:underline">Cancelar</button>
                    </div>

                    <button id="btn-completar-venta" class="w-full bg-emerald-500 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-emerald-600 disabled:bg-slate-300 disabled:cursor-not-allowed" disabled>
                        ‚úÖ Completar Venta y Entregar
                    </button>
                    <button id="btn-imprimir-recibo" class="w-full mt-2 bg-slate-300 text-slate-800 font-semibold py-2 rounded-lg hover:bg-slate-400 hidden">
                        üñ®Ô∏è Imprimir Recibo
                    </button>
                </div>
            </section>
        </div>
    </div>
    
    <div id="custom-alert" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white w-full max-w-md rounded-lg shadow-xl p-6 text-center">
            <p id="custom-alert-message" class="text-slate-700 mb-4">Mensaje.</p>
            <button id="custom-alert-close" class="bg-emerald-500 text-white font-semibold py-2 px-6 rounded-md hover:bg-emerald-600">Entendido</button>
        </div>
    </div>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        // --- Elementos del DOM ---
        const inputBusquedaCliente = document.getElementById('input-busqueda-cliente');
        const clienteInfoDiv = document.getElementById('cliente-info');
        const inputEscaner = document.getElementById('input-escaner');
        const listaAnaquelesDiv = document.getElementById('lista-anaqueles');
        const carritoItemsDiv = document.getElementById('carrito-items');
        const subtotalFleteSpan = document.getElementById('subtotal-flete');
        const subtotalImpuestosSpan = document.getElementById('subtotal-impuestos');
        const totalPagarSpan = document.getElementById('total-pagar');
        const montoRestanteSpan = document.getElementById('monto-restante');
        const areaPagosRealizados = document.getElementById('area-pagos-realizados');
        const metodosPagoBtns = document.querySelectorAll('.btn-pago');
        const moduloIngresoPago = document.getElementById('modulo-ingreso-pago');
        const montoIngresadoInput = document.getElementById('monto-ingresado');
        const btnRegistrarPago = document.getElementById('btn-registrar-pago');
        const btnCancelarPago = document.getElementById('btn-cancelar-pago');
        const btnCompletarVenta = document.getElementById('btn-completar-venta');
        const pagoLabel = document.getElementById('pago-label');
        const btnImprimirRecibo = document.getElementById('btn-imprimir-recibo');
        const customAlert = document.getElementById('custom-alert');
        const customAlertClose = document.getElementById('custom-alert-close');
        
        // --- Estado Global ---
        let sb;
        let clienteActual = null;
        let paquetesDisponibles = []; // Paquetes pendientes en el almac√©n del cliente
        let carritoPaquetes = []; // Paquetes que el cliente seleccion√≥ (escaneados)
        let pagosRealizados = []; // [{ metodo: 'Efectivo', monto: 10.00 }]
        let montoTotalVenta = 0;
        let metodoPagoActual = null; // Para la gesti√≥n de pagos divididos

        // --- Funciones de Utilidad ---
        function showAlert(message) {
            document.getElementById('custom-alert-message').textContent = message;
            customAlert.classList.remove('hidden');
        }

        customAlertClose.onclick = () => customAlert.classList.add('hidden');

        // La funci√≥n principal de c√°lculo y actualizaci√≥n de la UI
        function actualizarResumen() {
            let fleteTotal = carritoPaquetes.reduce((acc, p) => acc + (parseFloat(p.costo_flete) || 0), 0);
            let impuestosTotal = carritoPaquetes.reduce((acc, p) => acc + (parseFloat(p.costo_impuestos) || 0), 0);
            
            montoTotalVenta = fleteTotal + impuestosTotal;
            const montoPagado = pagosRealizados.reduce((acc, p) => acc + p.monto, 0);
            const montoRestante = montoTotalVenta - montoPagado;

            subtotalFleteSpan.textContent = `$${fleteTotal.toFixed(2)}`;
            subtotalImpuestosSpan.textContent = `$${impuestosTotal.toFixed(2)}`;
            totalPagarSpan.textContent = `$${montoTotalVenta.toFixed(2)}`;
            
            // Mostrar monto restante y cambio (si es negativo)
            const displayRestante = montoRestante <= 0 ? (montoRestante * -1).toFixed(2) : montoRestante.toFixed(2);
            montoRestanteSpan.textContent = montoRestante <= 0 ? `-$${displayRestante}` : `$${displayRestante}`;
            montoRestanteSpan.classList.toggle('text-red-600', montoRestante > 0);
            montoRestanteSpan.classList.toggle('text-indigo-600', montoRestante <= 0);

            // Deshabilitar botones de pago si el carrito est√° vac√≠o
            metodosPagoBtns.forEach(btn => btn.disabled = carritoPaquetes.length === 0);
            
            // Habilitar venta solo si hay paquetes y el monto restante es <= 0
            btnCompletarVenta.disabled = !(carritoPaquetes.length > 0 && montoRestante <= 0);
        }
        
        function resetTodo() {
            clienteActual = null;
            paquetesDisponibles = [];
            carritoPaquetes = [];
            pagosRealizados = [];
            montoTotalVenta = 0;
            
            inputBusquedaCliente.value = '';
            clienteInfoDiv.classList.add('hidden');
            inputEscaner.value = '';
            inputEscaner.disabled = true;
            listaAnaquelesDiv.innerHTML = '<p class="text-slate-500 text-center p-8">Busca un cliente para cargar sus paquetes pendientes.</p>';
            carritoItemsDiv.innerHTML = '<p class="text-slate-500 text-center p-4">Los paquetes escaneados aparecer√°n aqu√≠.</p>';
            areaPagosRealizados.innerHTML = '';
            moduloIngresoPago.classList.add('hidden');
            btnCompletarVenta.classList.remove('hidden');
            btnImprimirRecibo.classList.add('hidden');
            
            actualizarResumen();
            inputBusquedaCliente.focus(); // Empezar de nuevo
        }
        
        function feedbackVisual(element, type) {
            const className = type === 'success' ? 'input-focus-flash' : 'input-error-flash';
            // Simular audio si es necesario: new Audio('beep.mp3').play();
            
            element.classList.add(className);
            
            setTimeout(() => {
                element.classList.remove(className);
                element.focus();
            }, 500); // Duraci√≥n de la animaci√≥n
        }
        
        function fmtDateDisplay(iso) {
            if (!iso) return "N/A";
            try {
                const d = new Date(iso);
                return d.toLocaleDateString("es-PA", { day: "2-digit", month: "2-digit", year: "2-digit" });
            } catch { return "N/A"; }
        }

        // --- L√≥gica del Cliente y Paquetes ---

        inputBusquedaCliente.addEventListener('change', async (e) => {
            const searchTerm = e.target.value.trim();
            if (!searchTerm) return;
            
            // 1. Resetear el estado para la nueva b√∫squeda
            resetTodo(); 

            // 2. Buscar Cliente
            const isNumeric = !isNaN(searchTerm);
            // Incluimos tarifas para el c√°lculo del flete (asumimos tarifas est√°n relacionadas 1 a 1 o 1 a muchos y se toma la primera)
            let query = sb.from('clientes').select('*, tarifas:tarifa_clientes(*)'); 
            if (isNumeric) {
                query = query.eq('box', parseInt(searchTerm));
            } else {
                query = query.ilike('nombre', `%${searchTerm}%`);
            }
            
            const { data, error } = await query.limit(1).single();

            if (error || !data) {
                showAlert("Cliente no encontrado.");
                return;
            }
            
            // Cargar tarifas del cliente si existen (usamos tarifa_1 como tarifa base)
            const tarifaPorPeso = data.tarifas?.[0]?.tarifa_1 || 5.00;
            const clienteData = { ...data, tarifa_por_peso: tarifaPorPeso }; 
            
            clienteActual = clienteData;
            mostrarInfoCliente(clienteData);
            await buscarPaquetesCliente(clienteData.box, tarifaPorPeso);
            
            inputEscaner.disabled = false;
            inputEscaner.focus(); // Pasar foco al escaner
        });

        function mostrarInfoCliente(cliente) {
            clienteInfoDiv.innerHTML = `
                <p><strong>Cliente:</strong> ${cliente.nombre}</p>
                <p><strong>Casillero (Box):</strong> ${cliente.box} | <strong>Tarifa Base:</strong> $${cliente.tarifa_por_peso.toFixed(2)}</p>
            `;
            clienteInfoDiv.classList.remove('hidden');
        }

        async function buscarPaquetesCliente(clienteBox, tarifaPorPeso) {
            // Buscamos paquetes que est√©n en sucursal y a√∫n no hayan sido facturados
            const { data: paquetes, error } = await sb.from('paquetes')
                .select('*')
                .eq('cliente_box', clienteBox)
                .eq('status', 'En Sucursal')
                .is('factura_id', null)
                .order('anaquel', { ascending: true })
                .order('tracking', { ascending: true });

            if (error) {
                showAlert("Error al buscar los paquetes del cliente.");
                return;
            }

            paquetesDisponibles = paquetes.map(p => ({
                ...p,
                // Pre-calcular costos si no existen
                costo_flete: (p.costo_flete || (p.peso * tarifaPorPeso) || 0).toFixed(2),
                costo_impuestos: (p.costo_impuestos || 0).toFixed(2),
            }));
            
            mostrarPaquetesEnAlmacen(paquetesDisponibles);
        }
        
        function mostrarPaquetesEnAlmacen(paquetes) {
            if (paquetes.length === 0) {
                listaAnaquelesDiv.innerHTML = '<p class="text-slate-500 text-center p-8">Este cliente no tiene paquetes pendientes de pago.</p>';
                return;
            }

            // Agrupar por anaquel
            const agrupados = paquetes.reduce((acc, p) => {
                const anaquel = p.anaquel || 'S/N';
                if (!acc[anaquel]) acc[anaquel] = [];
                acc[anaquel].push(p);
                return acc;
            }, {});
            
            let html = '';
            const sortedAnaqueles = Object.keys(agrupados).sort();

            for (const anaquel of sortedAnaqueles) {
                html += `<div class="mb-4">
                    <h3 class="text-sm font-bold text-indigo-700 bg-indigo-100 p-2 rounded-t-lg">Anaquel: ${anaquel} (${agrupados[anaquel].length} pqt)</h3>
                    <div class="border border-indigo-200 rounded-b-lg p-3 space-y-2">`;
                
                html += agrupados[anaquel].map(p => `
                    <div id="paquete-${p.id}" data-tracking="${p.tracking}" class="paquete-item border p-2 rounded-lg flex justify-between items-center bg-white hover:bg-slate-50">
                        <div>
                            <p class="font-semibold text-base">${p.tracking}</p>
                            <p class="text-xs text-slate-500">
                                Box: ${p.cliente_box} | Peso: ${p.peso || 'N/A'} lbs | Recibido: ${fmtDateDisplay(p.fecha_sucursal)}
                            </p>
                        </div>
                    </div>
                `).join('');
                
                html += `</div></div>`;
            }
            listaAnaquelesDiv.innerHTML = html;
            carritoItemsDiv.innerHTML = '<p class="text-slate-500 text-center p-4">Los paquetes escaneados aparecer√°n aqu√≠.</p>';
        }

        // --- L√≥gica del Escaneo (Core del Terminal) ---

        inputEscaner.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault(); // Evitar el submit
                procesarEscaneo(inputEscaner.value.trim());
            }
        });
        
        async function procesarEscaneo(codigo) {
            inputEscaner.value = ''; // Limpiar el campo inmediatamente
            
            if (!clienteActual) {
                feedbackVisual(inputEscaner, 'error');
                showAlert('Primero debe buscar y seleccionar un cliente.');
                return;
            }

            // 1. Buscar el paquete en los paquetes disponibles del cliente por tracking o ID
            const paquete = paquetesDisponibles.find(p => p.tracking === codigo || p.id == codigo);
            
            if (!paquete) {
                feedbackVisual(inputEscaner, 'error');
                showAlert(`Paquete "${codigo}" no encontrado o no pertenece a este cliente.`);
                return; 
            }
            
            // 2. Verificar si ya est√° en el carrito
            if (carritoPaquetes.some(p => p.id === paquete.id)) {
                feedbackVisual(inputEscaner, 'error');
                showAlert("Este paquete ya fue escaneado y est√° en el carrito.");
                return;
            }

            // 3. Procesar: Mover al carrito
            
            // Quitar de la lista de pendientes (visual y funcionalmente)
            const paqueteElement = document.getElementById(`paquete-${paquete.id}`);
            if (paqueteElement) {
                paqueteElement.classList.add('paquete-picked');
            }
            
            // Agregar al carrito
            carritoPaquetes.push(paquete);
            mostrarPaqueteEnCarrito(paquete);
            
            // Feedback
            feedbackVisual(inputEscaner, 'success');
            
            // Recalcular
            actualizarResumen();
        }
        
        function mostrarPaqueteEnCarrito(paquete) {
            if (carritoPaquetes.length === 1) {
                carritoItemsDiv.innerHTML = ''; // Limpiar el mensaje de "vac√≠o"
            }
            
            const totalItem = (parseFloat(paquete.costo_flete) + parseFloat(paquete.costo_impuestos)).toFixed(2);

            const itemHtml = `
                <div id="carrito-item-${paquete.id}" class="bg-white border p-3 rounded-lg flex justify-between items-center shadow-sm">
                    <div>
                        <p class="font-bold text-base text-slate-700">${paquete.tracking}</p>
                        <p class="text-xs text-slate-500">Flete: $${paquete.costo_flete} | Impuestos: $${paquete.costo_impuestos}</p>
                    </div>
                    <div class="flex items-center gap-2">
                        <button type="button" data-remove-id="${paquete.id}" class="text-red-500 hover:text-red-700 text-lg leading-none font-bold"> &times; </button>
                        <div class="text-lg font-semibold text-emerald-600">$${totalItem}</div>
                    </div>
                </div>
            `;
            carritoItemsDiv.insertAdjacentHTML('beforeend', itemHtml);
            
            // Listener para quitar del carrito
            document.querySelector(`[data-remove-id="${paquete.id}"]`).addEventListener('click', (e) => {
                quitarPaqueteDelCarrito(e.target.dataset.removeId);
            });
        }
        
        function quitarPaqueteDelCarrito(paqueteId) {
            const id = parseInt(paqueteId);
            
            // 1. Quitar del carritoPaquetes
            const paqueteQuitadoIndex = carritoPaquetes.findIndex(p => p.id === id);
            if (paqueteQuitadoIndex === -1) return;
            const paqueteQuitado = carritoPaquetes.splice(paqueteQuitadoIndex, 1)[0];
            
            // 2. Quitar visualmente del carrito
            const carritoElement = document.getElementById(`carrito-item-${id}`);
            if (carritoElement) carritoElement.remove();
            
            // 3. Devolver a la lista de pendientes (visual y funcionalmente)
            if (paqueteQuitado) {
                // Agregar paquete quitado a la lista de disponibles (para que pueda volver a escanearse)
                paquetesDisponibles.push(paqueteQuitado);
                // Volver a renderizar toda la lista de anaqueles para que aparezca en el orden correcto
                mostrarPaquetesEnAlmacen(paquetesDisponibles); 
            }
            
            // Si el carrito queda vac√≠o, mostrar mensaje
            if (carritoPaquetes.length === 0) {
                carritoItemsDiv.innerHTML = '<p class="text-slate-500 text-center p-4">Los paquetes escaneados aparecer√°n aqu√≠.</p>';
                pagosRealizados = []; // Limpiar pagos si el carrito est√° vac√≠o
                areaPagosRealizados.innerHTML = '';
            }

            // 4. Recalcular
            actualizarResumen();
            inputEscaner.focus();
        }

        // --- L√≥gica del Pago Dividido ---

        metodosPagoBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                if (carritoPaquetes.length === 0) {
                    showAlert("Primero escanee los paquetes para iniciar el cobro.");
                    return;
                }
                
                metodoPagoActual = e.target.dataset.metodo;
                const montoPendiente = montoTotalVenta - pagosRealizados.reduce((acc, p) => acc + p.monto, 0);

                if (montoPendiente <= 0) {
                     showAlert("El monto total ya ha sido cubierto. Presione 'Completar Venta'.");
                     metodoPagoActual = null;
                     return;
                }
                
                pagoLabel.textContent = `Monto a pagar con ${metodoPagoActual}:`;
                // Se autocompleta con el restante pendiente
                montoIngresadoInput.value = Math.max(0, montoPendiente).toFixed(2); 
                moduloIngresoPago.classList.remove('hidden');
                montoIngresadoInput.focus();
            });
        });
        
        btnCancelarPago.addEventListener('click', () => {
            moduloIngresoPago.classList.add('hidden');
            metodoPagoActual = null;
            inputEscaner.focus();
        });

        btnRegistrarPago.addEventListener('click', () => {
            const monto = parseFloat(montoIngresadoInput.value);
            
            if (isNaN(monto) || monto <= 0) {
                showAlert("Ingrese un monto v√°lido y positivo.");
                return;
            }
            
            // Se permite pagar m√°s del total, para manejar el cambio
            
            pagosRealizados.push({ metodo: metodoPagoActual, monto: monto });
            
            // Actualizar lista de pagos
            const pagoHtml = `<p class="text-sm font-medium"><span class="text-indigo-500 mr-2">${metodoPagoActual}:</span> $${monto.toFixed(2)}</p>`;
            areaPagosRealizados.insertAdjacentHTML('beforeend', pagoHtml);
            
            moduloIngresoPago.classList.add('hidden');
            actualizarResumen();
            inputEscaner.focus(); // Devolver el foco al escaner/terminal
        });

        // --- 4. REGISTRAR VENTA Y FACTURAR ---
        
        btnCompletarVenta.addEventListener('click', async () => {
            const montoTotal = parseFloat(totalPagarSpan.textContent.replace('$', ''));
            const montoPagado = pagosRealizados.reduce((acc, p) => acc + p.monto, 0);
            
            if (montoPagado < montoTotal) {
                 showAlert("El monto total no ha sido cubierto. Por favor, registre el pago restante.");
                 return;
            }
            
            const cambio = Math.max(0, montoPagado - montoTotal);
            
            if (cambio > 0) {
                const confirmar = confirm(`El monto pagado es $${montoPagado.toFixed(2)}. Debe entregar un CAMBIO de $${cambio.toFixed(2)}. ¬øDesea confirmar la venta?`);
                if (!confirmar) return;
            }

            btnCompletarVenta.disabled = true;
            btnCompletarVenta.textContent = 'Procesando...';

            try {
                // 1. Crear la Factura (Encabezado)
                const { data: facturaData, error: facturaError } = await sb.from('facturas')
                    .insert({
                        cliente_box: clienteActual.box,
                        cliente_nombre: clienteActual.nombre,
                        monto_total: montoTotal,
                        monto_pagado: montoPagado, 
                        monto_cambio: cambio, 
                        status: 'Pagada',
                    }).select().single();

                if (facturaError) throw facturaError;
                const nuevaFacturaId = facturaData.id;

                // 2. Insertar Pagos Divididos
                const pagosParaInsertar = pagosRealizados.map(p => ({
                    factura_id: nuevaFacturaId,
                    monto_pagado: p.monto,
                    metodo_pago: p.metodo,
                }));
                const pagosResult = await sb.from('pagos_factura').insert(pagosParaInsertar);
                if (pagosResult.error) throw pagosResult.error;

                // 3. Crear los Items de la Factura y actualizar los Paquetes
                const paquetesParaActualizar = carritoPaquetes.map(p => ({
                    id: p.id,
                    status: 'Entregado',
                    factura_id: nuevaFacturaId,
                    costo_flete: parseFloat(p.costo_flete),
                    costo_impuestos: parseFloat(p.costo_impuestos),
                }));
                
                const paquetesResult = await sb.from('paquetes').upsert(paquetesParaActualizar);
                if (paquetesResult.error) throw paquetesResult.error;

                
                // --- Finalizaci√≥n Exitosa ---
                btnCompletarVenta.classList.add('hidden');
                btnImprimirRecibo.classList.remove('hidden');
                btnImprimirRecibo.onclick = () => showAlert(`Simulando impresi√≥n de Factura #${nuevaFacturaId}...`);
                
                showAlert(`‚úÖ Venta completada. Factura #${nuevaFacturaId}. Cambio a entregar: $${cambio.toFixed(2)}.`);
                
                // Reiniciar inmediatamente para el pr√≥ximo cliente
                setTimeout(resetTodo, 1000); 

            } catch (error) {
                console.error("Error al facturar:", error);
                showAlert(`üî¥ Error al procesar la factura: ${error.message}`);
                btnCompletarVenta.disabled = false;
                btnCompletarVenta.textContent = 'Reintentar Venta';
            }
        });


        // --- Inicializaci√≥n ---

        document.addEventListener('DOMContentLoaded', () => {
             try {
                // Inicializar Supabase
                sb = createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);
            } catch (e) {
                console.error("Error al inicializar Supabase. Verifica tu config.js", e);
                showAlert("Error cr√≠tico: No se pudo conectar a la base de datos.");
                return;
            }
            
            // Asegurar que el foco est√© siempre en el esc√°ner (o en el input de b√∫squeda si est√° vac√≠o)
            document.body.addEventListener('click', (e) => {
                // Si el m√≥dulo de pago est√° visible, no robar el foco del input de monto
                if (!moduloIngresoPago.classList.contains('hidden')) {
                    return;
                }
                // Si la b√∫squeda inicial est√° activa, enfocamos ah√≠
                if (!clienteActual) {
                    inputBusquedaCliente.focus();
                } 
                // Si ya hay cliente, enfocamos en el esc√°ner
                else if (e.target !== inputBusquedaCliente && e.target !== inputEscaner) {
                    inputEscaner.focus();
                }
            });

            // Configurar el input de b√∫squeda como inicio
            inputBusquedaCliente.focus();
        });
    </script>
</body>
</html>
