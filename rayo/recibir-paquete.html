<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGL1 - Recibir Paquete (con Escáner)</title>
    
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="config.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .code { font-size: 13px; font-weight: 600; color: #94a3b8; margin-right: 12px; background-color: #f1f5f9; padding: 2px 8px; border-radius: 6px; }
        .form-section { transition: all 0.5s ease-in-out; max-height: 0; opacity: 0; overflow: hidden; transform: translateY(-10px); }
        .form-section.visible { max-height: 1000px; opacity: 1; transform: translateY(0); margin-top: 1.5rem; }
        .info-grid-item { background-color: #f8fafc; padding: 8px 12px; border-radius: 6px; border: 1px solid #e2e8f0; }
        .info-grid-label { font-size: 12px; color: #64748b; font-weight: 500; }
        .info-grid-value { font-size: 14px; color: #0f172a; font-weight: 600; }
        #video-feed, #barcode-reader { border-radius: 0.5rem; width: 100%; background-color: #000; }
        
        .autocomplete-suggestions {
            position: absolute;
            border: 1px solid #e2e8f0;
            background-color: white;
            width: 100%;
            max-height: 150px;
            overflow-y: auto;
            z-index: 100;
            border-radius: 0 0 0.375rem 0.375rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .suggestion-item {
            padding: 8px 12px;
            cursor: pointer;
        }
        .suggestion-item:hover {
            background-color: #f1f5f9;
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="relative min-h-screen md:flex">
        <div id="menu-container"></div>

        <main class="flex-1 p-4 md:p-8">
            <div class="flex flex-col md:flex-row md:justify-between md:items-center mb-8">
                <h1 class="text-2xl md:text-3xl font-bold text-slate-900 flex items-center mb-4 md:mb-0"><span class="code">[OP-03A]</span>Recepción de Paquete</h1>
                <div class="flex gap-2 md:gap-4 w-full md:w-auto">
                    <button id="casos-especiales-btn" class="flex-1 bg-amber-500 text-white font-semibold py-2 px-3 rounded-md hover:bg-amber-600 text-sm md:text-base">Registrar Caso Especial</button>
                    <button id="add-manual-btn" class="flex-1 bg-blue-500 text-white font-semibold py-2 px-3 rounded-md hover:bg-blue-600 text-sm md:text-base">Agregar Manual</button>
                </div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <form id="form-recibir" class="bg-white p-6 md:p-8 rounded-lg border border-slate-200 shadow-sm">
                        <div>
                            <label for="tracking-main" class="block text-lg font-semibold text-slate-700 mb-2">1. Tracking Principal</label>
                            <div class="relative flex items-center">
                                <input type="text" id="tracking-main" placeholder="Ingresar o escanear..." class="w-full text-lg pl-4 pr-24 md:pr-32 py-3 border-2 border-slate-300 rounded-lg">
                                <div class="absolute right-2 flex items-center gap-1">
                                    <button type="button" id="scan-tracking-barcode-btn" class="p-2 text-slate-500 hover:text-indigo-600 rounded-full hover:bg-indigo-100" title="Escanear Código de Barras">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v1m6 11h2m-6.5 6.5l-1.5-1.5M4 12H2m13.5-6.5l-1.5 1.5M12 20v-1m0-10V4m0 18a9 9 0 110-18 9 9 0 010 18z" /></svg>
                                    </button>
                                    <button type="button" data-target="tracking-main" class="scan-ocr-btn p-2 text-slate-500 hover:text-indigo-600 rounded-full hover:bg-indigo-100" title="Escanear Etiqueta (OCR)">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div id="casos-especiales-container" class="hidden mt-6 p-4 bg-amber-50 border border-amber-200 rounded-lg space-y-6">
                            <div>
                                <h3 class="font-bold text-amber-800">Registro de Paquete Mal Identificado</h3>
                                <p class="text-xs text-amber-600 mb-2">Al escanear aquí, el paquete se registrará automáticamente.</p>
                                <div class="mt-2">
                                    <label for="mal-identificado-input" class="block text-sm font-medium text-slate-600 mb-1">Escanear Tracking Mal Identificado</label>
                                    <input type="text" id="mal-identificado-input" placeholder="Escanear aquí para registro automático..." class="w-full p-2 border border-slate-300 rounded-md">
                                </div>
                            </div>
                            
                            <div>
                                 <h3 class="font-bold text-amber-800">Registro de Filtro</h3>
                                 <div class="flex flex-col md:grid md:grid-cols-2 gap-4 mt-2 items-end">
                                     <div>
                                        <label for="filtros-tracking-input" class="block text-sm font-medium text-slate-600 mb-1">Tracking a Filtrar</label>
                                        <input type="text" id="filtros-tracking-input" class="w-full p-2 border border-slate-300 rounded-md">
                                     </div>
                                     <div>
                                        <label for="filtros-foto" class="block text-sm font-medium text-slate-600 mb-1">Foto</label>
                                        <input type="file" id="filtros-foto" accept="image/*" class="w-full text-sm file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:font-semibold file:bg-amber-100 file:text-amber-700 hover:file:bg-amber-200">
                                     </div>
                                 </div>
                                 <div class="mt-4">
                                     <button type="button" id="guardar-filtro-btn" class="w-full bg-amber-600 text-white font-semibold py-2 px-4 rounded-md hover:bg-amber-700">Guardar Filtro</button>
                                 </div>
                            </div>
                        </div>

                        <div id="info-paquete-cargado" class="hidden mt-4 grid grid-cols-2 md:grid-cols-3 gap-3">
                            <div class="info-grid-item"><p class="info-grid-label">Fecha Bodega (Carga)</p><p id="info-fecha" class="info-grid-value"></p></div>
                            <div class="info-grid-item"><p class="info-grid-label">Status (Carga)</p><p id="info-status" class="info-grid-value"></p></div>
                            <div class="info-grid-item"><p class="info-grid-label">Casillero (Carga)</p><p id="info-box" class="info-grid-value"></p></div>
                            <div class="info-grid-item"><p class="info-grid-label">Peso (lbs)</p><p id="info-peso" class="info-grid-value"></p></div>
                            <div class="info-grid-item col-span-2 md:col-span-1"><p class="info-grid-label">Valor ($)</p><p id="info-valor" class="info-grid-value"></p></div>
                        </div>
                        
                        <div id="step2" class="form-section">
                            <h2 class="text-lg font-semibold text-slate-700 mb-4">2. Cliente y Anaquel</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div class="relative">
                                    <label for="casillero-search" class="block text-sm font-medium text-slate-600 mb-1">Buscar Cliente (Casillero/Nombre)</label>
                                    <div class="relative flex items-center">
                                        <input type="text" id="casillero-search" class="w-full p-2 pr-12 border border-slate-300 rounded-md" autocomplete="off">
                                        <button type="button" data-target="casillero-search" class="scan-ocr-btn absolute right-1 p-2 text-slate-500 hover:text-indigo-600 rounded-full hover:bg-indigo-100" title="Escanear Etiqueta (OCR)">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                                        </button>
                                    </div>
                                    <div id="cliente-suggestions" class="autocomplete-suggestions hidden"></div>
                                </div>
                                <div>
                                    <label for="cliente" class="block text-sm font-medium text-slate-600 mb-1">Cliente Encontrado</label>
                                    <input type="text" id="cliente" disabled class="w-full p-2 border border-slate-300 rounded-md bg-slate-100">
                                </div>
                                <div>
                                    <label for="sucursal" class="block text-sm font-medium text-slate-600 mb-1">Sucursal del Cliente</label>
                                    <input type="text" id="sucursal" disabled class="w-full p-2 border border-slate-300 rounded-md bg-slate-100">
                                </div>
                                <div>
                                    <label for="anaquel-select" class="block text-sm font-medium text-slate-600 mb-1">Asignar Anaquel (Opcional)</label>
                                    <select id="anaquel-select" class="w-full p-2 border border-slate-300 rounded-md">
                                        <option value="">(Sin anaquel)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div id="step3" class="form-section">
                            <div class="mt-8">
                                <button type="submit" class="w-full bg-emerald-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-emerald-500/20 hover:bg-emerald-600">Registrar Paquete en Sistema</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="lg:col-span-1 space-y-8">
                    <div class="bg-white p-6 rounded-lg border-2 border-red-500 shadow-sm">
                        <h2 class="text-xl font-bold text-red-700 mb-4">Gestión de Casos Especiales</h2>
                        <div class="overflow-y-auto max-h-96">
                            <table class="w-full text-sm">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left">Tracking</th>
                                        <th class="px-4 py-2 text-left">Estado / Ubicación</th>
                                        <th class="px-4 py-2 text-center">Acción</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-casos-especiales">
                                    <tr><td colspan="3" class="text-center p-4 text-slate-500">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Paquetes Pendientes de Carga</h2>
                        <div class="overflow-y-auto max-h-96">
                            <table class="w-full text-sm">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left">Tracking</th>
                                        <th class="px-4 py-2 text-left">Casillero</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-pendientes">
                                    <tr><td colspan="2" class="text-center p-4 text-slate-500">Cargando...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg border border-slate-200 shadow-sm">
                        <h2 class="text-xl font-bold text-slate-800 mb-4">Paquetes Mal Identificados</h2>
                        <div class="overflow-y-auto max-h-96">
                            <table class="w-full text-sm">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100 sticky top-0">
                                    <tr>
                                        <th class="px-4 py-2 text-left">Tracking</th>
                                        <th class="px-4 py-2 text-left">Fecha</th>
                                    </tr>
                                </thead>
                                <tbody id="tabla-mal-identificados">
                                    <tr><td colspan="2" class="text-center p-4 text-slate-500">Aún no hay registros.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="ocr-scanner-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white w-full max-w-lg rounded-lg shadow-xl p-6 relative">
            <button id="close-ocr-btn" class="absolute top-2 right-2 text-slate-400 hover:text-slate-600 text-3xl font-bold">&times;</button>
            <h2 class="text-xl font-bold text-slate-800 mb-4">Escanear Etiqueta con Cámara</h2>
            <div class="relative"><video id="video-feed" autoplay playsinline></video><div id="ocr-guide-box" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-10/12 h-12 border-2 border-dashed border-white rounded-lg pointer-events-none"></div></div>
            <p id="ocr-status" class="text-sm text-slate-500 mt-2 text-center h-5">Iniciando cámara...</p>
            <button id="capture-ocr-btn" class="w-full mt-4 bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg disabled:opacity-50" disabled>Capturar Imagen</button>
        </div>
    </div>
    <div id="barcode-scanner-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white w-full max-w-md rounded-lg shadow-xl p-6 relative">
            <button id="close-barcode-btn" class="absolute top-2 right-2 text-slate-400 hover:text-slate-600 text-3xl font-bold">&times;</button>
            <h2 class="text-xl font-bold text-slate-800 mb-4">Escanear Código de Barras</h2>
            <div id="barcode-reader" class="w-full"></div>
            <p class="text-xs text-slate-500 mt-4 text-center">Apunte la cámara al código de barras o QR.</p>
        </div>
    </div>

    <div id="manual-paquete-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-40">
        <div class="bg-white w-full max-w-2xl rounded-lg shadow-xl p-6 modal-content">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-slate-800">Agregar Paquete Manualmente</h2><button class="close-modal text-slate-400 hover:text-slate-600 text-3xl font-bold">&times;</button></div>
            <form id="form-manual"><div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"><div><label for="manual-tracking1" class="block text-sm font-medium">Tracking Principal</label><input id="manual-tracking1" type="text" class="w-full p-1.5 border rounded-md text-sm" required></div><div><label for="manual-peso" class="block text-sm font-medium">Peso (lbs)</label><input id="manual-peso" type="number" step="0.01" class="w-full p-1.5 border rounded-md text-sm"></div><div class="md:col-span-2"><hr></div>
            <div class="relative">
                <label for="manual-casillero" class="block text-sm font-medium">Buscar Cliente (Casillero/Nombre)</label>
                <input id="manual-casillero" type="text" class="w-full p-1.5 border rounded-md text-sm" autocomplete="off">
                <div id="manual-cliente-suggestions" class="autocomplete-suggestions hidden"></div>
            </div>
            <div><label class="block text-sm font-medium">Cliente Encontrado</label><input id="manual-cliente-info" type="text" class="w-full p-1.5 border rounded-md text-sm bg-slate-100" readonly></div></div><div class="flex justify-end gap-4 pt-4 mt-4 border-t"><button type="button" class="close-modal bg-slate-100 text-slate-700 font-semibold py-2 px-4 rounded-md hover:bg-slate-200">Cancelar</button><button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-blue-700">Guardar Paquete</button></div></form>
        </div>
    </div>
    
    <div id="procesar-paquete-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white w-full max-w-lg rounded-lg shadow-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-800">Procesar Paquete Sin Cliente</h2>
                <button id="close-procesar-modal" class="text-slate-400 hover:text-slate-600 text-3xl font-bold">&times;</button>
            </div>
            <p class="text-sm mb-4">Asignar un cliente al tracking: <strong id="procesar-tracking-info"></strong></p>
            <div class="space-y-4">
                 <div class="relative">
                    <label for="procesar-casillero-search" class="block text-sm font-medium">Buscar Cliente (Casillero/Nombre)</label>
                    <input id="procesar-casillero-search" type="text" class="w-full p-2 border rounded-md" autocomplete="off">
                    <div id="procesar-cliente-suggestions" class="autocomplete-suggestions hidden"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium">Cliente Encontrado</label>
                    <input id="procesar-cliente-info" type="text" class="w-full p-2 border rounded-md bg-slate-100" readonly placeholder="Ningún cliente seleccionado.">
                </div>
            </div>
            <div class="flex justify-end gap-4 pt-4 mt-4 border-t">
                <button type="button" id="cancel-procesar-btn" class="bg-slate-100 text-slate-700 font-semibold py-2 px-4 rounded-md hover:bg-slate-200">Cancelar</button>
                <button type="button" id="confirmar-procesar-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-md hover:bg-blue-700 disabled:bg-slate-400" disabled>Asignar Cliente y Procesar</button>
            </div>
        </div>
    </div>

    <div id="custom-alert" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white w-full max-w-md rounded-lg shadow-xl p-6 text-center">
            <p id="custom-alert-message" class="text-slate-700 mb-4">Mensaje.</p>
            <button id="custom-alert-close" class="bg-emerald-500 text-white font-semibold py-2 px-6 rounded-md hover:bg-emerald-600">Entendido</button>
        </div>
    </div>

    <script type="module" src="app.js"></script>
    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        document.addEventListener('DOMContentLoaded', () => {
            initializeRecibirPaqueteLogic();
        });

        function initializeRecibirPaqueteLogic() {
            try {
                const sb = createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);

                const formRecibir = document.getElementById('form-recibir');
                const trackingInput = document.getElementById('tracking-main');
                const infoPaqueteDiv = document.getElementById('info-paquete-cargado');
                const casilleroSearchInput = document.getElementById('casillero-search');
                const clienteSuggestionsContainer = document.getElementById('cliente-suggestions');
                const clienteInput = document.getElementById('cliente');
                const sucursalInput = document.getElementById('sucursal');
                const anaquelSelect = document.getElementById('anaquel-select');
                const step2 = document.getElementById('step2');
                const step3 = document.getElementById('step3');
                const tablaPendientesBody = document.getElementById('tabla-pendientes');
                const manualModal = document.getElementById('manual-paquete-modal');
                const openManualModalBtn = document.getElementById('add-manual-btn');
                const formManual = document.getElementById('form-manual');
                const manualCasilleroInput = document.getElementById('manual-casillero');
                const manualClienteInfoInput = document.getElementById('manual-cliente-info');
                const manualClienteSuggestionsContainer = document.getElementById('manual-cliente-suggestions');
                const casosEspecialesBtn = document.getElementById('casos-especiales-btn');
                const casosEspecialesContainer = document.getElementById('casos-especiales-container');
                const malIdentificadoInput = document.getElementById('mal-identificado-input');
                const tablaMalIdentificadosBody = document.getElementById('tabla-mal-identificados');
                const filtrosTrackingInput = document.getElementById('filtros-tracking-input');
                const filtrosFotoInput = document.getElementById('filtros-foto');
                const guardarFiltroBtn = document.getElementById('guardar-filtro-btn');
                const tablaCasosEspecialesBody = document.getElementById('tabla-casos-especiales');
                const procesarModal = document.getElementById('procesar-paquete-modal');
                const closeProcesarModalBtn = document.getElementById('close-procesar-modal');
                const cancelProcesarBtn = document.getElementById('cancel-procesar-btn');
                const confirmarProcesarBtn = document.getElementById('confirmar-procesar-btn');
                const procesarTrackingInfo = document.getElementById('procesar-tracking-info');
                const procesarCasilleroInput = document.getElementById('procesar-casillero-search');
                const procesarClienteInfoInput = document.getElementById('procesar-cliente-info');
                const procesarClienteSuggestionsContainer = document.getElementById('procesar-cliente-suggestions');
                
                let paqueteCargadoActual = null;
                let clienteSeleccionado = null;
                let clienteManualSeleccionado = null;
                let paqueteParaProcesarId = null;
                let clienteParaProcesar = null;
                let paqueteVieneDeMalIdentificado = false;

                const fmtDate = (iso) => (iso ? new Date(iso).toLocaleDateString("es-PA", { day: '2-digit', month: '2-digit', year: 'numeric' }) : "N/A");
                function showAlert(message) {
                    document.getElementById('custom-alert-message').textContent = message;
                    document.getElementById('custom-alert').classList.remove('hidden');
                    document.getElementById('custom-alert-close').onclick = () => document.getElementById('custom-alert').classList.add('hidden');
                }
                function resetFormularioPrincipal() {
                    formRecibir.reset();
                    step2.classList.remove('visible');
                    step3.classList.remove('visible');
                    infoPaqueteDiv.classList.add('hidden');
                    casosEspecialesContainer.classList.add('hidden');
                    paqueteCargadoActual = null;
                    clienteSeleccionado = null;
                    paqueteVieneDeMalIdentificado = false;
                    trackingInput.focus();
                }

                async function cargarPaquetesPendientes() {
                    const { data, error } = await sb.from('paquetes_cargados').select('tracking, cliente_box').eq('cargados', false);
                    if (error) { tablaPendientesBody.innerHTML = `<tr><td colspan="2" class="text-center p-4 text-red-500">Error al cargar.</td></tr>`; return; }
                    if (!data || data.length === 0) { tablaPendientesBody.innerHTML = `<tr><td colspan="2" class="text-center p-4 text-slate-500">¡No hay paquetes pendientes!</td></tr>`; return; }
                    tablaPendientesBody.innerHTML = data.map(p => `<tr class="border-b hover:bg-slate-50"><td class="px-4 py-2 font-medium">${p.tracking}</td><td class="px-4 py-2">${p.cliente_box || 'N/A'}</td></tr>`).join('');
                }
                async function cargarPaquetesMalIdentificados() {
                    const { data, error } = await sb.from('paquetes_mal_identificados').select('*').order('created_at', { ascending: false }).limit(20);
                    if (error) { tablaMalIdentificadosBody.innerHTML = `<tr><td colspan="2" class="text-center p-4 text-red-500">Error al cargar.</td></tr>`; return; }
                    if (!data.length) { tablaMalIdentificadosBody.innerHTML = `<tr><td colspan="2" class="text-center p-4 text-slate-500">No hay registros.</td></tr>`; return; }
                    tablaMalIdentificadosBody.innerHTML = data.map(p => `<tr class="border-b"><td class="px-4 py-2">${p.tracking}</td><td class="px-4 py-2">${fmtDate(p.created_at)}</td></tr>`).join('');
                }
                async function cargarAnaqueles() {
                    const { data, error } = await sb.from('anaqueles').select('nombre').order('nombre');
                    if (error) { console.error("Error cargando anaqueles:", error); return; }
                    anaquelSelect.innerHTML = '<option value="">(Sin anaquel)</option>';
                    if (data) { data.forEach(a => { anaquelSelect.innerHTML += `<option value="${a.nombre}">${a.nombre}</option>`; }); }
                }

                async function cargarCasosEspeciales() {
                    const { data, error } = await sb.from('paquetes')
                        .select('id, tracking, status, sucursal_recibido')
                        .in('status', ['Reportado', 'Reportado en transito', 'sin procesar'])
                        .order('created_at', { ascending: false });

                    if (error) {
                        tablaCasosEspecialesBody.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-red-500">Error al cargar.</td></tr>`;
                        return;
                    }
                    if (!data || data.length === 0) {
                        tablaCasosEspecialesBody.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-slate-500">No hay casos especiales pendientes.</td></tr>`;
                        return;
                    }

                    tablaCasosEspecialesBody.innerHTML = data.map(p => {
                        let statusClass = '';
                        if (p.status === 'Reportado') statusClass = 'bg-red-100 text-red-800';
                        if (p.status === 'Reportado en transito') statusClass = 'bg-amber-100 text-amber-800';
                        if (p.status === 'Sin procesar') statusClass = 'bg-indigo-100 text-indigo-800';

                        const botonProcesar = p.status === 'Sin procesar' ? 
                            `<button data-id="${p.id}" data-tracking="${p.tracking}" class="procesar-btn bg-blue-500 text-white text-xs font-semibold py-1 px-2 rounded-md hover:bg-blue-600">Procesar</button>` :
                            '<span>-</span>';

                        return `
                            <tr class="border-b hover:bg-slate-50">
                                <td class="px-4 py-2 font-medium">${p.tracking}</td>
                                <td class="px-4 py-2">
                                    <span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${p.status}</span>
                                    <p class="text-xs text-slate-500 mt-1">${p.sucursal_recibido || 'N/A'}</p>
                                </td>
                                <td class="px-4 py-2 text-center">${botonProcesar}</td>
                            </tr>
                        `;
                    }).join('');
                }

                async function buscarPaqueteCargado(tracking) {
                    if (!tracking) { resetFormularioPrincipal(); return; }
                    const { data: malIdentificado } = await sb.from('paquetes_mal_identificados').select('tracking').eq('tracking', tracking).maybeSingle();
                    let query = sb.from('paquetes_cargados').select('id, tracking, peso, valor, cliente_box, status, fecha_bodega, cargados').eq('tracking', tracking);
                    if (malIdentificado) {
                        paqueteVieneDeMalIdentificado = true;
                    } else {
                        paqueteVieneDeMalIdentificado = false;
                        query = query.eq('cargados', false);
                    }
                    const { data, error } = await query.maybeSingle();
                    if (error) { showAlert('Error al buscar el tracking.'); return; }
                    if (data) {
                        if (data.cargados === true && !paqueteVieneDeMalIdentificado) { showAlert('Este paquete ya fue recibido y registrado.'); resetFormularioPrincipal(); return; }
                        paqueteCargadoActual = data;
                        document.getElementById('info-fecha').textContent = fmtDate(data.fecha_bodega);
                        document.getElementById('info-status').textContent = data.status || 'N/A';
                        document.getElementById('info-box').textContent = data.cliente_box || 'N/A';
                        document.getElementById('info-peso').textContent = data.peso ? `${data.peso} lbs` : 'N/A';
                        document.getElementById('info-valor').textContent = data.valor ? `$${Number(data.valor).toFixed(2)}` : 'N/A';
                        infoPaqueteDiv.classList.remove('hidden');
                        if (data.cliente_box) {
                            casilleroSearchInput.value = data.cliente_box;
                            await buscarCliente(data.cliente_box, 'main');
                        } else {
                            casilleroSearchInput.value = '';
                            clienteSeleccionado = null;
                            actualizarInfoClienteUI();
                        }
                        step2.classList.add('visible');
                        step3.classList.add('visible');
                    } else {
                        resetFormularioPrincipal();
                        showAlert('Tracking no encontrado en la carga de paquetes pendientes.');
                    }
                }

                async function buscarCliente(terminoBusqueda, target) {
                    if (!terminoBusqueda) return;
                    
                    const isNumeric = !isNaN(terminoBusqueda);
                    let query = sb.from('clientes').select('nombre, box, sucursal');
                    if (isNumeric) {
                        query = query.eq('box', parseInt(terminoBusqueda));
                    } else {
                        query = query.ilike('nombre', `%${terminoBusqueda}%`);
                    }
                    const { data, error } = await query.limit(1).maybeSingle();
                    
                    if (error) { showAlert("Error buscando cliente."); return; }

                    if (target === 'main') {
                        clienteSeleccionado = data;
                        actualizarInfoClienteUI();
                    } else if (target === 'manual') {
                        clienteManualSeleccionado = data;
                        manualClienteInfoInput.value = data ? `${data.nombre} (Box: ${data.box})` : "No encontrado";
                    } else if (target === 'procesar') {
                        clienteParaProcesar = data;
                        procesarClienteInfoInput.value = data ? `${data.nombre} (Box: ${data.box})` : 'No encontrado.';
                        confirmarProcesarBtn.disabled = !data;
                    }
                }

                function actualizarInfoClienteUI() {
                    if (clienteSeleccionado) {
                        clienteInput.value = `${clienteSeleccionado.nombre} (Box: ${clienteSeleccionado.box})`;
                        sucursalInput.value = clienteSeleccionado.sucursal || 'No asignada';
                    } else {
                        clienteInput.value = 'Cliente no encontrado';
                        sucursalInput.value = '';
                    }
                }
                
                async function handleAutocomplete(inputElement, containerElement, callback) {
                    const termino = inputElement.value.trim();
                    if (termino.length < 2) { containerElement.classList.add('hidden'); return; }
                    
                    let query = sb.from('clientes').select('nombre, box');
                    if(!isNaN(termino)) {
                        query = query.like('box::text', `${termino}%`);
                    } else {
                        query = query.ilike('nombre', `%${termino}%`);
                    }
                    const { data, error } = await query.limit(5);

                    if (error || !data || data.length === 0) { containerElement.classList.add('hidden'); return; }

                    containerElement.innerHTML = data.map(cliente => 
                        `<div class="suggestion-item" data-box="${cliente.box}">
                            ${cliente.nombre} <span class="text-slate-500 text-xs">(${cliente.box})</span>
                        </div>`
                    ).join('');
                    containerElement.classList.remove('hidden');

                    containerElement.querySelectorAll('.suggestion-item').forEach(item => {
                        item.addEventListener('click', () => {
                            callback(item.dataset.box);
                            containerElement.classList.add('hidden');
                        });
                    });
                }

                async function handleMalIdentificado() {
                    const tracking = malIdentificadoInput.value.trim();
                    if (!tracking) return;
                    const { data: paquete, error } = await sb.from('paquetes_cargados').select('peso').eq('tracking', tracking).maybeSingle();
                    if (error || !paquete) { showAlert(`Tracking ${tracking} no encontrado en carga.`); return; }
                    const { error: insertError } = await sb.from('paquetes_mal_identificados').insert({ tracking: tracking, peso: paquete.peso });
                    if (insertError) { showAlert(`Error al registrar mal identificado: ${insertError.message}`); return; }
                    await sb.from('paquetes_cargados').update({ cargados: true }).eq('tracking', tracking);
                    showAlert(`Paquete ${tracking} registrado como MAL IDENTIFICADO.`);
                    resetFormularioPrincipal();
                    await Promise.all([cargarPaquetesPendientes(), cargarPaquetesMalIdentificados()]);
                }
                async function handleFiltro() {
                    const tracking = filtrosTrackingInput.value.trim();
                    const foto = filtrosFotoInput.files[0];
                    if (!tracking) { showAlert("Debe ingresar el tracking que desea filtrar."); return; }
                    const { data: paquete, error } = await sb.from('paquetes_cargados').select('peso').eq('tracking', tracking).maybeSingle();
                    if (error || !paquete) { showAlert(`Tracking ${tracking} no encontrado en carga.`); return; }
                    let urlFoto = null;
                    if (foto) {
                        const filePath = `filtros/${tracking}-${Date.now()}`;
                        const { error: uploadError } = await sb.storage.from('public-files').upload(filePath, foto);
                        if (uploadError) { showAlert(`Error subiendo foto: ${uploadError.message}`); return; }
                        const { data: urlData } = sb.storage.from('public-files').getPublicUrl(filePath);
                        urlFoto = urlData.publicUrl;
                    }
                    const { error: insertError } = await sb.from('paquetes_con_filtro').insert({ tracking, peso: paquete.peso, foto_url: urlFoto });
                    if (insertError) { showAlert(`Error al registrar filtro: ${insertError.message}`); return; }
                    await sb.from('paquetes_cargados').update({ cargados: true }).eq('tracking', tracking);
                    showAlert(`Paquete ${tracking} registrado CON FILTRO.`);
                    resetFormularioPrincipal();
                    await Promise.all([cargarPaquetesPendientes(), cargarPaquetesMalIdentificados()]);
                }
                
                formRecibir.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    if (!paqueteCargadoActual) {
                        showAlert("Primero debe escanear y cargar un tracking válido."); 
                        return;
                    }
                    if (!clienteSeleccionado) {
                        showAlert("Debe asignar un cliente válido al paquete."); 
                        return;
                    }
                    
                    const now = new Date().toISOString();
                    const payload = {
                        tracking: paqueteCargadoActual.tracking, peso: paqueteCargadoActual.peso || null, valor: paqueteCargadoActual.valor || null,
                        cliente_nombre: clienteSeleccionado.nombre, cliente_box: clienteSeleccionado.box, sucursal: clienteSeleccionado.sucursal,
                        anaquel: anaquelSelect.value || null, status: anaquelSelect.value ? 'En Sucursal' : 'En transito',
                        sucursal_recibido: anaquelSelect.value ? clienteSeleccionado.sucursal : null, fecha_bodega: paqueteCargadoActual.fecha_bodega || now,
                        fecha_recibido: now, fecha_sucursal: anaquelSelect.value ? now : null
                    };
                    const { error } = await sb.rpc('crear_paquete_admin', { paquete_data: payload });
                    if (error) { showAlert(`Error al registrar el paquete: ${error.message}`); return; }
                    
                    if (paqueteVieneDeMalIdentificado) {
                        await sb.from('paquetes_mal_identificados').delete().eq('tracking', paqueteCargadoActual.tracking);
                    }
                    
                    await sb.from('paquetes_cargados').update({ cargados: true }).eq('tracking', paqueteCargadoActual.tracking);
                    showAlert(`Paquete ${paqueteCargadoActual.tracking} registrado y asignado a ${clienteSeleccionado.nombre} ✅`);
                    resetFormularioPrincipal();
                    await Promise.all([cargarPaquetesPendientes(), cargarPaquetesMalIdentificados(), cargarCasosEspeciales()]);
                });
                
                formManual.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const tracking1 = document.getElementById('manual-tracking1').value.trim();
                    
                    if (!tracking1) {
                        showAlert("El campo Tracking Principal es obligatorio."); return;
                    }
                    if (!clienteManualSeleccionado) {
                        showAlert("Debe asignar un cliente válido."); return;
                    }

                    const now = new Date().toISOString();
                    const payload = {
                        tracking: tracking1, peso: parseFloat(document.getElementById('manual-peso').value) || null,
                        cliente_nombre: clienteManualSeleccionado.nombre, cliente_box: clienteManualSeleccionado.box, sucursal: clienteManualSeleccionado.sucursal,
                        status: 'En transito', fecha_bodega: now, fecha_recibido: now, valor: null, anaquel: null, sucursal_recibido: null, fecha_sucursal: null
                    };
                    const { error } = await sb.rpc('crear_paquete_admin', { paquete_data: payload });
                    if (error) { showAlert(`Error al crear el paquete: ${error.message}`); return; }
                    
                    showAlert(`Paquete ${tracking1} creado y asignado a ${clienteManualSeleccionado.nombre} ✅`);
                    manualModal.classList.add('hidden');
                    formManual.reset();
                });

                function openProcesarModal(paqueteId, tracking) {
                    paqueteParaProcesarId = paqueteId;
                    clienteParaProcesar = null;
                    procesarTrackingInfo.textContent = tracking;
                    procesarCasilleroInput.value = '';
                    procesarClienteInfoInput.value = 'Ningún cliente seleccionado.';
                    confirmarProcesarBtn.disabled = true;
                    procesarModal.classList.remove('hidden');
                }

                function closeProcesarModal() {
                    procesarModal.classList.add('hidden');
                }

                async function handleConfirmarProceso() {
                    if (!paqueteParaProcesarId || !clienteParaProcesar) {
                        showAlert("Error: No hay un paquete o cliente válido seleccionado.");
                        return;
                    }
                    
                    confirmarProcesarBtn.disabled = true;
                    confirmarProcesarBtn.textContent = 'Procesando...';

                    const { error } = await sb.from('paquetes')
                        .update({
                            cliente_nombre: clienteParaProcesar.nombre,
                            cliente_box: clienteParaProcesar.box,
                            sucursal: clienteParaProcesar.sucursal,
                            status: 'Reportado en transito'
                        })
                        .eq('id', paqueteParaProcesarId);

                    if (error) {
                        showAlert(`Error al procesar el paquete: ${error.message}`);
                    } else {
                        showAlert("Paquete procesado y asignado exitosamente.");
                        closeProcesarModal();
                        await cargarCasosEspeciales();
                    }
                    
                    confirmarProcesarBtn.disabled = false;
                    confirmarProcesarBtn.textContent = 'Asignar Cliente y Procesar';
                }

                function initializeAllScanners() {
                    let ocrStream, ocrWorker, html5QrcodeScanner, currentOcrTargetInput;
                    const ocrScannerModal = document.getElementById('ocr-scanner-modal');
                    const openOcrBtns = document.querySelectorAll('.scan-ocr-btn');
                    const closeOcrBtn = document.getElementById('close-ocr-btn');
                    const captureBtn = document.getElementById('capture-ocr-btn');
                    const videoFeed = document.getElementById('video-feed');
                    const ocrStatus = document.getElementById('ocr-status');
                    const barcodeScannerModal = document.getElementById('barcode-scanner-modal');
                    const openBarcodeBtn = document.getElementById('scan-tracking-barcode-btn');
                    const closeBarcodeBtn = document.getElementById('close-barcode-btn');

                    const startOcrCamera = async (targetInputId) => {
                        currentOcrTargetInput = document.getElementById(targetInputId);
                        ocrScannerModal.classList.remove('hidden');
                        try {
                            ocrStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                            videoFeed.srcObject = ocrStream;
                            ocrStatus.textContent = 'Apunte a la etiqueta y presione "Capturar".';
                            captureBtn.disabled = false;
                        } catch (err) {
                            showAlert("No se pudo acceder a la cámara. Asegúrate de dar los permisos.");
                            stopOcrCamera();
                        }
                    };

                    const stopOcrCamera = () => {
                        if (ocrStream) ocrStream.getTracks().forEach(track => track.stop());
                        ocrScannerModal.classList.add('hidden');
                    };

                    const captureAndProcessImage = async () => {
                        ocrStatus.textContent = 'Procesando imagen...';
                        captureBtn.disabled = true;
                        const guideBox = document.getElementById('ocr-guide-box');
                        const canvas = document.createElement('canvas');
                        const videoRect = videoFeed.getBoundingClientRect();
                        const guideRect = guideBox.getBoundingClientRect();
                        const scaleX = videoFeed.videoWidth / videoRect.width;
                        const scaleY = videoFeed.videoHeight / videoRect.height;
                        const cropX = (guideRect.left - videoRect.left) * scaleX;
                        const cropY = (guideRect.top - videoRect.top) * scaleY;
                        const cropWidth = guideRect.width * scaleX;
                        const cropHeight = guideRect.height * scaleY;
                        canvas.width = cropWidth;
                        canvas.height = cropHeight;
                        const context = canvas.getContext('2d');
                        context.drawImage(videoFeed, cropX, cropY, cropWidth, cropHeight, 0, 0, cropWidth, cropHeight);
                        
                        if (!ocrWorker || ocrWorker.terminated) {
                             ocrWorker = await Tesseract.createWorker('eng');
                        }
                        const { data: { text } } = await ocrWorker.recognize(canvas.toDataURL('image/jpeg'));
                        
                        parseOcrText(text);
                        stopOcrCamera();
                    };
                    
                    const parseOcrText = (text) => {
                        const words = text.split(/[\s\n]+/).filter(w => w.length > 5);
                        const bestGuess = words.sort((a, b) => b.length - a.length)[0] || "";
                        currentOcrTargetInput.value = bestGuess.replace(/[^a-zA-Z0-9-]/g, '');
                        currentOcrTargetInput.dispatchEvent(new Event('change'));
                    };

                    const onBarcodeScanSuccess = (decodedText, decodedResult) => {
                        trackingInput.value = decodedText;
                        stopBarcodeScanner();
                        trackingInput.dispatchEvent(new Event('change'));
                    };

                    const startBarcodeScanner = () => {
                        barcodeScannerModal.classList.remove('hidden');
                        html5QrcodeScanner = new Html5Qrcode("barcode-reader");
                        html5QrcodeScanner.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onBarcodeScanSuccess)
                            .catch(err => {
                                showAlert("No se pudo iniciar el escáner de código de barras.");
                                stopBarcodeScanner();
                            });
                    };

                    const stopBarcodeScanner = () => {
                        if (html5QrcodeScanner && html5QrcodeScanner.isScanning) {
                            html5QrcodeScanner.stop().catch(err => console.error("Error al detener el escáner.", err));
                        }
                        barcodeScannerModal.classList.add('hidden');
                    };

                    openOcrBtns.forEach(btn => btn.addEventListener('click', () => startOcrCamera(btn.dataset.target)));
                    closeOcrBtn.addEventListener('click', stopOcrCamera);
                    captureBtn.addEventListener('click', captureAndProcessImage);
                    openBarcodeBtn.addEventListener('click', startBarcodeScanner);
                    closeBarcodeBtn.addEventListener('click', stopBarcodeScanner);
                }

                function handleEnterSearch(event, target) {
                    if (event.key === 'Enter') {
                        event.preventDefault(); 
                        const terminoBusqueda = event.target.value.trim();
                        if (terminoBusqueda) {
                            buscarCliente(terminoBusqueda, target);
                        }
                        document.querySelectorAll('.autocomplete-suggestions').forEach(el => el.classList.add('hidden'));
                    }
                }

                casosEspecialesBtn.addEventListener('click', () => casosEspecialesContainer.classList.toggle('hidden'));
                trackingInput.addEventListener('change', (e) => buscarPaqueteCargado(e.target.value.trim()));
                casilleroSearchInput.addEventListener('input', () => handleAutocomplete(casilleroSearchInput, clienteSuggestionsContainer, (box) => {
                    casilleroSearchInput.value = box;
                    buscarCliente(box, 'main');
                }));
                malIdentificadoInput.addEventListener('change', handleMalIdentificado);
                guardarFiltroBtn.addEventListener('click', handleFiltro);
                openManualModalBtn.addEventListener('click', () => {
                    formManual.reset();
                    clienteManualSeleccionado = null;
                    manualModal.classList.remove('hidden');
                });
                manualModal.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', () => manualModal.classList.add('hidden')));
                manualCasilleroInput.addEventListener('input', () => handleAutocomplete(manualCasilleroInput, manualClienteSuggestionsContainer, (box) => {
                    manualCasilleroInput.value = box;
                    buscarCliente(box, 'manual');
                }));

                tablaCasosEspecialesBody.addEventListener('click', (e) => {
                    const boton = e.target.closest('.procesar-btn');
                    if (boton) {
                        const id = boton.dataset.id;
                        const tracking = boton.dataset.tracking;
                        openProcesarModal(id, tracking);
                    }
                });
                closeProcesarModalBtn.addEventListener('click', closeProcesarModal);
                cancelProcesarBtn.addEventListener('click', closeProcesarModal);
                procesarCasilleroInput.addEventListener('input', () => handleAutocomplete(procesarCasilleroInput, procesarClienteSuggestionsContainer, (box) => {
                    procesarCasilleroInput.value = box;
                    buscarCliente(box, 'procesar');
                }));
                confirmarProcesarBtn.addEventListener('click', handleConfirmarProceso);
                
                casilleroSearchInput.addEventListener('keydown', (e) => handleEnterSearch(e, 'main'));
                manualCasilleroInput.addEventListener('keydown', (e) => handleEnterSearch(e, 'manual'));
                procesarCasilleroInput.addEventListener('keydown', (e) => handleEnterSearch(e, 'procesar'));
                
                document.addEventListener('click', (e) => {
                    if (!casilleroSearchInput.contains(e.target)) clienteSuggestionsContainer.classList.add('hidden');
                    if (!manualCasilleroInput.contains(e.target)) manualClienteSuggestionsContainer.classList.add('hidden');
                    if (!procesarCasilleroInput.contains(e.target)) procesarClienteSuggestionsContainer.classList.add('hidden');
                });

                initializeAllScanners();
                cargarPaquetesPendientes();
                cargarAnaqueles();
                cargarPaquetesMalIdentificados();
                cargarCasosEspeciales();
            } catch (error) {
                console.error("Error al inicializar:", error);
                document.querySelector("main").innerHTML = `<p class="text-red-500">Error crítico. Revise la consola.</p>`;
            }
        }
    </script>
</body>
</html>
