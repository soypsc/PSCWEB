<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGL1 - Gestión de Facturas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="config.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-hidden { display: none; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="relative min-h-screen md:flex">
        <div id="menu-container"></div>

        <main class="flex-1 p-8">
            <h1 class="text-3xl font-bold text-slate-900 mb-6">Gestión de Facturas</h1>
            
            <div class="bg-white p-6 rounded-lg border shadow-sm">
                <div class="mb-4">
                    <input type="text" id="search-input" class="w-full max-w-lg p-2 border border-slate-300 rounded-md" placeholder="Buscar por N° de Factura, Nombre o Casillero...">
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">N° Factura</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Cliente</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Estado</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="facturas-table-body" class="bg-white divide-y divide-slate-200">
                            <tr><td colspan="6" class="p-8 text-center text-slate-500">Cargando facturas...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <div id="reembolso-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 z-40 modal-hidden">
        <div class="bg-white w-full max-w-lg rounded-lg shadow-xl p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-slate-800">Confirmar Reembolso</h2>
                <button id="close-modal-btn" class="text-slate-400 hover:text-slate-600 text-3xl font-bold">&times;</button>
            </div>
            <div id="modal-summary" class="mb-6">
                </div>
            
            <div class="mb-6">
                <p class="font-semibold mb-2">Para pagos con Tarjeta/Efectivo, ¿cómo desea procesar la devolución?</p>
                <div class="space-y-2">
                    <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                        <input type="radio" name="reembolso-opcion" value="saldo" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500" checked>
                        <span class="ml-3 text-sm">Acreditar a **Saldo a Favor** del cliente</span>
                    </label>
                    <label class="flex items-center p-3 border rounded-md has-[:checked]:bg-blue-50 has-[:checked]:border-blue-400">
                        <input type="radio" name="reembolso-opcion" value="registro" class="h-4 w-4 text-blue-600 border-slate-300 focus:ring-blue-500">
                        <span class="ml-3 text-sm">Registrar como **Devolución Externa** (Efectivo, etc.)</span>
                    </label>
                </div>
            </div>

            <p id="modal-message" class="text-sm text-center h-5 mb-4"></p>
            <div class="flex justify-end gap-4">
                <button id="cancel-reembolso-btn" class="bg-slate-100 text-slate-700 font-semibold py-2 px-4 rounded-md hover:bg-slate-200">Cancelar</button>
                <button id="confirm-reembolso-btn" class="bg-red-600 text-white font-bold py-2 px-6 rounded-md hover:bg-red-700 shadow-md">Confirmar Reembolso</button>
            </div>
        </div>
    </div>

    <script type="module">
      import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
const supabase = createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);

let todasLasFacturas = [];
let facturaParaReembolsar = null;

// --- DOM Elements ---
const searchInput = document.getElementById('search-input');
const tableBody = document.getElementById('facturas-table-body');
const modal = document.getElementById('reembolso-modal');
const modalSummary = document.getElementById('modal-summary');
const modalMessage = document.getElementById('modal-message');
const closeModalBtn = document.getElementById('close-modal-btn');
const cancelReembolsoBtn = document.getElementById('cancel-reembolso-btn');
const confirmReembolsoBtn = document.getElementById('confirm-reembolso-btn');

// --- Funciones ---

/**
 * Formatea un número como moneda (USD).
 */
function formatCurrency(amount) {
    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
}

/**
 * Devuelve una clase de color según el estado de la factura.
 */
function getStatusBadge(status) {
    switch (status) {
        case 'Pagado':
            return 'bg-green-100 text-green-800';
        case 'Reembolsado':
            return 'bg-red-100 text-red-800';
        case 'Suspendida':
        case 'Abonado':
            return 'bg-yellow-100 text-yellow-800';
        default:
            return 'bg-slate-100 text-slate-800';
    }
}

/**
 * Renderiza la lista de facturas en la tabla.
 */
function renderFacturas(facturas) {
    if (facturas.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-500">No se encontraron facturas.</td></tr>`;
        return;
    }

    tableBody.innerHTML = facturas.map(f => `
        <tr class="hover:bg-slate-50">
            <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-slate-700">${f.id.substring(0, 8).toUpperCase()}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${new Date(f.created_at).toLocaleString('es-PA')}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${f.cliente_nombre || ''} (Box: ${f.cliente_box || ''})</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-emerald-700">${formatCurrency(f.monto_total || 0)}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadge(f.status)}">
                    ${f.status || 'N/A'}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                ${f.status === 'Pagado' ? 
                `<button class="btn-reembolsar text-red-600 hover:text-red-900" data-id="${f.id}">Reembolsar</button>` : 
                '-'}
            </td>
        </tr>
    `).join('');
}

/**
 * Carga todas las facturas desde la base de datos.
 */
async function cargarFacturas() {
    tableBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-slate-500">Cargando facturas...</td></tr>`;
    const { data, error } = await supabase
        .from('facturas')
        .select('*')
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error al cargar facturas:', error);
        tableBody.innerHTML = `<tr><td colspan="6" class="p-8 text-center text-red-500">Error al cargar los datos.</td></tr>`;
        return;
    }
    
    todasLasFacturas = data;
    renderFacturas(todasLasFacturas);
}

/**
 * Abre el modal de confirmación para una factura específica.
 */
function abrirModalReembolso(factura) {
    facturaParaReembolsar = factura;
    modalSummary.innerHTML = `
        <p>Está a punto de reembolsar la factura <strong>${factura.id.substring(0, 8).toUpperCase()}</strong></p>
        <p>Cliente: <strong>${factura.cliente_nombre} (Box: ${factura.cliente_box})</strong></p>
        <p>Monto Total: <strong class="text-red-600">${formatCurrency(factura.monto_total)}</strong></p>
        <p class="mt-2 text-sm text-slate-600">Esta acción revertirá los paquetes a 'en bodega' y devolverá los saldos utilizados. <strong>Esta acción no se puede deshacer.</strong></p>
    `;
    modalMessage.textContent = '';
    confirmReembolsoBtn.disabled = false;
    modal.classList.remove('modal-hidden');
}

/**
 * Cierra el modal de confirmación.
 */
function cerrarModalReembolso() {
    facturaParaReembolsar = null;
    modal.classList.add('modal-hidden');
}

// --- Lógica Principal y Event Listeners ---

document.addEventListener('DOMContentLoaded', () => {
    cargarFacturas();

    // Listener para la búsqueda
    searchInput.addEventListener('input', () => {
        const searchTerm = searchInput.value.toLowerCase();
        if (!searchTerm) {
            renderFacturas(todasLasFacturas);
            return;
        }
        const facturasFiltradas = todasLasFacturas.filter(f => 
            f.id.toLowerCase().includes(searchTerm) ||
            f.cliente_nombre?.toLowerCase().includes(searchTerm) ||
            f.cliente_box?.toString().includes(searchTerm)
        );
        renderFacturas(facturasFiltradas);
    });

    // Listener para los botones de Reembolsar (usando delegación de eventos)
    tableBody.addEventListener('click', (e) => {
        if (e.target.classList.contains('btn-reembolsar')) {
            const facturaId = e.target.dataset.id;
            const factura = todasLasFacturas.find(f => f.id === facturaId);
            if (factura) {
                abrirModalReembolso(factura);
            }
        }
    });

    // Listeners para cerrar el modal
    closeModalBtn.addEventListener('click', cerrarModalReembolso);
    cancelReembolsoBtn.addEventListener('click', cerrarModalReembolso);

    // Listener para la confirmación final del reembolso
    confirmReembolsoBtn.addEventListener('click', async () => {
        if (!facturaParaReembolsar) return;

        confirmReembolsoBtn.disabled = true;
        modalMessage.textContent = 'Procesando reembolso...';

        const opcionReembolso = document.querySelector('input[name="reembolso-opcion"]:checked').value;
        const devolverASaldo = opcionReembolso === 'saldo';

        try {
            const { data, error } = await supabase.rpc('reembolsar_factura', {
                p_factura_id: facturaParaReembolsar.id,
                p_devolver_a_saldo_favor: devolverASaldo
            });

            if (error) {
                throw error;
            }

            modalMessage.textContent = `✅ ${data}`;
            await cargarFacturas(); // Recargar la lista para ver el cambio de estado
            setTimeout(cerrarModalReembolso, 2000);

        } catch (error) {
            console.error('Error al procesar el reembolso:', error);
            modalMessage.textContent = `❌ Error: ${error.message}`;
            confirmReembolsoBtn.disabled = false;
        }
    });
});

        // El código de la Fase 2 irá aquí
    </script>

</body>
</html>
