<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGL1 - Gestión de Facturas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="config.js"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Añadimos un cursor de puntero a las filas de la tabla para indicar que son clicables */
        .fila-clicable { cursor: pointer; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div class="relative min-h-screen md-flex">
        <div id="menu-container"></div>

        <main class="flex-1 p-8">
            <h1 class="text-3xl font-bold text-slate-900 mb-6">Gestión de Facturas</h1>
            
            <div class="bg-white p-6 rounded-lg border shadow-sm">
                <div class="flex gap-4 mb-4">
                    <input type="text" id="search-input" class="w-full max-w-lg p-2 border border-slate-300 rounded-md" placeholder="Buscar por N° de Factura, Nombre o Casillero...">
                    
                    <select id="status-filter" class="p-2 border border-slate-300 rounded-md bg-white">
                        <option value="Todos">Todos los Estados</option>
                        <option value="Pagado">Pagado</option>
                        <option value="Reembolsado">Reembolsado</option>
                        <option value="Suspendida">Suspendida</option>
                        <option value="Abonado">Abonado</option>
                    </select>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">N° Factura</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Fecha</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Cliente</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Total</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-slate-500 uppercase tracking-wider">Estado</th>
                            </tr>
                        </thead>
                        <tbody id="facturas-table-body" class="bg-white divide-y divide-slate-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
        const supabase = createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);

        let todasLasFacturas = [];

        // --- DOM Elements ---
        const searchInput = document.getElementById('search-input');
        const statusFilter = document.getElementById('status-filter'); // Nuevo
        const tableBody = document.getElementById('facturas-table-body');

        // --- Funciones ---

        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }

        function getStatusBadge(status) {
            switch (status) {
                case 'Pagado': return 'bg-green-100 text-green-800';
                case 'Reembolsado': return 'bg-red-100 text-red-800';
                case 'Suspendida': case 'Abonado': return 'bg-yellow-100 text-yellow-800';
                default: return 'bg-slate-100 text-slate-800';
            }
        }

        /**
         * Renderiza la lista de facturas en la tabla.
         * MODIFICADO: Las filas ahora son clicables y no hay botón de acciones.
         */
        function renderFacturas(facturas) {
            if (facturas.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-slate-500">No se encontraron facturas con los filtros aplicados.</td></tr>`;
                return;
            }

            tableBody.innerHTML = facturas.map(f => `
                <tr 
                    class="hover:bg-blue-50 fila-clicable" 
                    onclick="window.location.href='factura-detalle.html?id=${f.id}'"
                    title="Ver detalles de la factura"
                >
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-slate-700">${f.id.substring(0, 8).toUpperCase()}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-500">${new Date(f.created_at).toLocaleString('es-PA')}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-slate-900">${f.cliente_nombre || ''} (Box: ${f.cliente_box || ''})</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-emerald-700">${formatCurrency(f.monto_total || 0)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getStatusBadge(f.status)}">
                            ${f.status || 'N/A'}
                        </span>
                    </td>
                </tr>
            `).join('');
        }
        
        /**
         * NUEVO: Aplica los filtros de búsqueda y estado.
         */
        function aplicarFiltros() {
            const searchTerm = searchInput.value.toLowerCase();
            const statusValue = statusFilter.value;

            let facturasFiltradas = todasLasFacturas;

            // Filtrar por estado
            if (statusValue !== 'Todos') {
                facturasFiltradas = facturasFiltradas.filter(f => f.status === statusValue);
            }

            // Filtrar por término de búsqueda
            if (searchTerm) {
                facturasFiltradas = facturasFiltradas.filter(f => 
                    f.id.toLowerCase().includes(searchTerm) ||
                    f.cliente_nombre?.toLowerCase().includes(searchTerm) ||
                    f.cliente_box?.toString().includes(searchTerm)
                );
            }

            renderFacturas(facturasFiltradas);
        }

        async function cargarFacturas() {
            tableBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-slate-500">Cargando facturas...</td></tr>`;
            const { data, error } = await supabase
                .from('facturas')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error al cargar facturas:', error);
                tableBody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-red-500">Error al cargar los datos.</td></tr>`;
                return;
            }
            
            todasLasFacturas = data;
            aplicarFiltros(); // Usar la nueva función para renderizar
        }

        // --- Lógica Principal y Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            cargarFacturas();

            // Listeners para los filtros
            searchInput.addEventListener('input', aplicarFiltros);
            statusFilter.addEventListener('change', aplicarFiltros);
        });
    </script>
</body>
</html>
