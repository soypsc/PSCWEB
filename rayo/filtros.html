<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SGL1 - Gestión de Filtros</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="config.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar-link.active { background-color: #ecfdf5; color: #059669; font-weight: 600; }
        .code { font-size: 13px; font-weight: 600; color: #94a3b8; margin-right: 12px; background-color: #f1f5f9; padding: 2px 8px; border-radius: 6px; }
        #sidebar { transition: transform 0.3s ease-in-out; }
        .modal-backdrop { transition: opacity 0.3s ease-in-out; }
        .modal-content { transition: all 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
<script type="module">
        // --- INICIO DEL CÓDIGO DE SEGURIDAD ---
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
        const supabase = createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);

        (async () => {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            const { data: perfil, error } = await supabase
                .from('perfiles')
                .select('rol')
                .eq('id', session.user.id)
                .single();
            if (error || !perfil || perfil.rol !== 'admin') {
                await supabase.auth.signOut();
                window.location.href = 'login.html?error=unauthorized';
            }
        })();
        // --- FIN DEL CÓDIGO DE SEGURIDAD ---
    </script>

    <div class="relative min-h-screen md:flex">
        <div id="menu-container"></div>

        <main class="flex-1 p-8">
            <h1 class="text-3xl font-bold text-slate-900 flex items-center mb-6"><span class="code">[OP-06]</span>Gestión de Filtros</h1>
            
            <div class="bg-white p-4 rounded-lg border border-slate-200 mb-6">
                <div class="relative">
                    <label for="search-input" class="sr-only">Buscar Tracking</label>
                    <input id="search-input" type="search" placeholder="Buscar por Tracking..." class="w-full p-2 pl-10 border border-slate-300 rounded-md">
                </div>
            </div>

            <div class="bg-white rounded-lg border overflow-x-auto">
                <table class="w-full text-sm whitespace-nowrap">
                    <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                        <tr>
                            <th class="px-6 py-3 text-left">Tracking</th>
                            <th class="px-6 py-3 text-left">Peso (lbs)</th>
                            <th class="px-6 py-3 text-left">Foto</th>
                            <th class="px-6 py-3 text-left">Fecha de Registro</th>
                            <th class="px-6 py-3 text-left">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="filtros-table-body">
                        <tr>
                            <td colspan="5" class="text-center p-4 text-slate-500">Cargando paquetes...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>
    
    <div id="foto-modal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm flex items-center justify-center p-4 hidden z-40 modal-backdrop">
        <div class="bg-white w-full max-w-xl rounded-lg shadow-xl p-4 modal-content">
            <div class="flex justify-end mb-2">
                 <button id="close-modal-btn" class="text-slate-400 hover:text-slate-600 text-3xl font-bold">&times;</button>
            </div>
            <img id="modal-image" src="" alt="Foto del paquete" class="w-full h-auto object-contain max-h-[80vh]">
        </div>
    </div>

    <script type="module" src="app.js"></script>
    <script type="module">
        import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

        document.addEventListener('DOMContentLoaded', () => {
            initializeFiltrosLogic();
        });

        function initializeFiltrosLogic() {
            try {
                const sb = createClient(window.PSC_CONFIG.supabaseUrl, window.PSC_CONFIG.supabaseAnonKey);

                const tableBody = document.getElementById('filtros-table-body');
                const searchInput = document.getElementById('search-input');
                const fotoModal = document.getElementById('foto-modal');
                const modalImage = document.getElementById('modal-image');
                const closeModalBtn = document.getElementById('close-modal-btn');
                
                const fmtDate = (iso) => (iso ? new Date(iso).toLocaleDateString("es-PA", { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' }) : "N/A");

                function renderFiltros(paquetes) {
                    if (!paquetes || paquetes.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-slate-500">No hay paquetes pendientes en filtro.</td></tr>`;
                        return;
                    }

                    tableBody.innerHTML = paquetes.map(p => `
                        <tr class="bg-white border-b hover:bg-slate-50">
                            <td class="px-6 py-4 font-medium text-slate-900">${p.tracking}</td>
                            <td class="px-6 py-4">${p.peso ? p.peso.toFixed(2) : 'N/A'}</td>
                            <td class="px-6 py-4">
                                ${p.foto_url ? `<a href="#" data-foto-url="${p.foto_url}" class="text-blue-600 hover:underline view-photo-link">Ver Foto</a>` : 'No disponible'}
                            </td>
                            <td class="px-6 py-4">${fmtDate(p.created_at)}</td>
                            <td class="px-6 py-4">
                                <button data-id="${p.id}" class="bg-green-500 text-white font-semibold py-1 px-3 rounded-md hover:bg-green-600 text-xs corregir-btn">
                                    Marcar como Corregido
                                </button>
                            </td>
                        </tr>
                    `).join('');
                }

                async function cargarFiltros() {
                    const searchTerm = searchInput.value.trim();
                    
                    let query = sb.from('paquetes_con_filtro')
                                  .select('*')
                                  .eq('corregido', false)
                                  .order('created_at', { ascending: false });

                    if (searchTerm) {
                        query = query.ilike('tracking', `%${searchTerm}%`);
                    }

                    const { data, error } = await query;

                    if (error) {
                        console.error("Error cargando filtros:", error);
                        tableBody.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-red-500">Error al cargar los paquetes.</td></tr>`;
                        return;
                    }
                    renderFiltros(data);
                }

                async function marcarComoCorregido(id) {
                    if (!id) return;
                    
                    if (!confirm("¿Está seguro de que desea marcar este paquete como corregido? Esta acción lo quitará de la lista.")) {
                        return;
                    }

                    const { error } = await sb.from('paquetes_con_filtro')
                                              .update({ corregido: true })
                                              .eq('id', id);

                    if (error) {
                        console.error("Error al actualizar:", error);
                        alert("No se pudo actualizar el estado del paquete.");
                        return;
                    }
                    
                    await cargarFiltros(); // Recargar la lista para que el paquete desaparezca
                }

                // --- Event Listeners ---

                searchInput.addEventListener('input', () => {
                    cargarFiltros();
                });

                tableBody.addEventListener('click', (e) => {
                    const corregirBtn = e.target.closest('.corregir-btn');
                    const viewPhotoLink = e.target.closest('.view-photo-link');

                    if (corregirBtn) {
                        marcarComoCorregido(corregirBtn.dataset.id);
                    }
                    
                    if (viewPhotoLink) {
                        e.preventDefault();
                        modalImage.src = viewPhotoLink.dataset.fotoUrl;
                        fotoModal.classList.remove('hidden');
                    }
                });
                
                closeModalBtn.addEventListener('click', () => {
                    fotoModal.classList.add('hidden');
                    modalImage.src = ""; // Limpiar la imagen
                });

                // Carga inicial
                cargarFiltros();

            } catch (error) {
                console.error("Error al inicializar:", error);
                document.querySelector("main").innerHTML = `<p class="text-red-500">Error crítico. Revise la consola.</p>`;
            }
        }
    </script>
</body>
</html>
